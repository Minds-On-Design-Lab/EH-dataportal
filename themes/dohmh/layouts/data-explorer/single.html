{{ define "main" }}

<article class="container-fluid" id="skip-header-target">
    <div class="row">
        <div class="col-md-11 mx-auto mt-4 mx-1">
            <nav aria-label="breadcrumb" class="mb-2">
                <ul class="breadcrumb mr-auto">
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}/data-explorer/">Data Explorer</a></li>
                    <li class="breadcrumb-item active"><a href="{{ .Page.RelPermalink }}">{{ .Title }}</a></li>
                    <li class="nav-item ml-auto">
                        <form class="autocomplete-form form-inline">
                            <label for="all-data" class="block col-sm-12 font-weight-bold h4 mb-3 sr-only">Search data</label>
                                <div class="autocomplete-wrapper" width="100%">
                                <select name="all-data" id="all-data">
                                    <option value=""><i class="fas fa-search mr-2"></i>Search data</option>
                                </select>
                                </div>
                                <button type="submit" class="btn-primary btn" style="height:40px;"><i class="fas fa-search"></i></button> 
                        </form>
                    </li>
                </ul>                
            </nav>

            <div class="row mb-2">
                <div class="col border-bottom mx-2 ml-0 pl-0 pb-2 mb-2">
                    <h2>{{ .Title }}</h2>
                </div>
            </div>

            <style>
                /*This CSS controls read more/show less toggle.*/
                [aria-expanded="false"] > .expanded,
                [aria-expanded="true"] > .collapsed {
                  display: none;
                }

                #truncate {
                    display: block;
                }

                #full {
                    display: none;
                }

                #expand-collapse {
                    cursor: pointer;
                }

                .show {
                display: block!important;
                }

                .hide {
                display: none!important;
                }

                /* .tab-content > .tab-pane {
                    display: block !important;
                    opacity: 1 !important;
                } */

                .dropdown-title {
                    padding: 0.25rem 1.5rem;
                }

                .indicator-measures h6 {
                    margin-top: 0.5em;
                }

                .dropdown-menu {
                    z-index: 2000;
                }



                div[aria-labelledby="dropdownMapMeasures"].show {
                    display: flex !important;
                }

            </style>

            <!-- Arquero -->
            <script src="https://cdn.jsdelivr.net/npm/apache-arrow@latest"></script>
            <script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>

            <!-- DataTables -->
            <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

            <!-- Vega-Lite -->
            <script src="https://cdn.jsdelivr.net/npm/vega@5.21.0"></script>
            <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
            <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.2"></script>
            
            <!--D3-->
            <script src="https://d3js.org/d3.v5.min.js"></script>

            <!-- Data Explorer -->
            <script src="/js/data-explorer/summary.js"></script>
            <script src="/js/data-explorer/map.js"></script>
            <script src="/js/data-explorer/trend.js"></script>
            <script src="/js/data-explorer/links.js"></script>

            <script>
                    let data_branch = {{ site.Params.data_branch }};
                    let data_repo = {{ site.Params.data_repo }};
                    let indicators = []; // indicator data
                    let defaultIndicatorId;
                    let selectedSummaryYears = [];
                    let selectedSummaryGeography = [];
                    let aboutMeasures;
                    let dataSources;

                    let measureAbout = `N/A`;
                    let measureSources = `N/A`;
                    let geoTable;
                    let aqData;
                    let joinedAqData;

                    let hasCIData = false;
                    let hasNumberData = false;
                    let hasPercentData = false;

                    let fullDataMapObjects;
                    let fullDataTrendObjects;
                    let fullDataLinksObjects;
                    let joinedDataLinksObjects;
                    let joinedDataTrendDisparityObjects;

                    let indicator;
                    let indicatorName;
                    let indicatorDesc;
                    let indicatorShortName;
                    let indicatorMeasurses;
                    let indicatorId;

                    let defaultTrendMeasure = [];
                    let defaultTrendAbout;
                    let defaultTrendSources;
                    let defaultMapMeasure = [];
                    let defaultMapAbout;
                    let defaultMapSources;
                    let defaultLinksMeasure = [];
                    let defaultLinkMeasureTimes = [];
                    let defaultLinksAbout;
                    let defaultLinksSources;

                    let selectedMapMeasure = false
                    let selectedTrendMeasure = false;
                    let selectedLinksMeasure = false;
                    let selectedMapAbout;
                    let selectedMapSources;
                    let selectedTrendAbout;
                    let selectedTrendSources;
                    let selectedLinksAbout;
                    let selectedLinksSources;
                    let selectedLinkMeasureData = [];
                    let selectedlinksSecondaryIndicatorData = [];
                    let selectedlinksSecondaryMeasureData = [];
                    let selectedlinksSecondaryMeasureTime;
                    
                    let mapMeasures = [];
                    let trendMeasures = [];
                    let linksMeasures = [];

                    let tabMap;
                    let tabTrend;
                    let tabLinks;

                    let currentHash;

                    const url = new URL(window.location);
                
                    const updateChartPlotSize = () => {
                        setTimeout(() => {
                            window.dispatchEvent(new Event('resize'));
                        }, 200)

                    }

                    window.onpopstate = function (event) {
                        if (event.state != null){
                            // console.log('EVENT: ', event.state.id)
                            document.url = event.state.url;                            
                            loadIndicator(event.state.id, true)
                        }
                    };

                    window.addEventListener("hashchange", function () {
                        const hash =  window.location.hash.replace('#', "");
                        currentHash = hash;

                        switch(hash) {
                            case 'display=summary':
                                $('#tab-btn-table').tab('show');
                            break;
                            case 'display=map':
                                $('#tab-btn-map').tab('show');
                            break;
                            case 'display=trend':
                                $('#tab-btn-trend').tab('show');
                            break;
                            case 'display=links':
                                $('#tab-btn-links').tab('show');
                            break;
                            default: 
                            $('#tab-btn-table').tab('show');
                            break;
                        }
                    });

                    document.addEventListener("DOMContentLoaded", () => {
                        tabTable = document.querySelector('#tab-btn-table');
                        tabMap = document.querySelector('#tab-btn-map');
                        tabTrend = document.querySelector('#tab-btn-trend');
                        tabLinks = document.querySelector('#tab-btn-links');
                        aboutMeasures = document.querySelector('.indicator-measures');
                        dataSources = document.querySelector('.indicator-sources');
                    });


                    function reveal() {
                        document.getElementById('truncate').classList.toggle('hide');
                        document.getElementById('full').classList.toggle('show');
                        document.getElementById('contenttoggle').innerHTML = `Show less... <i class="fas fa-caret-square-up" aria-hidden="true"></i>`;
                    }
                    

                    fetch(data_repo + "/" + data_branch + '/indicators/indicators.json')
                        .then(response => response.json())
                        .then(data => {
                            indicators = data;
                            const paramId =  url.searchParams.get('id') !== null ? parseInt(url.searchParams.get('id')) : false;
                            const paramDisplay =  url.searchParams.get('display') !== null ? url.searchParams.get('display') : false

                            const renderIndicatorDropdown = () => {
                                const indicatorDropdown = document.getElementById("indicator-dropdown");
                                let indicatorId;
                                let header;
                                
                                {{ range .Params.Indicators }}
                                        header = `{{ .header }}`;
                                        // console.log('Header: ', header)
                                        indicatorDropdown.innerHTML += header.length ? `<div class="dropdown-title"><strong>${header}</strong></div>`: '';
                                        {{ range $index, $id := .IndicatorID }}
                                            {{ if (eq $index 0) }}
                                                defaultIndicatorId = {{ $id }}
                                            {{ end }}
                                            indicatorId = {{ $id }}
                                            indicator = indicators.find(indicator => indicator.IndicatorID === indicatorId);
                                            indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : 'N/A';
                                            indicatorDropdown.innerHTML += `<button class="dropdown-item" onclick="loadIndicator(${indicatorId})" data-internal-id="${indicatorId}">${indicatorName}</button>`
                                        {{ end }}
                                {{ end }}
                            }


                            renderIndicatorDropdown()
                            if (paramId) {
                                loadIndicator(paramId)
                            } else {
                                loadIndicator()
                            }

                            const hash =  window.location.hash.replace('#', "")
                            // console.log('hash:', window.location.hash, hash)
                            
                            switch(hash) {
                                case 'display=summary':
                                    $('#tab-btn-table').tab('show');
                                    break;
                                case 'display=map':
                                    $('#tab-btn-map').tab('show');
                                    break;
                                case 'display=trend':
                                    $('#tab-btn-trend').tab('show');
                                    break;
                                case 'display=links':
                                    $('#tab-btn-links').tab('show');
                                 break;
                                default: 
                                    $('#tab-btn-table').tab('show');
                            }
                        })
                        .catch(error => console.log(error));




                    // join the data
                    const joinData = () => {
                        if (hasCIData && hasNumberData) {
                            joinedAqData = aqData
                                .join_left(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                .relocate(['Name'], { after: 'GeoID' })
                                .relocate(['GeoType'], { before: 'GeoID' })
                                .rename({
                                    'Name': 'Geography',
                                })
                                .relocate(aq.startswith("Number"), { after: "Geography" })
                                {{/*  .relocate(["Percent (95% CL)"], { after: "Number" })  */}}
                        } else if (hasCIData && !hasNumberData && hasPercentData) {
                            joinedAqData = aqData
                                .join_left(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                .relocate(['Name'], { after: 'GeoID' })
                                .relocate(['GeoType'], { before: 'GeoID' })
                                .rename({
                                    'Name': 'Geography',
                                })
                                {{/*  .relocate(["Percent (95% CL)"], { after: "Geography" })  */}}
                        } else {
                            joinedAqData = aqData
                                .join_left(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                .relocate(['Name'], { after: 'GeoID' })
                                .relocate(['GeoType'], { before: 'GeoID' })
                                .rename({
                                    'Name': 'Geography',
                                })
                        }

                        console.log("============ joinedAqData ============", joinedAqData);

                        const filterUHF42 = joinedAqData.filter(d => d.GeoType == 'UHF42').objects();
                        const filterUHF34 = joinedAqData.filter(d => d.GeoType == 'UHF34').objects();
                        const filterCD = joinedAqData.filter(d => d.GeoType == 'CD').objects();
                        const filterNTA = joinedAqData.filter(d => d.GeoType == 'NTA').objects();
                        const filterPuma = joinedAqData.filter(d => d.GeoType == 'Puma').objects();
                        const filterSubboro = joinedAqData.filter(d => d.GeoType == 'Subboro').objects();
                        const filterBorough = joinedAqData.filter(d => d.GeoType  == 'Borough').objects();
                        const filterCitywide = joinedAqData.filter(d => d.GeoType  == 'Citywide').objects();
                        const filterNYCKids = joinedAqData.filter(d => d.GeoType  == 'NYCKIDS').objects();

                        console.log('$$$$ KIDS ', filterNYCKids)
                        // console.log('hhhhhhh ',aqData, joinedAqData )
                        // console.log('===>', filterUHF42, filterUHF34, filterCD, filterPuma, filterSubboro, filterBorough, filterCitywide)
                        // geoTable.print()
                                
                        // joinedAqData.print()


                        fullDataMapObjects = [...filterUHF42, ...filterUHF34, ...filterCD, ...filterPuma, ...filterSubboro, ...filterNTA, ...filterNYCKids ];
                        // console.log('fullDataMapObjects', fullDataMapObjects)
                        fullDataTrendObjects = [...filterBorough, ...filterCitywide];
                        fullDataLinksObjects = joinedAqData.objects();

                        console.log("==== joinedAqData ====");
                        joinedAqData.print({limit: 100})
                        console.log(joinedAqData);

                        renderMeasures();
                    }

                    const loadGeo = () => {
                        const geoUrl = `https://raw.githubusercontent.com/nychealth/EHDP-data/{{ site.Params.data_branch }}/geography/GeoLookup_2.csv`; // col named "GeoType"
                        {{/*  const geoUrl = `https://raw.githubusercontent.com/nychealth/EHDP-data/{{ site.Params.data_branch }}/geography/GeoLookup.csv`; // col named "Geotype"  */}}

                        aq.loadCSV(geoUrl)
                            .then(data => {

                                const standardizeGeoId = (id, type) => {
                                    // if (type === 'NTA') {
                                    //     return `${id}`;
                                    // }
                                    return parseInt(id)
                                }
                                geoTable = data
                                    .derive({ GeoID: aq.escape(d => standardizeGeoId(d.GeoID, d.GeoType))}) // convert GeoIDs to numbers and strings
                                    .select(aq.not('Lat', 'Long'))
                                console.log("---- Geo Names 1 (post-load) ----")
                                geoTable.print({ limit: 10});
                                joinData(); // run the next function 
                            });
                    }

                    const loadData = (indicatorId) => {
                        // Loads data as an arquero table
                        fetch(data_repo + "/" + data_branch + `/indicators/data/${indicatorId}.json`)
                            .then(response => response.json())
                            .then(data => {

                                loadGeo(); // run the next function

                                const ciAqData = data.filter(d => d.CI.length > 0 )
                                
                                const numAqData = data.filter(d => d.MeasurementType === "Number")
                                const pctAqData = data.filter(d => d.MeasurementType === "Percent")
                                // Pesticide Measurement Types
                                const sprayBombPct = data.filter(d => d.MeasurementType === "Spray/Bomb Only - %")
                                const saferMethodsNumber = data.filter(d => d.MeasurementType === "Only Safer Methods (Bait,Gel, Boric Acid) - Number")
                                const saferMethodsPct = data.filter(d => d.MeasurementType === "Only Safer Methods (Bait,Gel, Boric Acid) - %")
                                const anyUseNumber = data.filter(d => d.MeasurementType === "Any Use - Number")
                                const anyUsePct = data.filter(d => d.MeasurementType === "Any Use - %")
                                const anyUseTempoPct = data.filter(d => d.MeasurementType === "Any use of Tempo or Chinese Chalk - %")

                                hasCIData = ciAqData.length > 0;
                                hasNumberData = numAqData.length > 0;
                                hasPercentData = pctAqData.length > 0;
                                // console.log('data: ', data)
                                // console.log('CI: ', ciAqData)
                                // console.log('Number: ', pctAqData)
                                // console.log('Percent: ', pctAqData)
                                // console.log('Stripped: ', data)


                                const assignGeoRank = (GeoType) => {
                                    switch (GeoType) {
                                        case 'Citywide':
                                            return 0;
                                        case 'Borough':
                                            return 1;
                                        case 'NYCKIDS':
                                            return 2;
                                        case 'UHF34':
                                            return 3;
                                        case 'UHF42':
                                            return 4;
                                        case 'Subboro':
                                            return 5;
                                        case 'CD':
                                            return 6;
                                        case 'NTA':
                                            return 7;
                                    }
                                }

                                let pct;
                                let num;
                                let ful;
                                let str;
                                let aUNum;
                                let aUTPct;
                                let aUPct;
                                let sMPct;
                                let sBPct;

                                ful = aq.from(data)
                                        .groupby("Time", "GeoType", "GeoID", { "GeoRank": aq.escape( d => assignGeoRank(d.GeoType))})
                                        // .impute({ Value: () => "**" })
                                        .pivot("MeasurementType", "Value")

                                        {{/*  ful.print({limit: 100})  */}}

                                console.log('==== ful ====')
                                ful.print({limit: 100})
                                console.log(ful)

                                if (hasCIData) {
                                    // console.log('---- new table ----------')
                                    const dataMeasurementTypes = [...new Set(data.map(item => item.MeasurementType))]
                                    // console.log(dataMeasurementTypes, data)
                                    if (pctAqData.length > 0) {
                                    pct = aq.from(pctAqData)
                                                .groupby("Time", "GeoType", "GeoID", "CI")
                                                //  .groupby("Time", "GeoType", "GeoID", "CI", { "Percent (95% CL)": d => d.Value !== null ? d.DisplayValue + " " + d.CI: "**" })
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")
                                                .rename({ CI: "CI (95%)"})

                                    // pct.print();
                                }
                                
                                if (numAqData.length > 0) {
                                    num = aq.from(numAqData)
                                                .groupby("Time", "GeoType", "GeoID")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                    // num.print();
                                }


                                if (sprayBombPct.length > 0) {
                                    sBPct = aq.from(sprayBombPct)
                                                .groupby("Time", "GeoType", "GeoID")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                                // console.log('sprayBombPct-------------------------------------------------')
                                                // sBPct.print()
                                } 
                                if (saferMethodsPct.length > 0) {
                                    sMPct = aq.from(saferMethodsPct)
                                                .groupby("Time", "GeoType", "GeoID")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                                // console.log('saferMethodsPct-------------------------------------------------')
                                                // sMPct.print()
                                }
                               
                                if (anyUseNumber.length > 0) {
                                    aUNum = aq.from(anyUseNumber)
                                                .groupby("Time", "GeoType", "GeoID")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                                 // console.log('anyUseNumber-------------------------------------------------')
                                                 // aUNum.print()
                                }

                                if (anyUsePct.length > 0) {
                                    aUPct = aq.from(anyUsePct)
                                                .groupby("Time", "GeoType", "GeoID")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                                // console.log('anyUsePct-------------------------------------------------')
                                                // aUPct.print()
                                }
                                
                                if (anyUseTempoPct.length > 0) {
                                    aUTPct = aq.from(anyUseTempoPct)
                                                .groupby("Time", "GeoType", "GeoID", "CI")
                                                .impute({ Value: () => "**" })
                                                .pivot("MeasurementType", "Value")

                                                // console.log('anyUseTempoPct-------------------------------------------------')
                                                // aUTPct.print()
                                }
                                
                                // if (strippedAqData.length > 0) {
                                //     str = aq.from(strippedAqData)
                                //                 .groupby("Time", "GeoType", "GeoID", { "GeoRank": aq.escape( d => assignGeoRank(d.GeoType))})
                                //                 .impute({ Value: () => "**" })
                                //                 .pivot("MeasurementType", "Value")
                                // } else {
                                     
                                // }
                                
                                                
                                
                            
                                let newTable;
                                if (pctAqData.length > 0 && numAqData.length > 0) {
                                    // if (strippedAqData.length > 0) {
                                    // newTable = str
                                    //             .join(num, [["GeoID", "GeoType", "Time"], ["GeoID", "GeoType", "Time"]])
                                    //             .join(pct, [["GeoID", "GeoType", "Time"], ["GeoID", "GeoType", "Time"]])
                                    //             .orderby(aq.desc('Time'), 'GeoRank')
                                    // } else {
                                        // console.log('test', ful)
                                        
                                        newTable = ful
                                            .join(num, [["GeoID", "GeoType", "Time", "Number"], ["GeoID", "GeoType", "Time", "Number"]])
                                            .join(pct, [["GeoID", "GeoType", "Time", "Percent"], ["GeoID", "GeoType", "Time", "Percent"]])
                                            .orderby(aq.desc('Time'), 'GeoRank')


                                        
                                        // }
                                        // } else if (pctAqData.length > 0 && numAqData.length === 0) {
                                //     newTable =  aq.from(strippedAqData)
                                //                 .join(num, [["GeoID", "GeoType", "Time"], ["GeoID", "GeoType", "Time"]])
                                //                 .join(pct, [["GeoID", "GeoType", "Time"], ["GeoID", "GeoType", "Time"]])
                                //                 .orderby(aq.desc('Time'), aq.desc('GeoRank'),  'Geography')
                                } else if (pctAqData.length === 0 && numAqData.length === 0 && sprayBombPct.length > 0 && saferMethodsPct.length > 0 && anyUseNumber.length > 0 && anyUsePct.length > 0 && anyUseTempoPct.length > 0) {
                                    // console.log('NO NUMBER OR PERCENT')
                                    newTable = ful
                                            .groupby("Time", "GeoType", "GeoID")
                                            // .join(aUNum)
                                            // .join(aUTPct)
                                        .join_left(sBPct, [["GeoID", "GeoType", "Time", "Spray/Bomb Only - %"], ["GeoID", "GeoType", "Time", "Spray/Bomb Only - %"]])
                                        .join_left(sMPct, [["GeoID", "GeoType", "Time", "Only Safer Methods (Bait,Gel, Boric Acid) - %"], ["GeoID", "GeoType", "Time", "Only Safer Methods (Bait,Gel, Boric Acid) - %"]])
                                        .join_left(aUNum, [["GeoID", "GeoType", "Time", "Any Use - Number"], ["GeoID", "GeoType", "Time", "Any Use - Number"]])
                                        .join_left(aUPct, [["GeoID", "GeoType", "Time", "Any Use - %"], ["GeoID", "GeoType", "Time", "Any Use - %"]])
                                        .join_left(aUTPct, [["GeoID", "GeoType", "Time", "Any use of Tempo or Chinese Chalk - %"], ["GeoID", "GeoType", "Time", "Any use of Tempo or Chinese Chalk - %"]])
                                        // .join(aUTPct, [["GeoID", "GeoType", "Time", "Any use of Tempo or Chinese Chalk - %"], ["GeoID", "GeoType", "Time", "Any use of Tempo or Chinese Chalk - %"]])
                                        .orderby(aq.desc('Time'), aq.desc('GeoRank'), 'Geography')
                                        // console.log('newTable', newTable)
                                } else {
                                    newTable = ful
                                        .groupby("Time", "GeoType", "GeoID")
                                
                                }

                                console.log('==== newTable ====')
                                newTable.print({limit: 100})
                                console.log(newTable)
                                

                                // console.log('newTable====================================')
                                // newTable.print();
                                aqData = newTable
                                    // aqData = aq.from(data)
                                    //     // .except([pct, num])
                                    //     .semijoin(pct, [["GeoType"], ["GeoType"]])
                                    //     .semijoin(pct, [["GeoType"], ["GeoType"]])
                                        // .groupby("Time", "GeoType", "GeoID", "CI")
                                        // .groupby({ abc: d => d.MeasurementType + d.Time})
                                        
                                        // .pivot("MeasurementType", "DisplayValue")

                                        // .relocate(["Time"], { before: "MeasureID" })
                                        // .relocate(["GeoType"], { after: "Time" })
                                        // .relocate(["CI"], { after: "Percent" })

                                        // .select(aq.not('GeoType', 'Long'))
                                        // .rename({ CI: "95% CL" })
                                        // .pivot(
                                        // { key: d => op.lower(d.key) },
                                        // { value: d => op.sum(d.value) }
                                        // )
                                } else {
                                    // console.log('hi', ful)
                                    aqData = ful
                                        .groupby("Time", "GeoType", "GeoID")
                                        // .impute({ Value: () => "**" })
                                        // .pivot("MeasurementType", "Value")
                                        .orderby(aq.desc('Time'), 'GeoRank')
                                }
                                
                                // console.log('==========================================================================')
                                // console.log('Load Date - aqData', aqData)
                                // aqData.print();
                            })
                        }

                    const loadDisparitiyData = (disparityIndicator, primaryMeasure) => {
                        const disparityIndicatorId = disparityIndicator[0].IndicatorID;
                        const disparityMeasure = disparityIndicator[0];
                        const primaryMeasureTimes = primaryMeasure[0].AvailableTimes;
                        const primaryMeasurementType =  primaryMeasure[0].MeasurementType;
                        // console.log('+++++++++++++++ loadDisparitiyData +++++++++++++++++++++++++')
                        // console.log('primaryMeasureTimes: ',primaryMeasure, primaryMeasureTimes)

                        const aqPrimaryMeasureTimes = aq.from(primaryMeasureTimes)

                        const filteredSecondaryIndicator =  indicators.filter(indicator =>
                            indicator.Measures.some(measure => 
                                measure.MeasureID === 221)
                        )

                        const filteredSecondaryMeasure = filteredSecondaryIndicator[0].Measures.filter(m =>
                            m.MeasureID === 221
                        )

                        const secondaryMeasureTimes = filteredSecondaryMeasure[0].AvailableTimes;
                        const secondaryMeasureGeoTypes = filteredSecondaryMeasure[0].AvailableGeographyTypes;

                        const aqSecondaryMeasureTimes = aq.from(secondaryMeasureTimes)

                        console.log('==== aqSecondaryMeasureTimes ====')
                        aqSecondaryMeasureTimes.print({limit: 100})
                        console.log(aqSecondaryMeasureTimes);

                        fetch(data_repo + "/" + data_branch + `/indicators/data/${disparityIndicatorId}.json`)
                            .then(response => response.json())
                            .then(data => {
                                const povertyData = data.filter(d => d.MeasureID === 221)
                                let primaryTimes = []

                                defaultTrendMeasure[0].AvailableTimes.map(t => primaryTimes.push(`${t.TimeDescription}`) )

                                const filteredDisparityData = aq.from(povertyData)
                                    .join(aqSecondaryMeasureTimes, ["Time", "TimeDescription"])
                                    .derive({
                                        bin: aq.bin('Value', { maxbins: 3 }),
                                    })
                                    .derive({
                                        Tertile: aq.escape( d => d.bin === 0 && 'low' || d.bin === 20 && 'med' || d.bin === 40 && 'hi')
                                    })
                                    .groupby("Tertile")
                                    

                                console.log('DISPARITY - filteredDisparityData ==============================')
                                filteredDisparityData.print({ limit: 10 })

                                const aqJoinedPrimaryMeasureTimes = aq.from(joinedAqData) //joinedAqData //fullDataTrendObjects
                                        .join(aqPrimaryMeasureTimes, ["Time", "TimeDescription"])
                                        
                                        console.log("joinded time ----------- primary")
                                        aqJoinedPrimaryMeasureTimes.print({ limit: 10 })


                                const aqJoinedPrimaryTrendData = aq.from(aqJoinedPrimaryMeasureTimes)
                                        .join(filteredDisparityData, [["end_period", "GeoID"], ["end_period", "GeoID"]])
                                        .select('Time_1', 'Geography', 'GeoType_1', 'Age Adjusted Rate - Total', 'Value', 'Tertile')
                                        .filter(d => d.GeoType_1 !== 'Citywide')

                           
                                        {{/*  .select(aq.not('Time_2', 'GeoID_2', 'GeoType_2', 'start_period_2', 'TimeDescription_2' ))  */}}
                                        // .derive({
                                        //     low1: d => d.Value > (d.min + d.bin) && d.Value,
                                        //     medium: d => d.Value < ((d.min + d.bin) && d.Value < (d.max - d.bin)) && d.Value
                                        // })
                                        // .groupby("max", "min", "Value", "bin", "low1", "medium", "Time", "Name", "bin3")
{{/*                                          
                                        .rollup({
                                            new: d => op.median(d.Median)
                                        })
                                        .groupby('end_period', 'GeoType_1', 'Time_1', 'Median', 'Geography' )  */}}
                                        //.join(filteredDisparityData, [["Time", "GeoType", "GeoID"], ["Time", "GeoType", ]])
                                        //.cross(filteredDisparityData)
                                        //.select('Time_1', `${primaryMeasurementType}`, 'Tertile')
                                        //.cross(filteredDisparityData, [[`Time`, `${primaryMeasurementType}`], [`Tertile`, `Tertile Percent`]])
                                        //.groupby("Time_1", "Tertile")
                                        //.groupby("end_period", "GeoID")
                                        //.rename({ 'Age Adjusted Rate - Total': 'Value' })
                                        //.derive({ index: d => op.row_number() - 1 })
                                        //.derive({Median: op.median('Value')})
                               
                                        
                                    // console.log('DISPARITY - aqJoinedPrimaryTrendData ==============================')
                                    // console.log(aqJoinedPrimaryTrendData)
                                    // aqJoinedPrimaryTrendData.print({ limit: 200 })


                                    // const low = aq.from(aqJoinedPrimaryTrendData)
                                    //     .filter(d => d.Tertile === 0)
                                    //     {{/*  .groupby('Time_1', 'GeoType_1', 'Tertile')
                                    //     .rollup({
                                    //         median: d => op.median(d['Age Adjusted Rate - Total'])
                                    //     })  */}}
// 
                                    // const med = aq.from(aqJoinedPrimaryTrendData)
                                    //     .filter(d => d.Tertile === 18)
                                    //     {{/*  .groupby('Time_1', 'GeoType_1', 'Tertile')
                                    //     .rollup({
                                    //         median: d => op.median(d['Age Adjusted Rate - Total'])
                                    //     })  */}}
// 
                                    //     const hi = aq.from(aqJoinedPrimaryTrendData)
                                    //     .filter(d => d.Tertile === 36)
                                    //     {{/*  .groupby('Time_1', 'GeoType_1', 'Tertile')
                                    //     .rollup({
                                    //         median: d => op.median(d['Age Adjusted Rate - Total'])
                                    //     })  */}}
// 
                                    // console.log('low --------------')
                                    // low.print()
                                    // console.log('med --------------')
                                    // med.print()
                                    // console.log('hi --------------')
                                    // hi.print()



                                    {{/*  const tea = aq.table({ x: [1, 2, 3, 4, 4, 5, 5, 5, 6, 6, 8, 9, 10] })
                                    .groupby({
                                      bin_0: aq.bin('x', {maxbins: 3}),
                                    })
                                    .count()

                                        tea.print()  */}}

                                    // console.log('aqJoinedPrimaryTrendData', aqJoinedPrimaryTrendData.objects())
                                   
                                        
                                    // aqJoinedPrimaryTrendData.print({ limit: 40 })
                                    // joinedDataTrendDisparityObjects = aqJoinedPrimaryTrendData.objects(); 


                                    const newDisparity = aq.from(aqJoinedPrimaryTrendData)
                                        .groupby("Time_1", "Tertile", "GeoType_1")
                                        .rollup({
                                            median: d => op.median(d["Age Adjusted Rate - Total"])
                                        })
                                        .filter(d => d.GeoType_1 === 'Subboro')

                                    joinedDataTrendDisparityObjects = newDisparity.objects()
                                    console.log('New Disparity Data ==========================')
                                    newDisparity.print({ limit: 60 })
                            })
                    }

                    // returned the array of measure in indicators.json
                    const filterSecondaryIndicatorMeasure = (primaryMeasure) => {
                        // console.log('==========================================================================')
                        // console.log("PRIMARY MEASURE DATA: ", primaryMeasure)
                        const primaryMeasureId = primaryMeasure[0].VisOptions[0].Links[0].MeasureID;
                        const primaryMeasureTimes = primaryMeasure[0].AvailableTimes;
                        const filteredSecondaryIndicator =  indicators.filter(indicator =>
                            indicator.Measures.some(measure => 
                                measure.MeasureID === primaryMeasureId)
                        )

                        const filteredSecondaryMeasure = filteredSecondaryIndicator[0].Measures.filter(m =>
                            m.MeasureID === primaryMeasureId
                        )

                        selectedlinksSecondaryIndicatorData = filteredSecondaryIndicator
                        selectedlinksSecondaryMeasureData = filteredSecondaryMeasure

                        // console.log('PRIMARY MEASURE TIMES: +++++++++++ ', primaryMeasureTimes)
                        // console.log('FILTERED AXIS INDICATOR: --------- ', filteredSecondaryIndicator)
                        // console.log('FILTERED AXIS MEASURE: +++++++++++ ', filteredSecondaryMeasure)

                        const sortedPrimaryMeasureTimes = primaryMeasureTimes.sort((a, b) => b.end_period - a.end_period)
                        const mostRecentPrimaryMeasureTime = sortedPrimaryMeasureTimes[0].TimeDescription;
                        const mostRecentPrimaryMeasureStartTime = sortedPrimaryMeasureTimes[0].start_period;
                        const mostRecentPrimaryMeasureEndTime = sortedPrimaryMeasureTimes[0].end_period;

                        const aqPrimaryMeasureTimes = aq.from(primaryMeasureTimes);

                        // console.log('MOST RECENT PRIMARY MEASURE START + END TIME: -------------- ', mostRecentPrimaryMeasureTime, mostRecentPrimaryMeasureStartTime, mostRecentPrimaryMeasureEndTime)

                        // aqPrimaryMeasureTimes.print()
                        
                        // console.log('most recent mmmm ', aq.from([sortedPrimaryMeasureTimes[0]]))
                        const secondaryMeasureTimes = filteredSecondaryMeasure[0].AvailableTimes;
                        const sortedSecondaryMeasureTimes = secondaryMeasureTimes.sort((a, b) => b.end_period - a.end_period)
                        const mostRecentSecondaryMeasureTime = sortedSecondaryMeasureTimes[0].TimeDescription;
                        const mostRecentSecondaryMeasureStartTime = sortedSecondaryMeasureTimes[0].start_period;
                        const mostRecentSecondaryMeasureEndTime = sortedSecondaryMeasureTimes[0].end_period;

                        const aqSecondaryMeasureTimes = aq.from(secondaryMeasureTimes);
                        


                        const filteredMatchingTimes = sortedSecondaryMeasureTimes.filter(t => 
                            // t.start_period >= mostRecentPrimaryMeasureStartTime && t.end_period <= mostRecentPrimaryMeasureEndTime
                            t.start_period >= 'no' && t.end_period <= 'yes'
                        )

                        if (!filteredMatchingTimes.length) {
                            // console.log('no match')
                            const mostRecentMatchingTime = sortedSecondaryMeasureTimes.filter(t => 
                                t.end_period === mostRecentPrimaryMeasureEndTime
                                // t.start_period >= 'no' && t.end_period <= 'yes'
                            )
                           //  // console.log('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ most recent mathcing time: ', mostRecentMatchingTime)
                        }

                        // console.log('>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> mathcing times', filteredMatchingTimes)
                        // console.log('SORTED SECONDARY MEASURE TIMES: ', sortedSecondaryMeasureTimes )
                        // console.log('MOST RECENT SECONDARY MEASURE START + END TIME: -------------- ', mostRecentSecondaryMeasureTime, mostRecentSecondaryMeasureStartTime, mostRecentSecondaryMeasureEndTime)

                        const filteredSecondaryIndicatorId = filteredSecondaryIndicator[0].IndicatorID;
                            const sortedPrimaryT = aq.from(sortedPrimaryMeasureTimes)

                        fetch(data_repo + "/" + data_branch + `/indicators/data/${filteredSecondaryIndicatorId}.json`)
                            .then(response => response.json())
                            .then(data => {
                                
                                const filteredSecondaryMeasureData = data.filter(d => d.MeasureID === primaryMeasureId)
                                // console.log('data: -----------------------------------> ', filteredSecondaryMeasureData)
                                // console.log('SORTED SECONDARY MEASURE TIMES ', sortedSecondaryMeasureTimes)

                                // const testData = aq.from(fullDataLinksObjects)
                                //     .join(sortedSecondaryT, ["Time", "TimeDescription"])
                                //     .filter(d => d.Time === '2007-2011')
                                const aqJoinedSecondaryLinksData = aq.from(filteredSecondaryMeasureData)
                                    .groupby("Time", "GeoType", "GeoID", 'MeasureID')
                                    .pivot("MeasurementType", "Value")
                                    .join(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                    .join(aqSecondaryMeasureTimes, ["Time", "TimeDescription"])
                                    .relocate(['Name'], { after: 'GeoID' })
                                    .relocate(['GeoType'], { before: 'GeoID' })
                                    .rename({
                                        'Name': 'Geography',
                                    })
                                    
                                    
                                    // .filter(d => op.parse_int(d.Time) >= 2007 && op.parse_int(d.Time) === 2011)
                                    // .join(testData, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                    
                                    // aq.from(fullDataLinksObjects).filter(d => d.Time === '2007-2011').print()
                                    // console.log('^^^^^^^^^^^^^^^^^ full data ^^^^^^^^^^^^^^^^^^^^^^^^', fullDataLinksObjects)


                                const  aqJoinedPrimaryLinksData = aq.from(fullDataLinksObjects)
                                    .join(aqPrimaryMeasureTimes, ["Time", "TimeDescription"])

                                // console.log('@@@@@@@@@@@@@@@@@@@@ AQ PRIMARY DATA @@@@@@@@@@@@@@@@@@@@@@@@@ ' )
                                // aqJoinedPrimaryLinksData.print()

                                const joinedPrimaryLinksDataObject = aqJoinedPrimaryLinksData.objects();
                                const filteredJoinedPrimaryLinksDataObject = joinedPrimaryLinksDataObject.filter(d => 
                                    d.start_period == mostRecentPrimaryMeasureStartTime && d.end_period == mostRecentPrimaryMeasureEndTime)

                                const joinedSecondaryLinksDataObject = aqJoinedSecondaryLinksData.objects();

                                let mostRecentJoinedSecondaryLinksDataObject = []

                                

                                // get the closest secondary end time 
                                const closestSecondaryTime = joinedSecondaryLinksDataObject.reduce((prev, curr) => {
                                    return (Math.abs(curr.end_period - mostRecentPrimaryMeasureEndTime) < Math.abs(prev.end_period - mostRecentPrimaryMeasureEndTime) ? curr : prev);
                                });

                                

                                const closestSecondaryData = joinedSecondaryLinksDataObject.filter(d => 
                                    d.end_period === closestSecondaryTime.end_period)

                                mostRecentJoinedSecondaryLinksDataObject = closestSecondaryData

                                console.log('yo', joinedSecondaryLinksDataObject)

                                const secondaryYears =  [...new Set(mostRecentJoinedSecondaryLinksDataObject.map(item => item.Time))];
                                const highest = Math.max(...secondaryYears);

                                // get lowest number
                                const lowest = Math.min(...secondaryYears);

                                if (secondaryYears.length > 1) {
                                    selectedlinksSecondaryMeasureTime = `${lowest}-${highest}`;
                                } else {
                                    selectedlinksSecondaryMeasureTime = `${secondaryYears[0]}`
                                }
                                
                                // console.log('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SEONDARY YEARS', secondaryYears, highest, lowest)


                                const aqMostRecentJoinedSecondaryLinksDataObject = aq.from(mostRecentJoinedSecondaryLinksDataObject)

                                const aqJoinedPrimarySecondaryData = aq.from(filteredJoinedPrimaryLinksDataObject)
                                    .join(aqMostRecentJoinedSecondaryLinksDataObject, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                                
                                // aqJoinedPrimarySecondaryData.print()
                                joinedDataLinksObjects = aqJoinedPrimarySecondaryData.objects();

                                // console.log('==========================================================================')
                                // console.log('Load Date - aqJoinedSecondaryLinksData')
                                // aq.from(mostRecentJoinedSecondaryLinksDataObject).print();
                            })
                    }

                    const handleYearFilter = (el, indicatorId) => {
                        el.addEventListener('change',(e) => {
                            if (e.target.checked) {
                                // console.log('checked')
                                selectedSummaryYears = [e.target.value]
                            }
                            renderTable()
                        })
                    }

                    const handleGeoFilter = (el, indicatorId) => {
                        el.addEventListener('change',(e) => {
                            if (e.target.checked) {
                                selectedSummaryGeography.push(e.target.value)
                            } else {
                                selectedSummaryGeography = selectedSummaryGeography.filter(item => item !== e.target.value);
                            }
                            renderTable()
                        })
                    }

                    const handleToggle = () => { 
                        $('body').off('click', '#summary-table tr.group td');
                        $('body').on('click', '#summary-table tr.group td', (e) => {
                            const td = $(e.target);
                            const tr = td.parent();
                            const group = td.data('group');
                            const groupLevel = td.data('group-level');

                            const handleGroupToggle = () => {
                                
                                const subGroupToggle = $(`td[data-year="${group}"][data-group-level="1"]`);
                                const subGroupRow = $(`tr[data-year="${group}"]`);

                                if (subGroupToggle.css('display') === 'none') {
                                    subGroupToggle.removeClass('hidden');
                                    subGroupRow.removeClass('hidden');
                                    td.removeClass('hidden');
                                    subGroupToggle.show();
                                    subGroupRow.show();
                                } else {
                                    subGroupToggle.addClass('hidden');
                                    subGroupRow.addClass('hidden');
                                    td.addClass('hidden');
                                    subGroupToggle.hide();
                                    subGroupRow.hide();
                                }
                            }

                            const handleSubGroupToggle = () => {
                                const subDataGroup = tr.next(`tr`).data(`group`);
                                const parentDataGroup = subDataGroup.split('-')[0];
                                const subGroupRow = $(`tr[data-group="${subDataGroup}"]`);
                                const parentGroupToggle = $(`td[data-group="${parentDataGroup}"]`);

                                if (subGroupRow.css('display') == 'none')  {
                                    subGroupRow.show();
                                    td.removeClass('hidden');
                                    subGroupRow.removeClass('hidden');
                                    parentGroupToggle.removeClass('hidden');
                                } else {
                                    subGroupRow.hide();
                                    td.addClass('hidden');
                                    subGroupRow.addClass('hidden');
                                }
                            }

                            if (groupLevel === 0) {
                                handleGroupToggle();
                            } else {
                                handleSubGroupToggle();
                            }

                        });
                    }

                    // Renders the Indicator Title and Description
                    const renderTitleDescription = (title, desc) => {
                        const indicatorTitle = document.querySelector('.indicator-title');
                        const indicatorDescription = document.querySelector('.indicator-description');
                        indicatorTitle.innerHTML = title;
                        indicatorDescription.innerHTML = `<strong>Indicator description: </strong> ${desc}`;
                    }

                    // Renders copy for the About the measures and the Data sources sections
                    const renderAboutSources = (about, sources) => {
                        aboutMeasures.innerHTML = about;
                        dataSources.innerHTML = sources;
                    }

                    const updateMapData = (e) => {
                        const measureId = parseInt(e.target.dataset.id);
                        const measure = mapMeasures.filter(m => m.MeasureID == measureId);
                        const measurementType = measure[0].MeasurementType;
                        const date = e.target.dataset.date;
                        const about = measure[0].how_calculated;
                        const sources = measure[0].Sources;
                        const display = measure[0].DisplayType;

                        selectedMapAbout = about;
                        selectedMapSources =  sources;

                        selectedMapSources = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${sources}</p>`;
                        selectedTrendAbout = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${about}</p>`;
                        
                        var geoTypFilteredData;
                        
                        const filteredData = fullDataMapObjects.filter(obj => 
                            obj.Time === date
                        )

                        renderAboutSources(selectedTrendAbout, selectedMapSources);
                        renderMap(filteredData, measurementType, display, date);
                        selectedMapMeasure =  true;
                    }

                    const updateTrendData = (e) => {
                        const measureId = parseInt(e.target.dataset.id);
                        const measure = trendMeasures.filter(m => m.MeasureID == measureId);
                        const measurementType = measure[0].MeasurementType;
                        const disparities = measure[0].VisOptions[0].Trend && measure[0].VisOptions[0].Trend[0]?.Disparities;
                        const about = measure[0].how_calculated;
                        const sources = measure[0].Sources;
                        const display = measure[0].DisplayType;

                        selectedTrendSources = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${sources}</p>`;
                        selectedTrendAbout = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${about}</p>`;
                        
                        renderAboutSources(selectedTrendAbout, selectedTrendSources);
                        renderTrendChart(fullDataTrendObjects, measurementType, display, disparities, measure);
                        selectedTrendMeasure = true;
                    }

                    const updateLinksData = (e) => {
                        const measureId = parseInt(e.target.dataset.measureId);
                        const primaryMeasureId = parseInt(e.target.dataset.primaryMeasureId);
                        const secondaryMeasureId = parseInt(e.target.dataset.secondaryMeasureId);

                        const linksSecondaryIndicator =  indicators.filter(indicator =>
                            indicator.Measures.some(m => 
                                m.MeasureID === secondaryMeasureId)
                        )
                        const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m =>
                            m.MeasureID === secondaryMeasureId
                        )

                        const measure = linksMeasures.filter(m => m.MeasureID == measureId);
                        const measurementType = measure[0].MeasurementType;
                        const secondaryMeasure = linksSecondaryMeasure[0].MeasurementType;
                        const secondaryIndicator = linksSecondaryIndicator[0].IndicatorLabel;
                        {{/*  const axis = measure[0].VisOptions[0].Links[0].Axis;  */}}
                        const axis = measure[0].VisOptions[0].Links.filter(d => d.MeasureID === secondaryMeasureId)[0].Axis

                        console.log('AXIS: ', primaryMeasureId, secondaryMeasureId, measure[0], axis)
                        
                        
                        const about = measure[0].how_calculated;
                        const secondaryAbout = linksSecondaryMeasure[0].how_calculated;
                        const sources = measure[0].Sources;
                        const secondarySources = linksSecondaryMeasure[0].Sources;
                        const display = measure[0].DisplayType;
                        const combinedSources = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${sources}</p><h6>${secondaryIndicator} - ${secondaryMeasure}</h6><p>${secondarySources}</p>`;
                        const combinedAbout = `<h6>${indicator.IndicatorName} - ${measurementType}</h6><p>${about}</p><h6>${secondaryIndicator} - ${secondaryMeasure}</h6><p>${secondaryAbout}</p>`;
                        
                        selectedLinkMeasureData = linksMeasures.filter(m => m.MeasureID === measureId)
                        // console.log('LINKS MEASURES: ', selectedLinkMeasureData, primaryMeasureId, linksSecondaryIndicator)
                        selectedLinksAbout = combinedAbout;
                        selectedLinksSources =  combinedSources;


                        // console.log('fix linksSecondaryIndicator: ', linksSecondaryIndicator)
                        // console.log('fix linksSecondaryMeasure: ', linksSecondaryMeasure)
                        // console.log('fix selectedLinkMeasureData', selectedLinkMeasureData)
                        
                        renderAboutSources(combinedAbout, combinedSources);
                        renderLinksChart(selectedLinkMeasureData, measurementType, display, axis, measureId, secondaryMeasureId)
                        selectedLinksMeasure = true;
                    }

                    const setDefaultMapMeasure = (defaultArray, visArray) => {
                        // console.log('SET DEFAULT MEASURE: ', mapMeasures, trendMeasures, defaultArray)
                        defaultArray.length = 0;

                        const hasAgeAdjustedRate = visArray.filter(measure =>
                            measure.MeasurementType.includes('Age Adjusted Rate')
                        )
                        const hasRate = visArray.filter(measure =>
                            measure.MeasurementType.includes('Rate')
                        )
                        const hasPercent = visArray.filter(measure =>
                            measure.MeasurementType.includes('Percent')
                        )

                        if (hasAgeAdjustedRate.length) {
                            const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure => 
                                measure.MeasurementType.includes('Total')
                            )

                            // Set total as default if available
                            if (hasAgeAdjustedRateTotal.length) {
                                defaultArray.push(hasAgeAdjustedRateTotal[0]);
                            } else {
                                defaultArray.push(hasAgeAdjustedRate[0]);
                            }
                            
                        } else if (hasRate.length) {
                            defaultArray.push(hasRate[0]);
                        } else if (hasPercent.length) {
                            defaultArray.push(hasPercent[0]);
                        } else {
                            defaultArray.push(visArray[0]);
                        }
                    }

                    const setDefaultMeasure = (defaultArray, visArray) => {
                        defaultArray.length = 0;

                        if (visArray.length > 0) {
                            const hasAgeAdjustedRate = visArray.filter(measure =>
                                measure.MeasurementType.includes('Age Adjusted Rate')
                            )
                            const hasRate = visArray.filter(measure =>
                                measure.MeasurementType.includes('Rate')
                            )
                            const hasPercent = visArray.filter(measure =>
                                measure.MeasurementType.includes('Percent')
                            )

                            if (hasAgeAdjustedRate.length) {
                                const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure => 
                                    measure.MeasurementType.includes('Total')
                                )
                                // Set total as default if available
                                if (hasAgeAdjustedRateTotal.length) {
                                    defaultArray.push(hasAgeAdjustedRateTotal[0]);
                                } else {
                                    defaultArray.push(hasAgeAdjustedRate[0]);
                                }
                                
                            } else if (hasRate.length) {
                                defaultArray.push(hasRate[0]);
                            } else if (hasPercent.length) {
                                defaultArray.push(hasPercent[0]);
                            } else {
                                defaultArray.push(visArray[0]);
                            }
                        }                        
                    }

                    const setDefaultLinksMeasure = (defaultArray, visArray) => {
                        defaultArray.length = 0;

                        if (visArray.length > 0) {
                            const hasAgeAdjustedRate = visArray.filter(measure =>
                                measure.MeasurementType.includes('Age Adjusted Rate')
                            )
                            const hasRate = visArray.filter(measure =>
                                measure.MeasurementType.includes('Rate')
                            )
                            const hasPercent = visArray.filter(measure =>
                                measure.MeasurementType.includes('Percent')
                            )

                            if (hasAgeAdjustedRate.length) {
                                const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure => 
                                    measure.MeasurementType.includes('Total')
                                )
                                // Set total as default if available
                                if (hasAgeAdjustedRateTotal.length) {
                                    defaultArray.push(hasAgeAdjustedRateTotal[0]);
                                } else {
                                    defaultArray.push(hasAgeAdjustedRate[0]);
                                }
                                
                            } else if (hasRate.length) {
                                defaultArray.push(hasRate[0]);
                            } else if (hasPercent.length) {
                                defaultArray.push(hasPercent[0]);
                            } else {
                                defaultArray.push(visArray[0]);
                            }
                            defaultLinkMeasureTimes = defaultArray[0].AvailableTime;
                            const defaultArrayMeasureId = defaultArray[0].VisOptions[0].Links[0].MeasureID;
                            filterSecondaryIndicatorMeasure(defaultArray)
                        }
                    }
                    
                    const loadIndicator = (data, bypassUrlChange) => {
                        let data2 = data
                        selectedSummaryYears = [];
                        selectedSummaryGeography = [];
                        const firstIndicatorId = document.querySelectorAll('#indicator-dropdown button')[0].getAttribute('data-internal-id');
                        if (!data2) { 
                            data2 = defaultIndicatorId
                        }
        
                        indicator = indicators.find(indicator => indicator.IndicatorID === data2);
                        indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : 'N/A';
                        indicatorDesc = indicator?.IndicatorDescription ? indicator.IndicatorDescription : `N/A`;
                        indicatorShortName = indicator?.IndicatorShortname ? indicator.IndicatorShortname : indicatorName;
                        indicatorMeasurses = indicator?.Measures;
                        indicatorId = indicator?.IndicatorID;     
                        
                        // console.log('==========================================================================')
                        // console.log('Load Indicator - IndicatorId: ', indicatorId)
                        // console.log('Load Indicator - Description: ', indicatorDesc)
                        // console.log('Load Indicator - Indicator: ', indicator)
                        // console.log('Load Indicator - Measures: ', indicatorMeasurses)


                        if (!bypassUrlChange) {
                            url.searchParams.set('id', indicatorId);
                            window.history.pushState({ id: indicatorId }, '', url);
                        }
                        

                        loadData(indicatorId)
                        const indicatorTitle = document.querySelector(".indicator-title")
                        indicatorTitle.innerHTML = indicatorName
                    }

                    const renderMeasures = () => {
                        // console.log('==========================================================================')
                        // console.log('Render Measures')
                        linksMeasures.length = 0

                        const contentSummary = document.querySelector('#tab-table');
                        const contentMap = document.querySelector('#tab-map')
                        const contentTrend = document.querySelector('#tab-trend');
                        const contentLinks = document.querySelector('#tab-links');
                        const dropdownTableYear = contentSummary.querySelector('div[aria-labelledby="dropdownTableYear"]');
                        const dropdownMapMeasures = document.querySelector('div[aria-labelledby="dropdownMapMeasures"]');                        
                        
                        const dropdownMapYear = contentMap.querySelector('div[aria-labelledby="dropdownMapYear"]');
                        const dropdownTableGeo = contentSummary.querySelector('div[aria-labelledby="dropdownTableGeo"]');
                        const dropdownTrendMeasures = contentTrend.querySelector('div[aria-labelledby="dropdownTrendMeasures"]');
                        const dropdownLinksMeasures = contentLinks.querySelector('div[aria-labelledby="dropdownLinksMeasures"]');
                        const tableGeoTypes =  [...new Set(joinedAqData.objects().map(item => item.GeoType))];
                        const tableYears =  [...new Set(joinedAqData.objects().map(item => item.Time))];
                        const mapYears =  [...new Set(fullDataMapObjects.map(item => item.Time))];

                        // clear Measure Dropdowns
                        dropdownTableYear.innerHTML = ``;
                        dropdownTableGeo.innerHTML = ``;
                        dropdownMapMeasures.innerHTML = ``;
                        dropdownTrendMeasures.innerHTML = ``;
                        dropdownLinksMeasures.innerHTML = ``;

                        mapMeasures.length = 0;
                        trendMeasures.length = 0;

                        tableYears.forEach((year, index) => {
                            if (index === 0) {
                                selectedSummaryYears.push(year);
                                dropdownTableYear.innerHTML += `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" checked /> ${year}</label>`;
                            } else {
                                dropdownTableYear.innerHTML += `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" /> ${year}</label>`;
                            }
                        });

                        tableGeoTypes.forEach((geoType, index) => {
                            selectedSummaryGeography.push(geoType);
                            dropdownTableGeo.innerHTML += `<label class="dropdown-item checkbox-geo"><input type="checkbox" value="${geoType}" checked /> ${geoType}</label>`;
                        });

                        // console.log('measures: ', indicator, indicatorMeasurses)

                        indicatorMeasurses.map((measure, index) => {
                            const type = measure?.MeasurementType;
                            const displayType = measure?.DisplayType;
                            const years = measure?.AvailableTimes.sort((a, b) => b.start_period - a.start_period);
                            const geography = measure?.AvailableGeographyTypes;
                            const links = measure?.VisOptions[0].Links && measure?.VisOptions[0]?.Links[0];
                            const map = measure?.VisOptions[0].Map && measure?.VisOptions[0].Map[0]?.On;
                            const trend = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.On;
                            const trendDisparities = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.Disparities;
                            const about = measure.how_calculated;
                            const sources = measure.Sources;
                            const measureId = measure.MeasureID;

                            if (map === 1) {
                                mapMeasures.push(measure)
                                dropdownMapMeasures.innerHTML += `<div class="dropdown-column-${index}"><div class="dropdown-title"><strong> ${type}</strong></div></div>`;
                                const dropdownMapMeasuresColumn = document.querySelector(`.dropdown-column-${index}`);
                                // console.log('dropdownMapMeasures: ', dropdownMapMeasures)
                                mapYears.map((time, index) => {
                                    dropdownMapMeasuresColumn.innerHTML += `<button class="dropdown-item link-measure"
                                        data-id="${measureId}"
                                        data-date="${time}">
                                            ${time}
                                        </button>`;
                                })
                            }

                            if (trend === 1) {
                                trendMeasures.push(measure)
                                if  (fullDataTrendObjects) {
                                    dropdownTrendMeasures.innerHTML += `<button class="dropdown-item link-measure"
                                        data-id="${measureId}"> 
                                            ${type}
                                        </button>`;
                                }
                            }

                            if (links) {
                                linksMeasures.push(measure)
                                const primaryMeasureId = measure.VisOptions[0].Links[0].MeasureID;

                                if  (fullDataLinksObjects) {
                                    const linkYears =  [...new Set(fullDataLinksObjects.map(item => item.Time))];
                                    dropdownLinksMeasures.innerHTML += `<div class="dropdown-title"><strong> ${type}</strong></div>`;
                                    measure.VisOptions[0].Links.map(link => {
                                        const linksSecondaryIndicator = indicators.filter(indicator =>
                                            indicator.Measures.some(m => 
                                                m.MeasureID === link.MeasureID)
                                        );

                                        const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(
                                            m => m.MeasureID === link.MeasureID
                                        );

                                        dropdownLinksMeasures.innerHTML += `<button class="dropdown-item link-measure" 
                                            data-primary-measure-id="${primaryMeasureId}"
                                            data-measure-id="${measure.MeasureID}"
                                            data-secondary-measure-id="${link.MeasureID}">
                                               ${linksSecondaryIndicator[0].IndicatorLabel} - ${linksSecondaryMeasure[0].MeasurementType}
                                            </button>`;
                                    })
                                }
                            }
                        })

                        setDefaultMapMeasure(defaultMapMeasure, mapMeasures);
                        setDefaultMeasure(defaultTrendMeasure, trendMeasures);
                        setDefaultLinksMeasure(defaultLinksMeasure, linksMeasures);

                        $('#tab-btn-table').on('shown.bs.tab', function(e){
                            $($.fn.dataTable.tables(true)).DataTable()
                                .columns.adjust();
                            renderAboutSources(measureAbout, measureSources)
                            window.location.hash = 'display=summary'
                            updateChartPlotSize();
                        });

                        $('#tab-btn-map').on('shown.bs.tab', function(e){
                            $($.fn.dataTable.tables(true)).DataTable()
                                .columns.adjust();
                            window.location.hash = 'display=map'
                            updateChartPlotSize();
                            if (!selectedMapMeasure) {
                                const about = defaultMapMeasure[0]?.how_calculated;
                                const sources = defaultMapMeasure[0].Sources;
                                const measure = defaultMapMeasure[0].MeasurementType;
                                defaultMapbout = `<h6>${indicator.IndicatorName} - ${measure}</h6><p>${about}</p>`;
                                defaultMapSources = `<h6>${indicator.IndicatorName} - ${measure}</h6><p>${sources}</p>`;
                                renderAboutSources(defaultMapAbout, defaultMapSources);
                            } else {
                                renderAboutSources(selectedMapAbout, selectedMapSources);
                            }
                        });

                        $('#tab-btn-trend').on('shown.bs.tab', function(e){
                            $($.fn.dataTable.tables(true)).DataTable()
                                .columns.adjust();
                            renderAboutSources(measureAbout, measureSources);
                            window.location.hash = 'display=trend';
                            updateChartPlotSize();
                            if (!selectedTrendMeasure) {
                                const about = defaultTrendMeasure[0]?.how_calculated;
                                const sources = defaultTrendMeasure[0].Sources;
                                const measure = defaultTrendMeasure[0].MeasurementType;
                                defaultTrendAbout = `<h6>${indicator.IndicatorName} - ${measure}</h6><p>${about}</p>`;
                                defaultTrendSources = `<h6>${indicator.IndicatorName} - ${measure}</h6><p>${sources}</p>`;
                                renderAboutSources(defaultTrendAbout, defaultTrendSources);
                            } else {
                                renderAboutSources(selectedTrendAbout, selectedTrendSources);
                            }
                        });

                        $('#tab-btn-links').on('shown.bs.tab', function(e){
                            $($.fn.dataTable.tables(true)).DataTable()
                                .columns.adjust();
                            window.location.hash = 'display=links';
                            updateChartPlotSize();

                            const primaryMeasureId = defaultLinksMeasure[0]?.VisOptions[0].Links[0].MeasureID;
                            const linksSecondaryIndicator =  indicators.filter(indicator =>
                                indicator.Measures.some(m => 
                                    m.MeasureID === primaryMeasureId)
                            )

                            const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m =>
                                m.MeasureID === primaryMeasureId
                            )
                            const primaryIndicator = indicator.IndicatorName;
                            const primaryMeasure = defaultLinksMeasure[0].MeasurementType;
                            const primaryAbout = defaultLinksMeasure[0].how_calculated;
                            const primarySources = defaultLinksMeasure[0].Sources;
                            const secondaryIndicator = linksSecondaryIndicator[0].IndicatorLabel;
                            const secondaryMeasure = linksSecondaryMeasure[0].MeasurementType;
                            const secondaryAbout = linksSecondaryMeasure[0].how_calculated;
                            const secondarySources = linksSecondaryMeasure[0].Sources;

                            defaultLinksAbout = `<h6>${primaryIndicator} - ${primaryMeasure}</h6><p>${primaryAbout}</p><h6>${secondaryIndicator} - ${secondaryMeasure}</h6><p>${secondaryAbout}</p>`;
                            defaultLinksSources = `<h6>${primaryIndicator} - ${primaryMeasure}</h6><p>${primarySources}</p><h6>${secondaryIndicator} - ${secondaryMeasure}</h6><p>${secondarySources}</p>`;
                            if (!selectedLinksMeasure) {
                                renderAboutSources(defaultLinksAbout, defaultLinksSources);
                            } else {
                                renderAboutSources(selectedLinksAbout, selectedLinksSources);
                            }
                        });
                        // disable tabs if there are no measures

                        const tabMapSelected = tabMap.getAttribute('aria-selected');
                        const tabTrendSelected = tabTrend.getAttribute('aria-selected');
                        const tabLinksSelected = tabLinks.getAttribute('aria-selected');

                        const disableLink = (el) => {
                            el.classList.add('disabled');
                            el.setAttribute('aria-disabled', true);
                        }

                        const enableLink = (el) => {
                            el.classList.remove('disabled');
                            el.setAttribute('aria-disabled', false);
                        }

                        if (mapMeasures.length === 0) {
                            disableLink(tabMap);
                            if (tabMapSelected === true && currentHash === 'display=map') {
                                // console.log('crack')
                                $('#tab-btn-table').tab('show');
                            }
                        } else {
                            enableLink(tabMap);
                            renderMap();
                        }

                        if (trendMeasures.length === 0) {
                            disableLink(tabTrend);
                            if (tabTrendSelected === true && currentHash === 'display=trend') {
                                $('#tab-btn-table').tab('show');
                            }
                        } else {
                            enableLink(tabTrend);
                            renderTrendChart();
                        }

                        if (linksMeasures.length === 0) {
                            disableLink(tabLinks);
                            if (tabLinksSelected && currentHash === 'display=links') {
                                $('#tab-btn-table').tab('show');
                            }
                        } else {
                            enableLink(tabLinks);
                            renderLinksChart();
                        }
                        renderTable();
                        renderTitleDescription(indicatorShortName, indicatorDesc);
                        renderAboutSources(measureAbout, measureSources);

                        const mapMeasuresLinks = document.querySelectorAll('#tab-map .link-measure');
                        const trendMeasuresLinks = document.querySelectorAll('#tab-trend .link-measure');
                        const linksMeasuresLinks = document.querySelectorAll('#tab-links .link-measure');

                        mapMeasuresLinks.forEach(link => {
                            link.addEventListener('click', e => updateMapData(e));
                        })
                        
                        trendMeasuresLinks.forEach(link => {
                            link.addEventListener('click', e => updateTrendData(e));
                        })

                        linksMeasuresLinks.forEach(link => {
                            link.addEventListener('click', e => updateLinksData(e));
                        })
                        

                        const checkboxYear = document.querySelectorAll('.checkbox-year');
                        const checkboxGeo = document.querySelectorAll('.checkbox-geo');

                        checkboxYear.forEach(checkbox => {
                            handleYearFilter(checkbox, indicatorId);
                        })
                        checkboxGeo.forEach(checkbox => {
                            handleGeoFilter(checkbox, indicatorId);
                        })

                        // Render default Measure About and Sources
                        measureAbout = '';
                        measureSources = '';
                        indicatorMeasurses.map(measure => {
                            measureAbout += `<h6>${measure.MeasurementType}</h6>${measure.how_calculated}`;
                            measureSources += `<h6>${measure.MeasurementType}</h6><p>${measure.Sources}</p>`;
                        })
                        
                        renderAboutSources(measureAbout, measureSources);
                    }
            </script>

            <style>
            .topic-text {
                background-color: #f9f9f9;
                padding: 5px;
                border-top-right-radius: 5px;
                border-bottom-right-radius: 5px;
                border-left: 3px solid darkgray;
            }

                .topic-text h3 {
                font-size: 18px;
                color: #656565;
            }
                .topic-text p li {
                font-size: 12px;
            }

            
            </style>

            <div class="row">
                <div class="col-md-4">
                    <div class="card fs-sm mb-2 topic-text d-none d-md-block">
                        <!-- Content truncate-->
                        {{ .Content  }}


                    </div>
                </div>

                <div class="col-md-8">
                    
                    <div class="dropdown float-right">
                        <button class="btn btn-outline-primary float-right dropdown-toggle" type="button" id="dropdownTableYear" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="text-align:right!important">
                          More {{ .Title }} data
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownTableYear" id="indicator-dropdown">
                            <!-- Dropdown itmes are rendered using renderIndicatorDropdown -->
                        </div>
                    </div>
                    <h3 class="indicator-title"></h3>


                    <div style="clear:both" class="my-3">
                        <p class="fs-sm indicator-description"><strong>Indicator description:</strong></p>
                    </div>

                    <div class="nav nav-pills bg-white device-xs" role="tablist">

                        <a class="nav-item nav-link flex-fill active" id="tab-btn-table" href="#tab-table"
                            data-toggle="pill" aria-controls="tab-table" aria-selected="true" role="tab">
                            <i class="fas fa-list h4 fa-fw"></i><div class="d-none d-lg-block">Summary</div>
                        </a>
                    
                        <a class="nav-item nav-link flex-fill" id="tab-btn-map" href="#tab-map"
                            data-toggle="pill" aria-controls="tab-map" aria-selected="false" role="tab">
                            <i class="fas fa-map-marker-alt h4 fa-fw"></i><div class="d-none d-lg-block">Map</div>
                        </a>
                    
                        <a class="nav-item nav-link flex-fill" id="tab-btn-trend" href="#tab-trend"
                            data-toggle="pill" aria-controls="tab-trend" aria-selected="false" role="tab">
                            <i class="fas fa-chart-line h4 fa-fw"></i><div class="d-none d-lg-block">Trend</div>
                        </a>


                        <a class="nav-item nav-link flex-fill" id="tab-btn-links" href="#tab-links"
                            data-toggle="pill" aria-controls="tab-links" aria-selected="false" aria-disabled="true" role="tab">
                            <i class="fas fa-link h4 fa-fw"></i><div class="d-none d-lg-block">Links</div>
                        </a>
                    
                    </div>
                    
                    <div class="tab-content bg-white mb-4" id="tabs-01-content">
                        <!-- TABLE TAB -->
                        <div class="tab-pane fade show active py-2" id="tab-table" aria-labelledby="tab-btn-table" role="tabpanel">
                            <div class="float right">
                                <div class="dropdown">
                                    <button class="btn btn-sm float-right btn-outline-success dropdown-toggle" type="button" id="dropdownTableYear" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select year
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownTableYear">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>

                                <div class="dropdown">
                                    <button class="btn btn-sm mr-1 float-right btn-outline-success dropdown-toggle" type="button" id="dropdownTableGeo" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select geography
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownTableGeo">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>
                            </div>
                            <div id="summary-table" class="border mt-4">
                                <!-- INSERT SUMMARY TABLE HERE -->
                            </div>
                        </div> 
                        <!-- MAP TAB -->
                        <div class="tab-pane fade py-2" id="tab-map" aria-labelledby="tab-btn-map" role="tabpanel">
                            <div class="float right">
                                <div class="dropdown">
                                    <button class="btn btn-sm mr-1 float-right btn-outline-success dropdown-toggle" type="button" id="dropdownMapMeasures" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select measure
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMapMeasures">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>
                            </div>
                            <div class="border mt-4">
                                <div id="map" width=600 height=500 style="width: 100%; min-height: 450px; margin-bottom: 50px;"></div>
                            </div>                        
                        </div>
                        <!-- TREND TAB -->
                        <div class="tab-pane fade py-2" id="tab-trend" aria-labelledby="tab-btn-trend" role="tabpanel">
                            <div class="dropdown float-right">
                                <button class="btn btn-sm float-right btn-outline-success dropdown-toggle" type="button" id="dropdownTrendMeasures" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Choose measure
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownTrendMeasures">
                                  <!-- INSERT MENU ITEMS HERE -->
                                </div>
                            </div>
                            <div class="border mt-4">
                                <!-- INSERT TREND CHART HERE -->
                                <div id="trend" style="width: 100%"></div>
                            </div>
                        </div>
                        <!-- LINKS TAB -->
                        <div class="tab-pane fade py-2" id="tab-links" aria-labelledby="tab-btn-links" role="tabpanel">
                            <div class="dropdown float-right">
                                <button class="btn btn-sm float-right btn-outline-success dropdown-toggle" type="button" id="dropdownLinksMeasures" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select data to link
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownLinksMeasures">
                                    <!-- INSERT MENU ITEMS HERE -->
                                </div>
                            </div>
                            <div class="border mt-4" style="height: 550px; clear: both">
                                <!-- INSERT LINKS CHART HERE -->
                                <div id="links" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-2">
                    <div class="row">
                        <div class="col-6">
                            <h4 class="fs-rg">About the measures</h4>
                            <p class="fs-sm indicator-measures">Insert from `How_Calculated.` Vivamus consequat id nibh et tempor. Cras augue enim, iaculis quis purus sit amet, interdum accumsan neque. In blandit varius blandit. Praesent vel leo ac urna dapibus faucibus. Donec sed luctus neque. Nulla porta finibus elit, luctus eleifend felis ornare vitae. Ut consequat laoreet libero eu venenatis.</p>
                        </div>
                        <div class="col-6">
                            <h4 class="fs-rg">Data sources</h4>
                            <p class="fs-sm indicator-sources">Insert from `Sources.` Pellentesque blandit ante vel augue mattis, lacinia tincidunt velit feugiat. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Donec nulla nisl, sollicitudin et volutpat at, finibus ac quam. Pellentesque faucibus turpis egestas tellus luctus, nec porttitor diam bibendum. Sed mauris augue, tempus id urna sit amet, hendrerit blandit libero. Cras sit amet luctus nunc, nec mattis leo. </p>

                        </div>
                    </div>
                    
                    <hr class="my-2">

                    <div class="row mb-4">
                        <div class="col">
                            <h4>Related:</h4>
                            <p>Insert related content via partial, here.</p>
                        </div>
                    </div>


            
                </div>
            </div>

        </div>
    </div>

                </div>
            </div>

        </div>
    </div>



</article>

{{ $js := resources.Get "js/accessible-autocomplete.min.js" }}
{{ $secureJS := $js }}
<script type="text/javascript" src="{{ $secureJS.Permalink }}" integrity="{{ $secureJS.Data.Integrity }}"></script>

<script type="text/javascript"> 
    // https://www.aspsnippets.com/Articles/Populate-DropDownList-from-JSON-Array-using-JavaScript.aspx
    function populateDropDownList() {          
           var ddlData = document.getElementById("all-data");
          {{ range (where .Site.Pages "Section" "data-explorer") }} // range through data_explorer pages
            var option = document.createElement("OPTION");
            //Set Neighborhood Name in Text part.
            option.innerHTML = {{ .Title }}
            // set the option value - this adds the environment variable to give it the base URL.
            option.value = '{{ .Site.Params.sitepath }}/{{ .RelPermalink }}'
            //Add the Option element to DropDownList.
            ddlData.options.add(option);
          {{ end }}
       };

       populateDropDownList(); // runs the function above.

       // this handles AA highlighting.
       var selectEl = document.querySelector('#all-data')
        accessibleAutocomplete.enhanceSelectElement({
        autoselect: true,
        confirmOnBlur: true,
        defaultValue: "",
        minLength: 2,
        selectElement: selectEl
            });


    // this takes the AA form and on submit, sends page to a new location.
    var dataSearchForm = document.getElementById('all-data-select') // this isn't all-data, but all-data-select because of changes applied by the AA JS.
    document.querySelector('form.autocomplete-form').addEventListener("submit", function (e) {
        e.preventDefault(); // prevent page re-load
        window.location.assign(DOMPurify.sanitize(dataSearchForm.options[dataSearchForm.selectedIndex].value))
      });



   </script>

{{ end }}