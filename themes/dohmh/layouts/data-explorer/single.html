{{ define "main" }}

<style>
    /* These styles overwrite default Vega-Lite tooltip styles */

    /* set overall row styles */
    #vg-tooltip-element table tr {
        border-bottom: 1px solid #d9d9d9;
        {{/*  width: max-content;  */}}
    }
    /* remove bottom border from last row */
    #vg-tooltip-element table tr:last-child {
        border-bottom: 0px;
    }

    /* set different style for key column */
    #vg-tooltip-element table tr td.key {
        font-size: 12px!important;
        color: #505050;
        border-right: 1px solid #d9d9d9;
        text-align: right;
        padding-right: 10px;
        width: max-content;
    }

    /* set different style for value column */
    #vg-tooltip-element table tr td.value {
        font-size: 12px!important;
        color: black;
        text-align: left;
        padding-left: 10px;
        width: max-content;
    }

    /* Set font-size for table headers */
    #summary-table table thead tr th {
        font-size: 13px!important;
    }

    /* This CSS controls read more/show less toggle. */
    [aria-expanded="false"]>.expanded,
    [aria-expanded="true"]>.collapsed {
        display: none;
    }

    #truncate {
        display: block;
    }

    #full {
        display: none;
    }

    #expand-collapse {
        cursor: pointer;
    }

    .show {
        display: block !important;
    }

    .hide {
        display: none !important;
    }

    /* .tab-content > .tab-pane {
        display: block !important;
        opacity: 1 !important;
    } */

    .dropdown-title {
        padding: 0.25rem 1.5rem;
    }

    .indicator-measures h6 {
        margin-top: 0.5em;
    }

    .dropdown-menu {
        z-index: 2000;
    }

    div[aria-labelledby="dropdownMapMeasures"].show {
        display: flex !important;
    }

    /* info text boxes */

    .topic-text {
        font-size: 12px!important;
    }

    .topic-text h3 {
        font-size: 16px;
        color: #656565;
    }

    .topic-text p li {
        font-size: 12px;
    }

    /* indicator selection button */

    button.text-info, button.text-info {
        color: #841972 !important;
    }
    button.text-info:hover, button.text-info:focus {
        color: #ffffff !important;
    }

    /* dropdown list items - active styles based on if they're related to a primary or secondary button style */

    .btn-outline-primary ~ .dropdown-menu .dropdown-item.active,
    .btn-outline-primary ~ .dropdown-menu .dropdown-item:active {
        color: #ffffff;
        text-decoration: none;
        background-color: #841972;
    }

    .btn-outline-secondary ~ .dropdown-menu .dropdown-item.active,
    .btn-outline-secondary ~ .dropdown-menu .dropdown-item:active {
        color: #ffffff;
        text-decoration: none;
        background-color: #181A7B;
    }

    /* topic selection modal */

    .modal-backdrop.show {
        opacity: 0.70;
        background-color: #424242
    }

    .de-modal-title {
        margin-bottom: 0;
        margin-top: 0;
        line-height: 1;
    }

    .modal-header .close {
        padding: 0.5rem 0.5rem;
        margin: -1rem -1rem -1rem auto;
    }

    /* disabled checkbox */

    .checkbox-geo.disabled > input {
        accent-color: #656565;
    }

</style>

<article class="container-fluid" id="skip-header-target">
    <div class="row">
        <div class="col-md-11 mx-auto mt-4 mx-1">
            <nav aria-label="breadcrumb" class="mb-2">
                <ul class="breadcrumb mr-auto">
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}/data-explorer/">Data Explorer</a></li>
                    <li class="breadcrumb-item active"><a href="{{ .Page.RelPermalink }}">{{ .Title }}</a></li>
                    <li class="nav-item ml-auto">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-toggle="modal"
                                data-target="#topicModal">
                            Change topic
                        </button>

                        <!--
                            <form class="autocomplete-form form-inline">
                                <label for="all-data" class="block col-sm-12 font-weight-bold h4 mb-3 sr-only">Search data</label>
                                <div class="autocomplete-wrapper" width="100%">
                                    <select name="all-data" id="all-data">
                                        <option value=""><i class="fas fa-search mr-2"></i>Search data</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary btn" style="height:40px;"><i class="fas fa-search"></i></button>
                            </form>
                        -->

                    </li>
                </ul>
            </nav>

            <div class="row mb-1">
                <div class="col mx-2 ml-0 pl-0 py-2">
                    <h2>{{ .Title }}</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">

                    <div class="card content-card mb-2">
                        <div class="card-content">
                            <div class="card-body topic-text">
                                <span class='home-label d-none d-md-block border-bottom mb-1'>About this topic</span>
                                 {{ .Content  }}
                            </div>

                        </div>


                    </div>

                    {{- partial "keywords" . -}}
                </div>

                <div class="col-md-8">
                    <!--This button only appears on small screens to show About-->
                    <button class="btn btn-sm btn-outline-light text-primary btn-block d-block d-md-none mt-0 mb-2"
                            type="button" data-toggle="modal" data-target="#aboutModal">
                        About {{ .Title }}
                    </button>


                    <!-- indicator dropdown -->

                    <div class="card content-card topic-text">
                        <div class="card-content">
                            <div class="card-body">
                                <div class="dropdown">

                                    <span class='home-label d-block'>Change dataset</span>

                                    <button class="btn btn-outline-primary btn-lg btn-block text-wrap text-info dropdown-toggle" type="button"
                                            id="dropdownIndicator" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        More {{ .Title }} data
                                    </button>

                                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownIndicator"
                                         id="indicator-dropdown">
                                        <!-- Dropdown itmes are rendered using renderIndicatorDropdown -->
                                    </div>

                                </div>


                                <div style="clear:both" class="my-2">
                                    <span class="home-label d-block">About <span id="indicatorTitle">Indicator</span></span>

                                    <p class="fs-sm indicator-description"></p>
                                </div>
                            </div>

                        </div>


                    </div>

                    <div class="card content-card mt-1">
                        <div class="card-content">
                            <div class="card-body">
                                <div class="mt-2">
                                    <div class="nav nav-pills bg-white device-xs" role="tablist">

                                        <a class="nav-item nav-link flex-fill" id="tab-btn-table" href="#tab-table" data-toggle="pill"
                                           aria-controls="tab-table" aria-selected="false" role="tab" style="text-decoration:none">
                                            <i class="fas fa-list fa-fw"></i>
                                            <div class="d-none d-lg-inline-block py-1">Summary</div>
                                        </a>

                                        <a class="nav-item nav-link flex-fill" id="tab-btn-map" href="#tab-map" data-toggle="pill"
                                           aria-controls="tab-map" aria-selected="false" role="tab" style="text-decoration:none">
                                            <i class="fas fa-map-marker-alt fa-fw"></i>
                                            <div class="d-none d-lg-inline-block py-1">Map</div>
                                        </a>

                                        <a class="nav-item nav-link flex-fill" id="tab-btn-trend" href="#tab-trend" data-toggle="pill"
                                           aria-controls="tab-trend" aria-selected="false" role="tab" style="text-decoration:none">
                                            <i class="fas fa-chart-line fa-fw"></i>
                                            <div class="d-none d-lg-inline-block py-1">Trend</div>
                                        </a>


                                        <a class="nav-item nav-link flex-fill" id="tab-btn-links" href="#tab-links" data-toggle="pill"
                                           aria-controls="tab-links" aria-selected="false" aria-disabled="true" role="tab" style="text-decoration:none">
                                            <i class="fas fa-link fa-fw"></i>
                                            <div class="d-none d-lg-inline-block py-1">Links</div>
                                        </a>

                                    </div>

                                    <div class="tab-content bg-white mb-4" id="tabs-01-content">
                                        <!-- TABLE TAB -->
                                        <div class="tab-pane fade show active py-2" id="tab-table" aria-labelledby="tab-btn-table"
                                             role="tabpanel">
                                            <div class="float right mr-1">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm float-right btn-outline-secondary dropdown-toggle"
                                                            type="button" id="dropdownTableYear" data-toggle="dropdown"
                                                            aria-haspopup="true" aria-expanded="false">Select year
                                                    </button>
                                                    <div class="dropdown-menu" aria-labelledby="dropdownTableYear">
                                                        <!-- INSERT MENU ITEMS HERE -->
                                                    </div>
                                                </div>

                                                <div class="dropdown">
                                                    <button class="btn btn-sm mr-1 float-right btn-outline-secondary dropdown-toggle"
                                                            type="button" id="dropdownTableGeo" data-toggle="dropdown"
                                                            aria-haspopup="true" aria-expanded="false">Select geography
                                                    </button>
                                                    <div class="dropdown-menu" aria-labelledby="dropdownTableGeo">
                                                        <!-- INSERT MENU ITEMS HERE -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <span id="summaryTitle" class="home-label"></span>
                                                <div id="summary-table">
                                                    <!-- INSERT SUMMARY TABLE HERE -->
                                                </div>

                                            </div>
                                        </div>
                                        <!-- MAP TAB -->
                                        <div class="tab-pane fade py-2" id="tab-map" aria-labelledby="tab-btn-map" role="tabpanel">
                                            <div class="float right mr-1">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm mr-1 float-right btn-outline-secondary dropdown-toggle"
                                                            type="button" id="dropdownMapMeasures" data-toggle="dropdown"
                                                            aria-haspopup="true" aria-expanded="false">Select
                                                        measure
                                                    </button>
                                                    <div class="dropdown-menu" aria-labelledby="dropdownMapMeasures">
                                                        <!-- INSERT MENU ITEMS HERE -->
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <span id="mapTitle" class="home-label"></span>
                                                <div id="map" width=600 height=500
                                                     style="width: 100%; min-height: 450px; margin-bottom: 50px;"></div>
                                            </div>
                                        </div>
                                        <!-- TREND TAB -->
                                        <div class="tab-pane fade py-2" id="tab-trend" aria-labelledby="tab-btn-trend" role="tabpanel">
                                            <div class="dropdown float-right mr-1">
                                                <button class="btn btn-sm float-right btn-outline-secondary dropdown-toggle" type="button"
                                                        id="dropdownTrendMeasures" data-toggle="dropdown" aria-haspopup="true"
                                                        aria-expanded="false">Choose measure</button>
                                                <!-- disparities button - display style changed to show or hide -->
                                                <button class="btn btn-sm mr-1 float-right btn-outline-secondary btn-show-disparities"
                                                        style="display:inline">Show Dispartites</button>

                                                <div class="dropdown-menu" aria-labelledby="dropdownTrendMeasures">
                                                    <!-- INSERT MENU ITEMS HERE -->
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <span id="trendTitle" class="home-label"></span>
                                                <!-- INSERT TREND CHART HERE -->
                                                <div id="trend" style="width: 100%; height: 550px"></div>
                                            </div>
                                        </div>
                                        <!-- LINKS TAB -->
                                        <div class="tab-pane fade py-2" id="tab-links" aria-labelledby="tab-btn-links" role="tabpanel">
                                            <div class="dropdown float-right">
                                                <button class="btn btn-sm float-right btn-outline-secondary dropdown-toggle" type="button"
                                                        id="dropdownLinksMeasures" data-toggle="dropdown" aria-haspopup="true"
                                                        aria-expanded="false">Select data to link
                                                </button>
                                                <div class="dropdown-menu" aria-labelledby="dropdownLinksMeasures">
                                                    <!-- INSERT MENU ITEMS HERE -->
                                                </div>
                                            </div>
                                            <div class="mt-4" style="height: 550px; clear: both">
                                                <span id="linksTitle" class="home-label"></span>
                                                <!-- INSERT LINKS CHART HERE -->
                                                <div id="links" style="width: 100%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-2">

                    <div class="row my-2">
                        <div class="col-md-4">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light text-secondary dropdown-toggle"
                                        type="button"
                                        id="downloadDD"
                                        data-toggle="dropdown"
                                        aria-haspopup="true"
                                        aria-expanded="false"
                                    ><i class="fa fa-download mr-1"></i>Download Data
                                </button>
                                <div class="dropdown-menu dropdown-menu-right"
                                     aria-labelledby="downloadDD">
                                <a class="dropdown-item buttons-csv btn-outline-info" id="thisView">Current table view</a>
                                <a class="dropdown-item buttons-csv btn-outline-info" id="allData">Full table for this indicator</a>
                                <a class="dropdown-item buttons-csv btn-outline-info" id="rawData">Raw data for this indicator</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 ml-auto">
                            <button class="btn float-right btn-sm btn-outline-light text-secondary"
                                    onclick="copyCitation()" id="citeButton"><i class="fas fa-copy mr-1"></i>Copy
                                citation</button>
                            <input type="text" id="citeText" value=""
                                   style="display:inline-block; width:100%; height: 40px; font-size: 14px;"
                                   class="my-2 sr-only">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6 col-xs-12">
                            <div class="btn-toggle">
                                <button class="btn btn-block btn-md btn-outline-light text-secondary"
                                        data-toggle="collapse" data-target="#toggle-target" aria-expanded="false"
                                        aria-controls="toggle-target">
                                    <span class="title"><i class="fas fa-info-circle mr-1"></i>About the Measures</span>
                                </button>
                            </div>

                            <div class="collapse p-2" id="toggle-target" role="navigation">
                                <p class="fs-sm indicator-measures">Insert from `How_Calculated.` Vivamus consequat id
                                    nibh et tempor. Cras
                                    augue enim, iaculis quis purus sit amet, interdum accumsan neque. In blandit varius
                                    blandit. Praesent
                                    vel leo ac urna dapibus faucibus. Donec sed luctus neque. Nulla porta finibus elit,
                                    luctus eleifend
                                    felis ornare vitae. Ut consequat laoreet libero eu venenatis.</p>

                            </div>
                        </div>
                        <div class="col-md-6 col-xs-12">
                            <div class="btn-toggle">
                                <button class="btn btn-block btn-md btn-outline-light text-secondary"
                                        data-toggle="collapse" data-target="#toggle-target-2" aria-expanded="false"
                                        aria-controls="toggle-target-2">
                                    <span class="title"><i class="fas fa-database mr-1"></i>Data sources</span>
                                </button>
                            </div>

                            <div class="collapse p-2" id="toggle-target-2" role="navigation">
                                <p class="fs-sm indicator-sources">Insert from `Sources.` Pellentesque blandit ante vel
                                    augue mattis, lacinia
                                    tincidunt velit feugiat. Class aptent taciti sociosqu ad litora torquent per conubia
                                    nostra, per inceptos
                                    himenaeos. Donec nulla nisl, sollicitudin et volutpat at, finibus ac quam.
                                    Pellentesque faucibus turpis
                                    egestas tellus luctus, nec porttitor diam bibendum. Sed mauris augue, tempus id urna
                                    sit amet, hendrerit
                                    blandit libero. Cras sit amet luctus nunc, nec mattis leo. </p>

                            </div>
                        </div>

                    </div>

                    <!--Notes placekeeper - can be injected following table scan-->
                    <div class="row mb-4">
                        <div class="col">
                                <p style="font-size:10px">
                                    <em>* Estimate is based on small numbers so should be interpreted with caution.<br>
                                        ** Estimate is suppressed due to insufficient data.</em>
                                    </p>

                        </div>
                    </div>
                
                {{- partial "related-footer" . -}}

                </div>
            </div>

        </div>
    </div>

    <!-- Topic Selection Modal -->

    <div class="modal fade" id="topicModal" tabindex="-1" role="dialog" aria-labelledby="topicModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content mb-2 border-light shadow">
                <div class="modal-header">
                    <h5 class="de-modal-title" id="topicModalLabel">Change topic</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0 ">
                    {{ partial "de-chooser-accordion.html" . }}
                </div>
            </div>
        </div>
    </div>


    <!--About Modal-->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About {{ .Title }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {{ .Content }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Arquero -->
    <script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>

    <!--DataTables CSS-->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.1.0/css/buttons.dataTables.min.css">

    <!--DataTables JS-->
    <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"
        integrity="sha512-oaT4uVdyleJGVHZqklOx2Bb8WhOTBW3iCXRtgk3+YutYmFx0jSs97UR3/+r1vh1Isyb3GOGjFonLbS6LFiiEVA=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"
        integrity="sha512-guWTt6syHB4T9gdPdw8W1iQUGqqricRt5VRjnjgMPpOhUhwOsxmXpk2SImqfcPgsiroK00z/loICebflVeJvqg=="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"
        integrity="sha512-vv3EN6dNaQeEWDcxrKPFYSFba/kgm//IUnvLPMPadaUf5+ylZyx4cKxuc4HdBf0PPAlM7560DV63ZcolRJFPqA=="
        crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.0/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/rowgroup/1.1.4/js/dataTables.rowGroup.min.js"></script>

    <!-- Vega-Lite -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <!--D3-->
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <!-- Data Explorer -->
    <script src="{{ .Site.BaseURL }}/js/data-explorer/summary.js"></script>
    <script src="{{ .Site.BaseURL }}/js/data-explorer/map.js"></script>
    <script src="{{ .Site.BaseURL }}/js/data-explorer/trend.js"></script>
    <script src="{{ .Site.BaseURL }}/js/data-explorer/links.js"></script>
    <script src="{{ .Site.BaseURL }}/js/data-explorer/disparities.js"></script>

    <script>

        {{/*  clicking on the indicator dropdown calls loadIndicator with that IndicatorID  */}}

        let indicators = []; // indicator data
        let defaultIndicatorId;
        let selectedSummaryYears = [];
        let selectedSummaryGeography = [];
        let aboutMeasures;
        let dataSources;

        let measureAbout = `N/A`;
        let measureSources = `N/A`;
        let geoTable;
        let aqData;
        let joinedAqData;

        let fullDataTableObjects;
        let fullDataMapObjects;
        let fullDataTrendObjects;
        let fullDataLinksObjects;
        let joinedDataLinksObjects;
        let disparitiyData; // used by disparities.js

        let indicator;
        let indicatorName;
        let indicatorDesc;
        let indicatorShortName;
        let indicatorMeasures;
        let indicatorId;
        let primaryIndicatorName;
        let secondaryIndicatorName;

        let defaultTrendMetadata = [];
        let defaultTrendAbout;
        let defaultTrendSources;
        let defaultMapMetadata = [];
        let defaultMapAbout;
        let defaultMapSources;
        let defaultLinksMetadata = [];
        let defaultLinkMeasureTimes = [];
        let defaultLinksAbout;
        let defaultLinksSources;

        let selectedMapMeasure;
        let selectedTrendMeasure;
        let selectedLinksMeasure;
        let selectedMapAbout;
        let selectedMapSources;
        let selectedTrendAbout;
        let selectedTrendSources;
        let selectedLinksAbout;
        let selectedLinksSources;
        let selectedlinksSecondaryMeasureTime;

        let primaryMeasureMetadata;
        let secondaryMeasureMetadata;

        let filteredMapData;
        let filteredTrendData;
        let filteredLinksData;

        let mapMeasures = [];
        let trendMeasures = [];
        let linksMeasures = [];

        let tabTable;
        let tabMap;
        let tabTrend;
        let tabLinks;

        let showTable;
        let showMap;
        let showTrend;
        let showLinks;

        // store hash, so display knows where it just was
        let currentHash;
        let state;

        // modifying the measure dropdown innerHTML removes the event listeners from the dropdown list. So, i added it to the HTML, and we can remove it when we call renderTrendChart, if necessary

        // get trend dropdown element; disparities button will be removed or appended
        let tabTrendDropDown = document.querySelector('#tab-trend .dropdown');

        // get disparities button dom element, so it can be removed and appended as needed
        let btnShowDisparities = document.querySelector('.btn-show-disparities');

        const url = new URL(window.location);

        const updateChartPlotSize = () => {
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 200)

        }

        // hash change event, for firing on hash switch in renderMeasures

        let hashchange = new Event('hashchange');

        // call loadindicator when traversing through the history

        window.onpopstate = function (event) {

            console.log("** pop **");
            console.log("state: ", window.history.state);
            console.log("event: ", event);

            const new_url = new URL(window.location);
            let new_indicatorId = parseFloat(new_url.searchParams.get('id'));

            console.log("new_indicatorId [pop]", new_indicatorId);

            if (new_indicatorId != indicatorId) {

                loadIndicator(new_indicatorId, true)

            }
        };

        window.addEventListener("hashchange", () => {

            const hash = window.location.hash.replace('#', "");
            console.log("< hashchange > hash: ", hash);

            switch (hash) {

                // using fallthrough

                case 'display=summary':
                case 'tab-table':
                    console.log("< hashchange > summary");
                    currentHash = 'display=summary';
                    $('#tab-btn-table').tab('show');
                    showTable();
                    break;

                case 'display=map':
                case 'tab-map':
                    console.log("< hashchange > map");
                    currentHash = 'display=map';
                    $('#tab-btn-map').tab('show');
                    showMap();
                    break;

                case 'display=trend':
                case 'tab-trend':
                    console.log("< hashchange > trend");
                    currentHash = 'display=trend';
                    $('#tab-btn-trend').tab('show');
                    showTrend();
                    break;

                case 'display=links':
                case 'tab-links':
                    console.log("< hashchange > links");
                    currentHash = 'display=links';
                    $('#tab-btn-links').tab('show');
                    showLinks();
                    break;

                default:
                    console.log("< hashchange > default");
                    currentHash = 'display=summary';
                    {{/*  window.location.hash = 'display=summary';  */}}
                    {{/*  $('#tab-btn-table').tab('show');  */}}
                    {{/*  showTable();  */}}
                    break;
            }

            state = window.history.state;

            console.log(">> state [hashchange]", state);

        });


        document.addEventListener("DOMContentLoaded", () => {

            tabTable = document.querySelector('#tab-btn-table');
            tabMap = document.querySelector('#tab-btn-map');
            tabTrend = document.querySelector('#tab-btn-trend');
            tabLinks = document.querySelector('#tab-btn-links');

            aboutMeasures = document.querySelector('.indicator-measures');
            dataSources = document.querySelector('.indicator-sources');

        });

        function reveal() {
            document.getElementById('truncate').classList.toggle('hide');
            document.getElementById('full').classList.toggle('show');
            document.getElementById('contenttoggle').innerHTML = `Show less... <i class="fas fa-caret-square-up" aria-hidden="true"></i>`;
        }


        {{/*  define georank function at top scope, so we can use it later  */}}

        const assignGeoRank = (GeoType) => {
            switch (GeoType) {
                case 'Citywide':
                    return 0;
                case 'Borough':
                    return 1;
                case 'NYCKIDS':
                    return 2;
                case 'UHF34':
                    return 3;
                case 'UHF42':
                    return 4;
                case 'Subboro':
                    return 5;
                case 'CD':
                    return 6;
                case 'NTA':
                    return 7;
            }
        }


        {{/* =================================================================== */}}
        {{/*  fetch and load indicators metadata into global object              */}}
        {{/* =================================================================== */}}

        fetch(data_repo + "/" + data_branch + '/indicators/indicators.json')
            .then(response => response.json())
            .then(async data => {

                indicators = data;

                const paramId = url.searchParams.get('id') !== null ? parseInt(url.searchParams.get('id')) : false;

                const renderIndicatorDropdown = () => {

                    const indicatorDropdown = document.getElementById("indicator-dropdown");
                    let this_indicatorName;
                    let header;

                    {{- range .Params.Indicators }}

                        header = `{{ .header }}`;
                        indicatorDropdown.innerHTML += header.length ? `<div class="dropdown-title"><strong>${header}</strong></div>`: '';

                        {{ range $index, $id := .IndicatorID -}}

                            {{ if (eq $index 0) -}} defaultIndicatorId = {{ $id -}} {{ end }}

                            indicator = indicators.find(indicator => indicator.IndicatorID === {{ $id }});
                            this_indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : 'N/A';
                            indicatorDropdown.innerHTML += `<button class="indicator-dropdown-item dropdown-item" onclick="loadIndicator({{ $id }})" data-indicator-id={{ $id }}>${this_indicatorName}</button>`

                        {{- end -}}
                    {{- end -}}
                }

                renderIndicatorDropdown()

                // calling loadIndicator calls loadData, etc, and eventually renderMeasures. Because all
                //  of this depends on the global "indicator" object, we call loadIndicator here

                if (paramId) {
                    await loadIndicator(paramId)
                } else {
                    await loadIndicator()
                }

            })
            .catch(error => console.log(error));


        // ======================================================================= //
        // data loading and manipulation functions
        // ======================================================================= //

        // I reversed the order of these function declarations to make the process
        //  of data creation easier to understand

        // ----------------------------------------------------------------------- //
        // function to load indicator metadata
        // ----------------------------------------------------------------------- //

        const loadIndicator = (this_indicatorId, dont_add_to_history) => {

            console.log("** loadIndicator");

            currentHash = window.location.hash;
            console.log("currentHash [loadIndicator]", currentHash);

            console.log("this_indicatorId", this_indicatorId);
            console.log("window.history.state", window.history.state);

            // if indicatorId isn't given, use the first indicator from the dropdown list
            //  (which is populated by Hugo reading the content frontmatter).

            const firstIndicatorId = document.querySelectorAll('#indicator-dropdown button')[0].getAttribute('data-indicator-id');

            indicatorId = this_indicatorId ? parseFloat(this_indicatorId) : parseFloat(firstIndicatorId);

            // remove active class from every list element
            $(".indicator-dropdown-item").removeClass("active");
            $(".indicator-dropdown-item").attr('aria-selected', false);

            // get the list element for this indicator
            const thisIndicatorEl = document.querySelector(`button[data-indicator-id='${indicatorId}']`)

            // set this element as active & selected
            $(thisIndicatorEl).addClass("active");
            $(thisIndicatorEl).attr('aria-selected', true);

            // indicatorId comes in as  a string, so "find" uses '==' instead of '==='

            indicator = indicators.find(indicator => indicator.IndicatorID == indicatorId);
            indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : '';
            indicatorDesc = indicator?.IndicatorDescription ? indicator.IndicatorDescription : '';
            indicatorShortName = indicator?.IndicatorShortname ? indicator.IndicatorShortname : indicatorName;
            indicatorMeasures = indicator?.Measures;

            //create Citation

            createCitation(); // re-runs on updating Indicator

            // send Indicator Title to vis headers

            document.getElementById('summaryTitle').innerHTML = indicatorName;
            document.getElementById('mapTitle').innerHTML     = indicatorName;
            document.getElementById('trendTitle').innerHTML   = indicatorName;

            // reset selected measure flags

            selectedMapMeasure = false;
            selectedTrendMeasure = false;
            selectedLinksMeasure = false;

            // if dont_add_to_history is true, then don't push the state
            // if dont_add_to_history is false, or not set, push the state
            // this prevents loadIndicator from setting new history entries when it's called
            //  on a popstate event, i.e. when the user is traversing the history stack

            // dont_add_to_history catches the pop state case, state.id != indicatorId catches the location change case
            // we don't want to add to the history stack if we've landed on this page by way of the history stack

            url.searchParams.set('id', parseFloat(indicatorId));

            if (!dont_add_to_history && (window.history.state === null || state === null || window.history.state.id != indicatorId)) {

                console.log("++++ add to history");

                console.log("indicatorId [1]:", url.searchParams.get('id'))

                if (!url.hash) {

                    console.log("- no hash");
                    console.log("state [pre]: ", window.history.state);
                    console.log("indicatorId [2]:", url.searchParams.get('id'))

                    // if loadIndicator is being called without a hash (like when a topic page is loaded), then show the first ID and summary

                    url.hash = "display=summary";
                    window.history.replaceState({ id: indicatorId, hash: url.hash}, '', url);

                    console.log("state [post]: ", window.history.state);

                } else {

                    console.log("# hash");
                    console.log("state [pre]: ", window.history.state);
                    console.log("indicatorId [3]:", url.searchParams.get('id'))

                    url.hash = currentHash;
                    window.history.pushState({ id: indicatorId, hash: url.hash }, '', url);

                    console.log("state [post]: ", window.history.state);

                }

            } else {

                console.log("---- don't add to history");
                console.log("state: ", window.history.state);
                console.log("indicatorId [4]:", url.searchParams.get('id'))

            }

            // call data loading function

            const indicatorTitle = document.getElementById('dropdownIndicator')

            indicatorTitle.innerHTML = indicatorName

            loadData(indicatorId)
        }

        // ----------------------------------------------------------------------- //
        // function to Load indicator data and create Arquero data frame
        // ----------------------------------------------------------------------- //

        const loadData = (this_indicatorId) => {

            fetch(data_repo + "/" + data_branch + `/indicators/data/${this_indicatorId}.json`)
            .then(response => response.json())
            .then(async data => {

                // call the geo file loading function

                loadGeo();

                ful = aq.from(data)
                    .derive({ "GeoRank": aq.escape( d => assignGeoRank(d.GeoType))})
                    .groupby("Time", "GeoType", "GeoID", "GeoRank")


                aqData = ful
                    .groupby("Time", "GeoType", "GeoID")
                    .orderby(aq.desc('Time'), 'GeoRank')
            })
        }

        // ----------------------------------------------------------------------- //
        // function to load geographic data
        // ----------------------------------------------------------------------- //

        const loadGeo = () => {

            const geoUrl = data_repo + "/" + data_branch + `/geography/GeoLookup.csv`; // col named "GeoType"

            aq.loadCSV(geoUrl)
                .then(data => {

                    geoTable = data.select(aq.not('Lat', 'Long'));

                    // call the data-to-geo joining function

                    joinData();

            });
        }

        // ----------------------------------------------------------------------- //
        // function to join indicator data and geo data
        // ----------------------------------------------------------------------- //

        const joinData = () => {

            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // get metadata fields
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // flatten MeasureID + TimeDescription

            let availableTimes = [];

            // create table column header with display type

            let measurementDisplay = [];

            indicatorMeasures.map(

                measure => {

                    let aqAvailableTimes =
                        aq.from(measure.AvailableTimes)
                        .derive({MeasureID: `${measure.MeasureID}`})

                    availableTimes.push(aqAvailableTimes);

                    let aqMeasurementDisplay =
                        aq.table(
                        {
                            MeasureID: [measure.MeasureID],
                            MeasurementType: [measure.MeasurementType],
                            DisplayType: [measure.DisplayType]
                        })

                    measurementDisplay.push(aqMeasurementDisplay);

                }
            )

            // bind rows of Arquero tables in arrays

            let aqMeasureIdTimes     = availableTimes.reduce((a, b) => a.concat(b))
            let aqMeasurementDisplay = measurementDisplay.reduce((a, b) => a.concat(b))

            // foundational joined dataset

            joinedAqData = aqData
                .join_left(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                .rename({'Name': 'Geography'})
                .join(aqMeasureIdTimes, [["MeasureID", "Time"], ["MeasureID", "TimeDescription"]])
                .select(
                    "GeoID",
                    "GeoType",
                    "GeoRank",
                    "Geography",
                    "MeasureID",
                    "Time",
                    "Value",
                    "DisplayValue",
                    "CI",
                    "start_period",
                    "end_period"
                )
                .orderby(aq.desc('end_period'), aq.desc('GeoRank'))
                .reify()

            // data for summary table

            fullDataTableObjects = joinedAqData
                .join_left(aqMeasurementDisplay, "MeasureID")
                .derive({
                    MeasurementDisplay: d => op.trim(op.join([d.MeasurementType, d.DisplayType], " ")),
                    DisplayCI: d => op.trim(op.join([d.DisplayValue, d.CI], " "))
                })
                .derive({ DisplayCI: d => op.replace(d.DisplayCI, /^$/, "-") }) // replace missing with "-"
                .select(aq.not("start_period", "end_period"))
                .objects()

            // data for map

            fullDataMapObjects = joinedAqData
                .filter(d => !op.match(d.GeoType, /Citywide|Borough/)) // remove Citywide and Boro
                .impute({ Value: () => NaN })
                .objects()

            // map for trend chart

            fullDataTrendObjects = joinedAqData
                .filter(d => op.match(d.GeoType, /Citywide|Borough/)) // keep only Citywide and Boro
                .objects()

            // data for links & disparities chart

            fullDataLinksObjects = joinedAqData
                .filter(d => !op.match(d.GeoType, /Citywide|Borough/)) // remove Citywide and Boro
                .objects()

            // call the measure rendering etc. function

            renderMeasures();

        }


        // ----------------------------------------------------------------------- //
        // function to create data and metadata for links chart
        // ----------------------------------------------------------------------- //

        const filterSecondaryIndicatorMeasure = async (primaryMeasureId, secondaryMeasureId) => {

            // filter links data to keep primary measure

            const primaryMeasureTimesDataObjects = fullDataLinksObjects.filter(
                d => d.MeasureID === primaryMeasureId
            );

            // get most recent time period for primary measure

            const aqFilteredPrimaryMeasureTimesData = aq.from(fullDataLinksObjects)

                // most recent period in the data
                .filter(`d => d.MeasureID === ${primaryMeasureId}`)

                // most recent period in the data
                .filter(d => d.end_period === op.max(d.end_period))

            const mostRecentPrimaryMeasureStartTime = aqFilteredPrimaryMeasureTimesData.array("start_period")[0]
            const mostRecentPrimaryMeasureEndTime   = aqFilteredPrimaryMeasureTimesData.array("end_period")[0]
            const mostRecentPrimaryMeasureTime      = aqFilteredPrimaryMeasureTimesData.array("Time")[0]
            const primaryMeasureGeoRanks            = [...new Set(aqFilteredPrimaryMeasureTimesData.array("GeoRank"))]

            // get metadata for the selected primary measure, assign to global variable
            // indicatorMeasures created in loadIndicator

            primaryMeasureMetadata = linksMeasures.filter(
                measure => measure.MeasureID === primaryMeasureId
            )

            // if no secondary measure ID is given, set it to the first in the primary measure's links list

            if (typeof secondaryMeasureId == "undefined") {
                secondaryMeasureId = primaryMeasureMetadata[0].VisOptions[0].Links[0].MeasureID;
            }

            // get the indicator element for the selected secondary measure

            const secondaryIndicator = indicators.filter(
                indicator => indicator.Measures.some(
                    measure => measure.MeasureID === secondaryMeasureId
                )
            )

            // get secondary indicatorID, to get secondary data

            const secondaryIndicatorId = secondaryIndicator[0].IndicatorID

            // get metadata for the selected secondary measure, assign to global variable

            secondaryMeasureMetadata =
                secondaryIndicator[0].Measures.filter(
                measure => measure.MeasureID === secondaryMeasureId
            )

            // get most recent time period for secondary measure

            const secondaryMeasureTimes = secondaryMeasureMetadata[0].AvailableTimes;
            const aqSecondaryMeasureTimes = aq.from(secondaryMeasureTimes);


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // get secondary data
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            await fetch(data_repo + "/" + data_branch + `/indicators/data/${secondaryIndicatorId}.json`)
                .then(response => response.json())
                .then(async data => {

                    // get secondary measure data

                    const filteredSecondaryMeasureData = data.filter(d => d.MeasureID === secondaryMeasureId)

                    // join with geotable and times

                    const aqFilteredSecondaryMeasureTimesData = aq.from(filteredSecondaryMeasureData)
                        .join(
                            geoTable,
                            [["GeoID", "GeoType"], ["GeoID", "GeoType"]]
                        )
                        .derive({ "GeoRank": aq.escape( d => assignGeoRank(d.GeoType))})

                        // get same geotypes as primary data (no citywide or boro)
                        .filter(`d => op.includes([${primaryMeasureGeoRanks}], d.GeoRank)`)
                        .rename({'Name': 'Geography'})
                        .join(
                            aqSecondaryMeasureTimes,
                            ["Time", "TimeDescription"]
                        )
                        .select(aq.not("TimeDescription"))

                    // convert to JS objects

                    const filteredSecondaryMeasureTimesDataObjects = aqFilteredSecondaryMeasureTimesData.objects();

                    // get the closest secondary end time

                    const closestSecondaryTime = filteredSecondaryMeasureTimesDataObjects.reduce((prev, curr) => {

                        return (Math.abs(curr.end_period - mostRecentPrimaryMeasureEndTime) < Math.abs(prev.end_period - mostRecentPrimaryMeasureEndTime) ? curr : prev);

                    });

                    // get closest secondary data

                    const aqClosestSecondaryData = aqFilteredSecondaryMeasureTimesData

                        // data with the latest end period
                        .filter(`d => d.end_period === ${closestSecondaryTime.end_period}`)

                        // get the finest geo
                        .filter(d => d.GeoRank === op.max(d.GeoRank))

                        // in case there are two time periods left, get the one that starts the earliest,
                        //  which will be yearly over seasonal
                        .filter(d => d.start_period === op.min(d.start_period))

                    // count the number of time periods with this end period (should always be 1)

                    const aqJoinedPrimarySecondaryData = aqFilteredPrimaryMeasureTimesData
                        .join(
                            aqClosestSecondaryData,
                            [["GeoID", "GeoType"], ["GeoID", "GeoType"]]
                        )

                    // set the value of joinedDataLinksObjects, and make sure to wait for it

                    joinedDataLinksObjects = await aqJoinedPrimarySecondaryData.objects();

                })
        }


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // handler functions for summary table
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        const handleYearFilter = (el) => {
            el.addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectedSummaryYears = [e.target.value]
                }
                renderTable()
            })
        }

        const handleGeoFilter = (el) => {

            el.addEventListener('change', (e) => {

                if (e.target.checked) {
                    selectedSummaryGeography.push(e.target.value)
                } else {
                    selectedSummaryGeography = selectedSummaryGeography.filter(item => item !== e.target.value);
                }

                // only render table if a geography is checked

                if (selectedSummaryGeography.length > 0) {
                    renderTable()

                } else {
                    document.querySelector("#tableID").innerHTML = '';
                }
            })
        }

        const handleToggle = () => {

            $('body').off('click', '#summary-table tr.group td');
            $('body').on('click', '#summary-table tr.group td', (e) => {

                const td = $(e.target);
                const tr = td.parent();
                const group = td.data('group');
                const groupLevel = td.data('group-level');

                const handleGroupToggle = () => {

                    const subGroupToggle = $(`td[data-year="${group}"][data-group-level="1"]`);
                    const subGroupRow = $(`tr[data-year="${group}"]`);

                    if (subGroupToggle.css('display') === 'none') {
                        subGroupToggle.removeClass('hidden');
                        subGroupRow.removeClass('hidden');
                        td.removeClass('hidden');
                        subGroupToggle.show();
                        subGroupRow.show();
                    } else {
                        subGroupToggle.addClass('hidden');
                        subGroupRow.addClass('hidden');
                        td.addClass('hidden');
                        subGroupToggle.hide();
                        subGroupRow.hide();
                    }
                }

                const handleSubGroupToggle = () => {

                    const subDataGroup = tr.next(`tr`).data(`group`);
                    const parentDataGroup = subDataGroup.split('-')[0];
                    const subGroupRow = $(`tr[data-group="${subDataGroup}"]`);
                    const parentGroupToggle = $(`td[data-group="${parentDataGroup}"]`);

                    if (subGroupRow.css('display') == 'none')  {
                        subGroupRow.show();
                        td.removeClass('hidden');
                        subGroupRow.removeClass('hidden');
                        parentGroupToggle.removeClass('hidden');
                    } else {
                        subGroupRow.hide();
                        td.addClass('hidden');
                        subGroupRow.addClass('hidden');
                    }
                }

                if (groupLevel === 0) {
                    handleGroupToggle();
                } else {
                    handleSubGroupToggle();
                }

            });
        }


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // measure info functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // Renders the Indicator Title and Description

        const renderTitleDescription = (title, desc) => {

            const indicatorTitle = document.getElementById('indicatorTitle');
            const indicatorDescription = document.querySelector('.indicator-description');
            indicatorTitle.innerHTML = title;
            indicatorDescription.innerHTML = `${desc}`;
        }

        // Renders copy for the About the measures and the Data sources sections

        const renderAboutSources = (about, sources) => {

            aboutMeasures.innerHTML = about;
            dataSources.innerHTML = sources;
        }


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // tab update functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // ===== map ===== //

        const updateMapData = (e) => {

            // ----- handle selection ----- //

            // get meaasureId of selected dropdown element

            const measureId = parseInt(e.target.dataset.measureId);

            // get selected time

            const time = e.target.dataset.time;

            // persistent selection

            // remove active class from every list element
            $('.mapbutton').removeClass("active");
            $('.mapbutton').attr('aria-selected', false);

            // set this element as active & selected
            $(e.target).addClass("active");
            $(e.target).attr('aria-selected', true);


            // ----- get metatadata for selected measure ----- //

            const measureMetadata = mapMeasures.filter(m => m.MeasureID == measureId);
            const measurementType = measureMetadata[0].MeasurementType;
            const about           = measureMetadata[0].how_calculated;
            const sources         = measureMetadata[0].Sources;
            const display         = measureMetadata[0].DisplayType;


            // ----- set measure info boxes ----- //

            // "indicatorName" is set in loadIndicator

            selectedMapAbout   =
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${about}</p>`;

            selectedMapSources =
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${sources}</p>`;

            // render measure info boxes

            renderAboutSources(selectedMapAbout, selectedMapSources);


            // ----- create dataset ----- //

            // filter map data using selected measure and time

            let mapMeasureData =
                fullDataMapObjects.filter(
                    obj => obj.MeasureID === measureId &&
                    obj.Time === time
                );

            // get the highest GeoRank, then keep just that geo

            let maxGeoRank = Math.max(mapMeasureData[0].GeoRank);
            filteredMapData = mapMeasureData.filter(obj => obj.GeoRank === maxGeoRank)

            // ----- render the map ----- //

            renderMap(filteredMapData, measureMetadata);

            updateChartPlotSize();

            // allow map to persist when changing tabs

            selectedMapMeasure = true;

        }


        // ===== trend ===== //

        const updateTrendData = (e) => {

            console.log("updateTrendData");

            // ----- handle selection ----- //

            // get meaasureId of selected dropdown element

            const measureId = parseInt(e.target.dataset.measureId);

            // persistent selection

            // remove active class from every list element
            $('.trendbutton').removeClass("active");
            $('.trendbutton').attr('aria-selected', false);

            // set this element as active & selected
            $(e.target).addClass("active");
            $(e.target).attr('aria-selected', true);

            // ----- get metatadata for selected measure ----- //

            // trendMeasures is created by renderMeasures, which evals before this would be called
            const measureMetadata = trendMeasures.filter(m => m.MeasureID == measureId);
            const measurementType = measureMetadata[0].MeasurementType;
            const about           = measureMetadata[0].how_calculated;
            const sources         = measureMetadata[0].Sources;
            const display         = measureMetadata[0].DisplayType;


            // ----- set measure info boxes ----- //

            selectedTrendAbout =
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${about}</p>`;

            selectedTrendSources =
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${sources}</p>`;

            // render measure info boxes

            renderAboutSources(selectedTrendAbout, selectedTrendSources);


            // ----- handle disparities button ----- //

            // check if disparities is enabled for this measure

            const disparities =
                measureMetadata[0].VisOptions[0].Trend &&
                measureMetadata[0].VisOptions[0].Trend[0]?.Disparities;

            // hide or how disparities button

            if (disparities == 0) {

                // if disparities is disabled, hide the button

                btnShowDisparities.style.display = "none";

                // remove click listeners to button that calls renderDisparities

                $(btnShowDisparities).off()

            } else if (disparities == 1) {

                // remove event listener added when/if button was clicked

                btnShowDisparities.innerText = "Show Disparities";
                $(btnShowDisparities).off()

                // if disparities is enabled, show the button

                btnShowDisparities.style.display = "inline";

                // add click listener to button that calls renderDisparities

                $(btnShowDisparities).on("click", () => renderDisparities(measureMetadata, 221));

            }


            // ----- create dataset ----- //

            // created filtered trend data, to be passed to render function

            filteredTrendData = fullDataTrendObjects.filter(m => m.MeasureID === measureId);


            // ----- render the chart ----- //

            // chart only the annual average for the following measureIds:
            // 365 - PM2.5 (Fine particles), Mean
            // 370 - Black carbon, Mean
            // 391 - Nitric oxide, Mean
            // 375 - Nitrogen dioxide, Mean

            const measureIdsAnnualAvg = [365, 370, 375, 391];

            // chart only the summer average for the following measureIds:
            // 386 - Ozone (O3), Mean

            const measureIdsSummer = [386];

            if (measureIdsAnnualAvg.includes(measureId)) {

                const filteredTrendDataAnnualAvg = filteredTrendData.filter(d => d.Time.startsWith('Annual Average'));

                renderTrendChart(filteredTrendDataAnnualAvg, measureMetadata);
                updateChartPlotSize();

            } else if (measureIdsSummer.includes(measureId)) {

                const filteredTrendDataSummer = filteredTrendData.filter(d => d.Time.startsWith('Summer'));

                renderTrendChart(filteredTrendDataSummer, measureMetadata);
                updateChartPlotSize();

            } else {

                renderTrendChart(filteredTrendData, measureMetadata);
                updateChartPlotSize();

            }

            // allow trend chart to persist when changing tabs

            selectedTrendMeasure = true;

        }


        // ===== links ===== //

        const updateLinksData = async (e) => {

            // ---- handle selection ----- //

            // persistent selection

            // remove active class from every list element
            $('.linksbutton').removeClass("active");
            $('.linksbutton').attr('aria-selected', false);

            // set this element as active & selected
            $(e.target).addClass("active");
            $(e.target).attr('aria-selected', true);

            // get meaasureIds of selected dropdown element

            const primaryMeasureId = parseInt(e.target.dataset.primaryMeasureId);
            const secondaryMeasureId = parseInt(e.target.dataset.secondaryMeasureId);

            // call filterSecondaryIndicatorMeasure, which creates joinedDataLinksObjects,
            //  primaryMeasureMetadata, secondaryMeasureMetadata

            await filterSecondaryIndicatorMeasure(primaryMeasureId, secondaryMeasureId)


            // ----- get metatadata for selected measure ----- //

            // for all indicators, get the ones that are linked to the current indicator

            const linksSecondaryIndicator = indicators.filter(
                indicator => indicator.Measures.some(
                    m => m.MeasureID === secondaryMeasureId
                )
            )

            // get indicator names, for chart + about & sources

            primaryIndicatorName   = indicatorName // created in loadIndicator
            secondaryIndicatorName = linksSecondaryIndicator[0].IndicatorName

            // extract metadata for about & sources boxes

            const primaryMeasurementType = primaryMeasureMetadata[0].MeasurementType;
            const secondaryMeasurementType = secondaryMeasureMetadata[0].MeasurementType;

            const primaryAbout = primaryMeasureMetadata[0].how_calculated;
            const secondaryAbout = secondaryMeasureMetadata[0].how_calculated;

            const primarySources = primaryMeasureMetadata[0].Sources;
            const secondarySources = secondaryMeasureMetadata[0].Sources;


            // ----- set measure info boxes ----- //

            selectedLinksAbout =
                `<h6>${primaryIndicatorName} - ${primaryMeasurementType}</h6>
                <p>${primaryAbout}</p>
                <h6>${secondaryIndicatorName} - ${secondaryMeasurementType}</h6>
                <p>${secondaryAbout}</p>`;

            selectedLinksSources =
                `<h6>${primaryIndicatorName} - ${primaryMeasurementType}</h6>
                <p>${primarySources}</p>
                <h6>${secondaryIndicatorName} - ${secondaryMeasurementType}</h6>
                <p>${secondarySources}</p>`;

            // render the measure info boxes

            renderAboutSources(selectedLinksAbout, selectedLinksSources);


            // ----- create dataset ----- //

            // get the highest GeoRank, then keep just that geo

            // let maxGeoRank = Math.max(joinedDataLinksObjects[0].GeoRank);
            // filteredLinksData = joinedDataLinksObjects.filter(obj => obj.GeoRank === maxGeoRank)


            // ----- render the chart ----- //

            renderLinksChart(
                joinedDataLinksObjects,
                primaryMeasureMetadata,
                secondaryMeasureMetadata,
                primaryIndicatorName,
                secondaryIndicatorName
            );

            updateChartPlotSize();

            // allow links chart to persist when changing tabs

            selectedLinksMeasure = true;

        }


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // tab default measure functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // ===== map ===== //

        const setDefaultMapMeasure = (visArray) => {

            // modified so that defaultMapMetadata is explicitly set, instead of by reference
            //  through defaultArray

            let defaultArray = [];

            const hasAgeAdjustedRate = visArray.filter(measure =>
                measure.MeasurementType.includes('Age Adjusted Rate')
            )
            const hasRate = visArray.filter(measure =>
                measure.MeasurementType.includes('Rate')
            )
            const hasPercent = visArray.filter(measure =>
                measure.MeasurementType.includes('Percent')
            )

            // console.log("hasPercent [setDefaultMapMeasure]", hasPercent);

            if (hasAgeAdjustedRate.length) {

                const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure =>
                    measure.MeasurementType.includes('Total')
                )

                // Set total as default if available
                if (hasAgeAdjustedRateTotal.length) {
                    defaultArray.push(hasAgeAdjustedRateTotal[0]);

                } else {
                    defaultArray.push(hasAgeAdjustedRate[0]);

                }

            } else if (hasRate.length) {
                defaultArray.push(hasRate[0]);

            } else if (hasPercent.length) {
                defaultArray.push(hasPercent[0]);

            } else {
                defaultArray.push(visArray[0]);

            }

            // assigning to global object

            defaultMapMetadata = defaultArray;

        }


        // ===== trend ===== //

        const setDefaultTrendMeasure = (visArray) => {

            // modified so that defaultTrendMetadata is explicitly set, instead of by reference
            //  through defaultArray

            let defaultArray = [];

            if (visArray.length > 0) {

                const hasAgeAdjustedRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Age Adjusted Rate')
                )
                const hasRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Rate')
                )
                const hasPercent = visArray.filter(measure =>
                    measure.MeasurementType.includes('Percent')
                )


                if (hasAgeAdjustedRate.length) {

                    const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure =>
                        measure.MeasurementType.includes('Total')
                    )
                    // Set total as default if available
                    if (hasAgeAdjustedRateTotal.length) {
                        defaultArray.push(hasAgeAdjustedRateTotal[0]);

                    } else {
                        defaultArray.push(hasAgeAdjustedRate[0]);

                    }


                } else if (hasRate.length) {
                    defaultArray.push(hasRate[0]);

                } else if (hasPercent.length) {
                    defaultArray.push(hasPercent[0]);

                } else {
                    defaultArray.push(visArray[0]);

                }
            }

            // assigning to global object

            defaultTrendMetadata = defaultArray;
        }


        // ===== links ===== //

        const setDefaultLinksMeasure = async (visArray) => {

            // modified so that defaultLinksMetadata is explicitly set, instead of by reference
            //  through defaultArray

            let defaultArray = [];

            if (visArray.length > 0) {

                const hasAgeAdjustedRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Age Adjusted Rate')
                )
                const hasRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Rate')
                )
                const hasPercent = visArray.filter(measure =>
                    measure.MeasurementType.includes('Percent')
                )


                if (hasAgeAdjustedRate.length) {

                    const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure =>
                        measure.MeasurementType.includes('Total')
                    )
                    // Set total as default if available
                    if (hasAgeAdjustedRateTotal.length) {
                        defaultArray.push(hasAgeAdjustedRateTotal[0]);

                    } else {
                        defaultArray.push(hasAgeAdjustedRate[0]);
                    }


                } else if (hasRate.length) {
                    defaultArray.push(hasRate[0]);

                } else if (hasPercent.length) {
                    defaultArray.push(hasPercent[0]);

                } else {
                    defaultArray.push(visArray[0]);

                }

                defaultLinkMeasureTimes = defaultArray[0].AvailableTime;

                const defaultPrimaryMeasureId = defaultArray[0].MeasureID;
                const defaultSecondaryMeasureId = defaultArray[0].VisOptions[0].Links[0].MeasureID;

                // assigning to global object
                defaultLinksMetadata = defaultArray;

                // using await here because filterSecondaryIndicatorMeasure calls fetch, and we need that data

                await filterSecondaryIndicatorMeasure(defaultPrimaryMeasureId, defaultSecondaryMeasureId)

            }
        }


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // finally, render the measures
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        const renderMeasures = async () => {

            // console.log("** renderMeasures");

            linksMeasures.length = 0

            const contentSummary = document.querySelector('#tab-table');
            const contentMap     = document.querySelector('#tab-map')
            const contentTrend   = document.querySelector('#tab-trend');
            const contentLinks   = document.querySelector('#tab-links');

            // ----- set dropdowns for this indicator ----- //

            const dropdownTableYear = contentSummary.querySelector('div[aria-labelledby="dropdownTableYear"]');
            const dropdownMapMeasures = document.querySelector('div[aria-labelledby="dropdownMapMeasures"]');

            const dropdownMapYear  = contentMap.querySelector('div[aria-labelledby="dropdownMapYear"]');
            const dropdownTableGeo = contentSummary.querySelector('div[aria-labelledby="dropdownTableGeo"]');
            const dropdownTrendMeasures = contentTrend.querySelector('div[aria-labelledby="dropdownTrendMeasures"]');
            const dropdownLinksMeasures = contentLinks.querySelector('div[aria-labelledby="dropdownLinksMeasures"]');

            // clear Measure Dropdowns

            dropdownTableYear.innerHTML = ``;
            dropdownTableGeo.innerHTML = ``;
            dropdownMapMeasures.innerHTML = ``;
            dropdownTrendMeasures.innerHTML = ``;
            dropdownLinksMeasures.innerHTML = ``;

            mapMeasures.length = 0;
            trendMeasures.length = 0;

            // create years dropdown for table

            const tableYears = [...new Set(fullDataTableObjects.map(item => item.Time))];

            tableYears.forEach((year, index) => {

                if (index === 0) {

                    selectedSummaryYears.push(year);
                    dropdownTableYear.innerHTML +=
                        `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" checked /> ${year}</label>`;

                } else {

                    dropdownTableYear.innerHTML +=
                        `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" /> ${year}</label>`;
                }

            });

            // create geo dropdown for table

            const tableGeoTypes = [...new Set(fullDataTableObjects.map(item => item.GeoType))];

            tableGeoTypes.forEach((geoType, index) => {

                selectedSummaryGeography.push(geoType);
                dropdownTableGeo.innerHTML += `<label class="dropdown-item checkbox-geo"><input type="checkbox" value="${geoType}" checked /> ${geoType}</label>`;

            });


            // ----- handle measures for this indicator ----- //

            const mapYears = [...new Set(fullDataMapObjects.map(item => item.Time))];

            indicatorMeasures.map((measure, index) => {

                const type = measure?.MeasurementType;
                const displayType = measure?.DisplayType;
                const years = measure?.AvailableTimes.sort((a, b) => b.start_period - a.start_period);
                const geography = measure?.AvailableGeographyTypes;
                const links = measure?.VisOptions[0].Links && measure?.VisOptions[0]?.Links[0];
                const map = measure?.VisOptions[0].Map && measure?.VisOptions[0].Map[0]?.On;
                const trend = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.On;
                const trendDisparities = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.Disparities;
                const about = measure.how_calculated;
                const sources = measure.Sources;
                const measureId = measure.MeasureID;


                // ----- handle map measures ----- //

                if (map === 1) {

                    mapMeasures.push(measure)

                    dropdownMapMeasures.innerHTML += `<div class="dropdown-column-${index}"><div class="dropdown-title"><strong> ${type}</strong></div></div>`;

                    const dropdownMapMeasuresColumn = document.querySelector(`.dropdown-column-${index}`);

                    mapYears.map((time, index) => {
                        dropdownMapMeasuresColumn.innerHTML += `<button class="dropdown-item link-measure mapbutton"
                        data-measure-id="${measureId}"
                        data-time="${time}">
                        ${time}
                        </button>`;

                    });
                }


                // ----- handle trend measures ----- //

                if (trend === 1) {

                    trendMeasures.push(measure)

                    if (fullDataTrendObjects) {
                        dropdownTrendMeasures.innerHTML += `<button class="dropdown-item link-measure trendbutton"
                        data-measure-id="${measureId}">
                        ${type}
                        </button>`;
                    }
                }


                // ----- handle links measures ----- //

                if (links) {

                    // create linked measures object

                    linksMeasures.push(measure)

                    // get secondary measure id

                    const secondaryMeasureId = measure.VisOptions[0].Links[0].MeasureID;


                    if (fullDataTableObjects) {

                        const linkYears = [...new Set(fullDataTableObjects.map(item => item.Time))];

                        dropdownLinksMeasures.innerHTML +=
                            `<div class="dropdown-title"><strong> ${type}</strong></div>`;

                        measure.VisOptions[0].Links.map(link => {

                            const linksSecondaryIndicator = indicators.filter(indicator =>
                                indicator.Measures.some(m =>
                                    m.MeasureID === link.MeasureID)
                            );

                            const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m =>
                                m.MeasureID === link.MeasureID
                            );

                            dropdownLinksMeasures.innerHTML +=
                                `<button class="dropdown-item link-measure linksbutton"
                                data-primary-measure-id="${measureId}"
                                data-measure-id="${measure.MeasureID}"
                                data-secondary-measure-id="${link.MeasureID}">
                                ${linksSecondaryMeasure[0].MeasureName}
                            </button>`;

                        });
                    }
                }
            });


            setDefaultMapMeasure(mapMeasures);
            setDefaultTrendMeasure(trendMeasures);

            // set default measure for links; also calls filterSecondaryIndicatorMeasure, which creates the joined data

            await setDefaultLinksMeasure(linksMeasures);


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // functions to show to tabs
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // ===== table ===== //

            // define function

            showTable = (e) => {

                console.log("showTable");

                // ----- handle tab selection ----- //

                // set hash to summary

                if (window.location.hash !== '#display=summary' && window.location.hash !== 'display=summary') {
                    window.location.hash = 'display=summary';
                }

                currentHash = 'display=summary'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', true);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', false);


                // ----- set measure info boxes ----- //

                renderTitleDescription(indicatorShortName, indicatorDesc);
                renderAboutSources(measureAbout, measureSources);


                // ----- render the table ----- //

                renderTable();

                updateChartPlotSize();

                $($.fn.dataTable.tables(false))
                    .DataTable()
                    .columns.adjust().draw();

            };


            // ===== map ===== //

            // define function

            showMap = (e) => {

                // ----- handle tab selection ----- //

                // set hash to map

                window.location.hash = 'display=map'
                currentHash = 'display=map'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', true);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', false);


                // ----- allow map to persist when changing tabs ----- //

                if (!selectedMapMeasure) {

                    // this is all inside the conditional, because if a user clicks on this tab again
                    //  after selecting a measure, we don't want to recompute everything. We'll use the
                    //  values created by the update function

                    // ----- get metatadata for default measure ----- //

                    // get default measure id

                    const defaultMapMeasureId = defaultMapMetadata[0].MeasureID;

                    // extract metadata for info boxes

                    const about   = defaultMapMetadata[0]?.how_calculated;
                    const sources = defaultMapMetadata[0].Sources;
                    const measure = defaultMapMetadata[0].MeasurementType;


                    // ----- set measure info boxes ----- //

                    defaultMapAbout   =
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${about}</p>`;

                    defaultMapSources =
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${sources}</p>`;

                    // render measure info boxes

                    renderTitleDescription(indicatorShortName, indicatorDesc);
                    renderAboutSources(defaultMapAbout, defaultMapSources);


                    // ----- create dataset ----- //

                    // filter map data using default measure

                    let mapMeasureData = fullDataMapObjects.filter(
                            obj => obj.MeasureID === defaultMapMeasureId
                        );

                    // get the latest end_period

                    let latest_end_period = Math.max(mapMeasureData[0].end_period);

                    let mapTimeData = mapMeasureData.filter(
                            obj => obj.end_period === latest_end_period
                        );

                    let latest_time = mapTimeData[0].Time

                    // get the highest GeoRank for this measure and end_period

                    let maxGeoRank = Math.max(mapTimeData[0].GeoRank);

                    filteredMapData = mapTimeData.filter(
                            obj => obj.GeoRank === maxGeoRank
                        );


                    // ----- render the map ----- //

                    renderMap(filteredMapData, defaultMapMetadata);

                    updateChartPlotSize();

                    // ----- persistent selection ----- //

                    // remove active class from every list element
                    $('.mapbutton').removeClass("active");
                    $('.mapbutton').attr('aria-selected', false);

                    // set this element as active & selected

                    let mapMeasureEl = document.querySelector(`.mapbutton[data-measure-id='${defaultMapMeasureId}'][data-time='${latest_time}']`)

                    $(mapMeasureEl).addClass("active");
                    $(mapMeasureEl).attr('aria-selected', true);


                } else {

                    // if there was a map already, restore it

                    // ----- set measure info boxes ----- //

                    renderAboutSources(selectedMapAbout, selectedMapSources);

                    // ----- render the map ----- //

                    renderMap(filteredMapData, defaultMapMetadata);

                    updateChartPlotSize();
                }

            };


            // ===== trend ===== //

            // define function

            showTrend = (e) => {

                // ----- handle tab selection ----- //

                // set hash to trend

                window.location.hash = 'display=trend'
                currentHash = 'display=trend'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', true);
                tabLinks.setAttribute('aria-selected', false);


                // ----- allow chart to persist when changing tabs ----- //

                if (!selectedTrendMeasure) {

                    // this is all inside the conditional, because if a user clicks on this tab again
                    //  after selecting a measure, we don't want to recompute everything. We'll use the
                    //  values created by the update function


                    // ----- get metatadata for default measure ----- //

                    const about   = defaultTrendMetadata[0]?.how_calculated;
                    const sources = defaultTrendMetadata[0].Sources;
                    const measure = defaultTrendMetadata[0].MeasurementType;


                    // ----- set measure info boxes ----- //

                    defaultTrendAbout =
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${about}</p>`;

                    defaultTrendSources =
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${sources}</p>`;

                    renderTitleDescription(indicatorShortName, indicatorDesc);
                    renderAboutSources(defaultTrendAbout, defaultTrendSources);


                    // ----- handle disparities button ----- //

                    // switch on/off the disparities button

                    const disparities =
                        defaultTrendMetadata[0].VisOptions[0].Trend &&
                        defaultTrendMetadata[0].VisOptions[0].Trend[0]?.Disparities;

                    // hide or show disparities button

                    if (disparities == 0) {

                        // if disparities is disabled, hide the button

                        btnShowDisparities.style.display = "none";

                        // remove click listeners to button that calls renderDisparities

                        $(btnShowDisparities).off()

                    } else if (disparities == 1) {

                        // remove event listener added when/if button was clicked

                        btnShowDisparities.innerText = "Show Disparities";
                        $(btnShowDisparities).off()

                        // if disparities is enabled, show the button

                        btnShowDisparities.style.display = "inline";

                        // add click listener to button that calls renderDisparities

                        $(btnShowDisparities).on("click", () => renderDisparities(defaultTrendMetadata, 221))

                    }


                    // ----- create dataset ----- //

                    const defaultTrendMeasureId = defaultTrendMetadata[0].MeasureID;
                    filteredTrendData = fullDataTrendObjects.filter(m => m.MeasureID === defaultTrendMeasureId);


                    // ----- render the chart ----- //

                    // chart only the annual average for the following measureIds:
                    // 365 - PM2.5 (Fine particles), Mean
                    // 370 - Black carbon, Mean
                    // 391 - Nitric oxide, Mean
                    // 375 - Nitrogen dioxide, Mean

                    const measureIdsAnnualAvg = [365, 370, 375, 391];

                    // chart only the summer average for the following measureIds:
                    // 386 - Ozone (O3), Mean

                    const measureIdsSummer = [386];

                    if (measureIdsAnnualAvg.includes(defaultTrendMeasureId)) {

                        const filteredTrendDataAnnualAvg = filteredTrendData.filter(d => d.Time.startsWith('Annual Average'));

                        renderTrendChart(filteredTrendDataAnnualAvg, defaultTrendMetadata);
                        updateChartPlotSize();

                    } else if (measureIdsSummer.includes(defaultTrendMeasureId)) {

                        const filteredTrendDataSummer = filteredTrendData.filter(d => d.Time.startsWith('Summer'));

                        renderTrendChart(filteredTrendDataSummer, defaultTrendMetadata);
                        updateChartPlotSize();

                    } else {

                        renderTrendChart(filteredTrendData, defaultTrendMetadata);
                        updateChartPlotSize();

                    }


                    // ----- persistent selection ----- //

                    // remove active class from every list element
                    $('.trendbutton').removeClass("active");
                    $('.trendbutton').attr('aria-selected', false);

                    // set this element as active & selected

                    let trendMeasureEl = document.querySelector(`.trendbutton[data-measure-id='${defaultTrendMeasureId}']`)

                    $(trendMeasureEl).addClass("active");
                    $(trendMeasureEl).attr('aria-selected', true);


                } else {

                    // if there was a chart already, restore it

                    // ----- set measure info boxes ----- //

                    renderAboutSources(selectedTrendAbout, selectedTrendSources);

                    // ----- render the chart ----- //

                    renderTrendChart(filteredTrendData, defaultTrendMetadata);

                    updateChartPlotSize();
                }

            };


            // ===== links ===== //

            // define function

            showLinks = (e) => {

                // ----- handle tab selection ----- //

                // set hash to links

                window.location.hash = 'display=links'
                currentHash = 'display=links'
                // console.log("currentHash [showLinks]", currentHash);

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', true);


                // ----- allow chart to persist when changing tabs ----- //

                if (!selectedLinksMeasure) {

                    // this is all inside the conditional, because if a user clicks on this tab again
                    //  after selecting a measure, we don't want to recompute everything. We'll use the
                    //  values created by the update function

                    // ----- get metatadata for default measure ----- //

                    // get first linked measure by default

                    const secondaryMeasureId = defaultLinksMetadata[0]?.VisOptions[0].Links[0].MeasureID;

                    // get linked indicator's metadata

                    const linksSecondaryIndicator = indicators.filter(indicator =>
                        indicator.Measures.some(measure =>
                            measure.MeasureID === secondaryMeasureId
                        )
                    )

                    // use linked indicator's metadata to get linked measure's metadata

                    const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m =>
                        m.MeasureID === secondaryMeasureId
                    )

                    primaryIndicatorName   = indicatorName;
                    secondaryIndicatorName = linksSecondaryIndicator[0].IndicatorName;

                    // get measure metadata

                    const primaryMeasure         = defaultLinksMetadata[0].MeasurementType;
                    const primaryAbout           = defaultLinksMetadata[0].how_calculated;
                    const primarySources         = defaultLinksMetadata[0].Sources;

                    const secondaryMeasure       = linksSecondaryMeasure[0].MeasurementType;
                    const secondaryAbout         = linksSecondaryMeasure[0].how_calculated;
                    const secondarySources       = linksSecondaryMeasure[0].Sources;


                    // ----- set measure info boxes ----- //

                    // creating indicator & measure info

                    defaultLinksAbout =
                        `<h6>${primaryIndicatorName} - ${primaryMeasure}</h6>
                        <p>${primaryAbout}</p>
                        <h6>${secondaryIndicatorName} - ${secondaryMeasure}</h6>
                        <p>${secondaryAbout}</p>`;

                    defaultLinksSources =
                        `<h6>${primaryIndicatorName} - ${primaryMeasure}</h6>
                        <p>${primarySources}</p>
                        <h6>${secondaryIndicatorName} - ${secondaryMeasure}</h6>
                        <p>${secondarySources}</p>`;


                    // ----- create dataset ----- //

                    // use joinedDataLinksObjects (created in filterSecondaryIndicatorMeasure) to get the
                    //  highest GeoRank, then keep just that geo

                    // let maxGeoRank = Math.max(joinedDataLinksObjects[0].GeoRank);
                    // filteredLinksData = joinedDataLinksObjects.filter(obj => obj.GeoRank === maxGeoRank)

                    renderTitleDescription(indicatorShortName, indicatorDesc);
                    renderAboutSources(defaultLinksAbout, defaultLinksSources);


                    // ----- render the chart ----- //

                    // joined data and metadata created in filterSecondaryIndicatorMeasure called fron setDefaultLinksMeasure

                    renderLinksChart(
                        joinedDataLinksObjects,
                        primaryMeasureMetadata,
                        secondaryMeasureMetadata,
                        primaryIndicatorName,
                        secondaryIndicatorName
                    );

                    updateChartPlotSize();


                    // ----- persistent selection ----- //

                    // remove active class from every list element
                    $('.linksbutton').removeClass("active");
                    $('.linksbutton').attr('aria-selected', false);

                    // set this element as active & selected

                    let linksMeasureEl = document.querySelector(`.linksbutton[data-secondary-measure-id='${secondaryMeasureId}']`)

                    $(linksMeasureEl).addClass("active");
                    $(linksMeasureEl).attr('aria-selected', true);


                } else {

                    // if there was a chart already, restore it

                    // ----- set measure info boxes ----- //

                    renderAboutSources(selectedLinksAbout, selectedLinksSources);

                    // ----- render the chart ----- //

                    renderLinksChart(
                        joinedDataLinksObjects,
                        primaryMeasureMetadata,
                        secondaryMeasureMetadata,
                        primaryIndicatorName,
                        secondaryIndicatorName
                    );

                    updateChartPlotSize();
                }

            };


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // disable tabs and switch to summary if there are no measures
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // this is effectively the state of the tabs when the indicator is loaded or changed

            const tabTableSelected = tabTable.getAttribute('aria-selected');
            const tabMapSelected   = tabMap.getAttribute('aria-selected');
            const tabTrendSelected = tabTrend.getAttribute('aria-selected');
            const tabLinksSelected = tabLinks.getAttribute('aria-selected');

            // console.log("tabTableSelected:", tabTableSelected, "| tabMapSelected:", tabMapSelected, "| tabTrendSelected:", tabTrendSelected, "| tabLinksSelected:", tabLinksSelected);

            const disableTab = (el) => {
                el.classList.add('disabled');
                el.setAttribute('aria-disabled', true);
            }

            const enableTab = (el) => {
                el.classList.remove('disabled');
                el.setAttribute('aria-disabled', false);
            }


            // if there's no data to display for a tab, disable it. If you're on that tab when you switch to
            //  a new indicator (which calls renderMeasures), then switch to the summary table

            if (mapMeasures.length === 0) {

                if (tabMapSelected && window.location.hash === '#display=map') {

                    console.log("xxx NO MAP!");

                    // replace history stack entry

                    url.hash = "display=summary";
                    window.history.replaceState({ id: indicatorId, hash: url.hash}, '', url);

                }

                disableTab(tabMap);

            } else {

                enableTab(tabMap);
            }


            const onlyOneTime = trendMeasures.every(m => m.AvailableTimes.length <= 1)

            if (trendMeasures.length === 0 || onlyOneTime) {

                if (tabTrendSelected && window.location.hash === '#display=trend') {

                    console.log("xxx NO TREND!");

                    // replace history stack entry

                    url.hash = "display=summary";
                    window.history.replaceState({ id: indicatorId, hash: url.hash}, '', url);

                }

                disableTab(tabTrend);

            } else {

                enableTab(tabTrend);
            }


            if (linksMeasures.length === 0) {

                if (tabLinksSelected && window.location.hash === '#display=links') {

                    console.log("xxx NO LINKS!");

                    // replace history stack entry

                    url.hash = "display=summary";
                    window.history.replaceState({ id: indicatorId, hash: url.hash}, '', url);

                }

                disableTab(tabLinks);

            } else {

                enableTab(tabLinks);
            }


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // set tab based on hash
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            let hash = window.location.hash.replace('#', "")

            switch (hash) {

                // using fallthrough

                case 'display=summary':
                case 'tab-table':
                    $('#tab-btn-table').tab('show');
                    window.dispatchEvent(hashchange);
                    break;

                case 'display=map':
                case 'tab-map':
                    {{/*  console.log("< switch > map");  */}}
                    $('#tab-btn-map').tab('show');
                    window.dispatchEvent(hashchange);
                    break;

                case 'display=trend':
                case 'tab-trend':
                    {{/*  console.log("< switch > trend");  */}}
                    $('#tab-btn-trend').tab('show');
                    window.dispatchEvent(hashchange);
                    break;

                case 'display=links':
                case 'tab-links':
                    {{/*  console.log("< switch > links");  */}}
                    $('#tab-btn-links').tab('show');
                    window.dispatchEvent(hashchange);
                    break;

                default:
                    {{/*  console.log("< switch > default");  */}}
                    window.dispatchEvent(hashchange);
                    $('#tab-btn-table').tab('show');
            }


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // add event listeners to measure dropdown elements, will call the
            //  respective update functions
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // without custom class, selector would be '[aria-labelledby="dropdownMapMeasures"] button.link-measure'

            let mapMeasuresLinks = document.querySelectorAll('.mapbutton');
            let trendMeasuresLinks = document.querySelectorAll('.trendbutton');
            let linksMeasuresLinks = document.querySelectorAll('.linksbutton');

            // adding click listeners using update functions
            // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#memory_issues

            mapMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateMapData);
            })

            trendMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateTrendData);
            })

            linksMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateLinksData);
            })


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // add event handler functions to summary tab checkboxes
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            const checkboxYear = document.querySelectorAll('.checkbox-year');
            const checkboxGeo = document.querySelectorAll('.checkbox-geo');

            checkboxYear.forEach(checkbox => {
                handleYearFilter(checkbox);
            })
            checkboxGeo.forEach(checkbox => {
                handleGeoFilter(checkbox);
            })


            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // Render default Measure About and Sources
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            measureAbout = '';
            measureSources = '';
            indicatorMeasures.map(measure => {

                measureAbout +=
                    `<h6>${measure.MeasurementType}</h6>
                    <p>${measure.how_calculated}</p>`;

                measureSources +=
                    `<h6>${measure.MeasurementType}</h6>
                    <p>${measure.Sources}</p>`;

            })

            renderAboutSources(measureAbout, measureSources);

        }


    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
    // add listeners to tabs
    // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

    // ===== table ===== /

    $('#tab-btn-table').on('click', e => {
        $(e.currentTarget).tab('show');
        window.location.hash = 'display=summary'
    })

    // ===== map ===== /

    $('#tab-btn-map').on('click', e => {
        $(e.currentTarget).tab('show');
        window.location.hash = 'display=map'
    })

    // ===== trend ===== /

    $('#tab-btn-trend').on('click', e => {
        $(e.currentTarget).tab('show');
        window.location.hash = 'display=trend'
    })

    // ===== links ===== /

    $('#tab-btn-links').on('click', e => {
        $(e.currentTarget).tab('show');
        window.location.hash = 'display=links'
    })

    </script>



</article>

{{ $js := resources.Get "js/accessible-autocomplete.min.js" }}
{{ $secureJS := $js | resources.Fingerprint "sha512" }}
<script type="text/javascript"
    src="{{ $secureJS.RelPermalink }}"
    integrity="{{ $secureJS.Data.Integrity }}"></script>

<script type="text/javascript">

    function createCitation() {
        // Create date
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        let yyyy = today.getFullYear();
        today = mm + '/' + dd + '/' + yyyy;

        // Create citation
        let citation = "New York City Department of Health, Environment & Health Data Portal. "  + `{{ .Title }}` + " data. " + indicatorName + '. Accessed at ' + `{{ .RelPermalink}}` + ' on ' + today + "."

        // Add to form
        document.getElementById('citeText').setAttribute('value',citation);

        // console.log('CITATION CREATED')

        let btn = document.getElementById('citeButton')
        btn.innerHTML = `<i class="fas fa-copy mr-1"></i>Copy citation`

    }

    function copyCitation(){
        let citeText = document.getElementById('citeText')
        citeText.select()
        citeText.setSelectionRange(0,99999);
        navigator.clipboard.writeText(citeText.value)
        let btn = document.getElementById('citeButton')
        btn.innerHTML = `<i class="fas fa-copy mr-1"></i>Copied!`
        // console.log('citation copied!')
    }

    createCitation();

    // export current table view

    $("#thisView").on("click", (e) => {

        let summaryTable = $('#tableID').DataTable();
        summaryTable.button("thisView:name").trigger();

        gtag('event', 'file_download', {
            'file_name': 'NYC EH Data Portal - ' + indicatorName + " (filtered)" + '.csv',
            'file_extension': '.csv',
            'link_text': 'Current table view'
        });

        e.stopPropagation();

    });

    // export full table data (i.e., original view)

    $("#allData").on("click", (e) => {

        // pivot the full dataset

        let allData = aq.from(fullDataTableObjects)
            .groupby("Time", "GeoType", "GeoID", "GeoRank", "Geography")
            .pivot("MeasurementDisplay", "DisplayCI")
            .relocate(["Time", "GeoType", "GeoID", "GeoRank"], { before: 0 })

        let downloadTableCSV = allData.toCSV();

        // Data URI
        let csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(downloadTableCSV);
        let hiddenElement = document.createElement('a');

        hiddenElement.href = csvData;
        hiddenElement.target = '_blank';
        hiddenElement.download = 'NYC EH Data Portal - ' + indicatorName + " (full)" + '.csv';
        hiddenElement.click();

        gtag('event', 'file_download', {
            'file_name': hiddenElement.download,
            'file_extension': '.csv',
            'link_text': 'Full table for this indicator'
        });

        e.stopPropagation();

    });

    // export raw dataset

    $("#rawData").on("click", (e) => {

        let dataURL = data_repo + "/" + data_branch + '/indicators/data/' + indicatorId + '.json'

        // console.log('Data are at: ' + dataURL)

        aq.loadJSON(`${dataURL}`).then(function(data) {

            let downloadTable = data;
            let downloadTableCSV = downloadTable.toCSV();

            // Data URI
            let csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(downloadTableCSV);
            let hiddenElement = document.createElement('a');

            hiddenElement.href = csvData;
            hiddenElement.target = '_blank';
            hiddenElement.download = 'NYC EH Data Portal - ' + indicatorName + " (raw)" + '.csv';
            hiddenElement.click();

            gtag('event', 'file_download', {
                'file_name': hiddenElement.download,
                'file_extension': '.csv',
                'link_text': 'Raw data for this indicator'
            });

            e.stopPropagation();

        })
    });


</script>

{{ end }}