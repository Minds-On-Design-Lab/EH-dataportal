{{ define "main" }}

<article class="container-fluid" id="skip-header-target">
    <div class="row">
        <div class="col-md-11 mx-auto mt-4 mx-1">
            <nav aria-label="breadcrumb" class="mb-2">
                <ul class="breadcrumb mr-auto">
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}/data-explorer/">Data Explorer</a></li>
                    <li class="breadcrumb-item active"><a href="{{ .Page.RelPermalink }}">{{ .Title }}</a></li>
                    <li class="nav-item ml-auto">
                        <button type="button" class="btn btn-sm btn-outline-primary" data-toggle="modal"
                                data-target="#topicModal">
                            Change topic
                        </button>

                        <!--
                            <form class="autocomplete-form form-inline">
                                <label for="all-data" class="block col-sm-12 font-weight-bold h4 mb-3 sr-only">Search data</label>
                                <div class="autocomplete-wrapper" width="100%">
                                    <select name="all-data" id="all-data">
                                        <option value=""><i class="fas fa-search mr-2"></i>Search data</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn-primary btn" style="height:40px;"><i class="fas fa-search"></i></button> 
                            </form>
                        -->

                    </li>
                </ul>
            </nav>

            <div class="row mb-2">
                <div class="col border-top mx-2 ml-0 pl-0 py-2">
                    <h2>{{ .Title }}</h2>
                </div>
            </div>

            <style>
                /*This CSS controls read more/show less toggle.*/
                [aria-expanded="false"]>.expanded,
                [aria-expanded="true"]>.collapsed {
                    display: none;
                }

                #truncate {
                    display: block;
                }

                #full {
                    display: none;
                }

                #expand-collapse {
                    cursor: pointer;
                }

                .show {
                    display: block !important;
                }

                .hide {
                    display: none !important;
                }

                /* .tab-content > .tab-pane {
                    display: block !important;
                    opacity: 1 !important;
                } */

                .dropdown-title {
                    padding: 0.25rem 1.5rem;
                }

                .indicator-measures h6 {
                    margin-top: 0.5em;
                }

                .dropdown-menu {
                    z-index: 2000;
                }



                div[aria-labelledby="dropdownMapMeasures"].show {
                    display: flex !important;
                }
            </style>

            <style>
                .topic-text {
                    background-color: #f9f9f9;
                    padding: 5px;
                    border-top-right-radius: 5px;
                    border-bottom-right-radius: 5px;
                    border-left: 3px solid darkgray;
                }

                .topic-text h3 {
                    font-size: 18px;
                    color: #656565;
                }

                .topic-text p li {
                    font-size: 12px;
                }
            </style>

            <div class="row">
                <div class="col-md-4">
                    <span class='home-label d-none d-md-block'>About this topic</span>

                    <div class="card fs-sm mb-2 topic-text d-none d-md-block cardshadow">
                        <!-- Content truncate-->
                        {{ .Content  }}


                    </div>
                </div>

                <div class="col-md-8">
                    <!--This button only appears on small screens to show About-->
                    <button class="btn btn-sm btn-outline-light text-primary btn-block d-block d-md-none mt-0 mb-2"
                            type="button" data-toggle="modal" data-target="#aboutModal">
                        About {{ .Title }}
                    </button>


                    <div class="dropdown float-right">
                        <span class='home-label d-block'>Change dataset</span>

                        <button class="btn btn-outline-primary float-right dropdown-toggle" type="button"
                                id="dropdownIndicator" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                style="text-align:right!important">
                            More {{ .Title }} data
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownIndicator"
                             id="indicator-dropdown">
                            <!-- Dropdown itmes are rendered using renderIndicatorDropdown -->
                        </div>
                    </div>
                    <span class="home-label d-block">Dataset</span>
                    <h3 class="indicator-title"></h3>


                    <div style="clear:both" class="my-2">
                        <span class="home-label d-block">Description</span>

                        <p class="fs-sm indicator-description"></p>
                    </div>

                    <div class="nav nav-pills bg-white device-xs" role="tablist">

                        <a class="nav-item nav-link flex-fill" id="tab-btn-table" href="#tab-table" data-toggle="pill"
                           aria-controls="tab-table" aria-selected="false" role="tab">
                            <i class="fas fa-list h4 fa-fw"></i>
                            <div class="d-none d-lg-block">Summary</div>
                        </a>

                        <a class="nav-item nav-link flex-fill" id="tab-btn-map" href="#tab-map" data-toggle="pill"
                           aria-controls="tab-map" aria-selected="false" role="tab">
                            <i class="fas fa-map-marker-alt h4 fa-fw"></i>
                            <div class="d-none d-lg-block">Map</div>
                        </a>

                        <a class="nav-item nav-link flex-fill" id="tab-btn-trend" href="#tab-trend" data-toggle="pill"
                           aria-controls="tab-trend" aria-selected="false" role="tab">
                            <i class="fas fa-chart-line h4 fa-fw"></i>
                            <div class="d-none d-lg-block">Trend</div>
                        </a>


                        <a class="nav-item nav-link flex-fill" id="tab-btn-links" href="#tab-links" data-toggle="pill"
                           aria-controls="tab-links" aria-selected="false" aria-disabled="true" role="tab">
                            <i class="fas fa-link h4 fa-fw"></i>
                            <div class="d-none d-lg-block">Links</div>
                        </a>

                    </div>

                    <div class="tab-content bg-white mb-4" id="tabs-01-content">
                        <!-- TABLE TAB -->
                        <div class="tab-pane fade show active py-2" id="tab-table" aria-labelledby="tab-btn-table"
                             role="tabpanel">
                            <div class="float right">
                                <div class="dropdown">
                                    <button class="btn btn-sm float-right btn-outline-success dropdown-toggle"
                                            type="button" id="dropdownTableYear" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false">Select year
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownTableYear">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>

                                <div class="dropdown">
                                    <button class="btn btn-sm mr-1 float-right btn-outline-success dropdown-toggle"
                                            type="button" id="dropdownTableGeo" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false">Select
                                        geography
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownTableGeo">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span id="summaryTitle" class="home-label"></span>
                                <div id="summary-table">
                                    <!-- INSERT SUMMARY TABLE HERE -->
                                </div>

                            </div>
                        </div>
                        <!-- MAP TAB -->
                        <div class="tab-pane fade py-2" id="tab-map" aria-labelledby="tab-btn-map" role="tabpanel">
                            <div class="float right">
                                <div class="dropdown">
                                    <button class="btn btn-sm mr-1 float-right btn-outline-success dropdown-toggle"
                                            type="button" id="dropdownMapMeasures" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false">Select
                                        measure
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMapMeasures">
                                        <!-- INSERT MENU ITEMS HERE -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span id="mapTitle" class="home-label"></span>
                                <div id="map" width=600 height=500
                                     style="width: 100%; min-height: 450px; margin-bottom: 50px;"></div>
                            </div>
                        </div>
                        <!-- TREND TAB -->
                        <div class="tab-pane fade py-2" id="tab-trend" aria-labelledby="tab-btn-trend" role="tabpanel">
                            <div class="dropdown float-right">
                                <button class="btn btn-sm float-right btn-outline-success dropdown-toggle" type="button"
                                        id="dropdownTrendMeasures" data-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false">Choose measure</button>
                                    <!-- disparities button - display style changed to show or hide -->
                                    <button class="btn btn-sm mr-1 float-right btn-outline-success btn-show-disparities"
                                            style="display:inline">Show Dispartites</button>
                                
                                <div class="dropdown-menu" aria-labelledby="dropdownTrendMeasures">
                                    <!-- INSERT MENU ITEMS HERE -->
                                </div>
                            </div>
                            <div class="mt-4">
                                <span id="trendTitle" class="home-label"></span>
                                <!-- INSERT TREND CHART HERE -->
                                <div id="trend" style="width: 100%; height: 550px"></div>
                            </div>
                        </div>
                        <!-- LINKS TAB -->
                        <div class="tab-pane fade py-2" id="tab-links" aria-labelledby="tab-btn-links" role="tabpanel">
                            <div class="dropdown float-right">
                                <button class="btn btn-sm float-right btn-outline-success dropdown-toggle" type="button"
                                        id="dropdownLinksMeasures" data-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false">Select data to
                                    link
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownLinksMeasures">
                                    <!-- INSERT MENU ITEMS HERE -->
                                </div>
                            </div>
                            <div class="mt-4" style="height: 550px; clear: both">
                                <span id="linksTitle" class="home-label"></span>
                                <!-- INSERT LINKS CHART HERE -->
                                <div id="links" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-2">
                    <div class="row my-2">
                        <div class="col-md-6">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light text-secondary" type="button"
                                        id="downloadDD" onclick="runDataDownload()"><i
                                       class="fa fa-download mr-1"></i>Download Data
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6 ml-auto">
                            <button class="btn float-right btn-sm btn-outline-light text-secondary"
                                    onclick="copyCitation()" id="citeButton"><i class="fas fa-copy mr-1"></i>Copy
                                citation</button>
                            <input type="text" id="citeText" value=""
                                   style="display:inline-block; width:100%; height: 40px; font-size: 14px;"
                                   class="my-2 sr-only">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6 col-xs-12">
                            <div class="btn-toggle">
                                <button class="btn btn-block btn-md btn-outline-light text-secondary"
                                        data-toggle="collapse" data-target="#toggle-target" aria-expanded="false"
                                        aria-controls="toggle-target">
                                    <span class="title"><i class="fas fa-info-circle mr-1"></i>About the Measures</span>
                                </button>
                            </div>

                            <div class="collapse p-2" id="toggle-target" role="navigation">
                                <p class="fs-sm indicator-measures">Insert from `How_Calculated.` Vivamus consequat id
                                    nibh et tempor. Cras
                                    augue enim, iaculis quis purus sit amet, interdum accumsan neque. In blandit varius
                                    blandit. Praesent
                                    vel leo ac urna dapibus faucibus. Donec sed luctus neque. Nulla porta finibus elit,
                                    luctus eleifend
                                    felis ornare vitae. Ut consequat laoreet libero eu venenatis.</p>

                            </div>
                        </div>
                        <div class="col-md-6 col-xs-12">
                            <div class="btn-toggle">
                                <button class="btn btn-block btn-md btn-outline-light text-secondary"
                                        data-toggle="collapse" data-target="#toggle-target-2" aria-expanded="false"
                                        aria-controls="toggle-target-2">
                                    <span class="title"><i class="fas fa-database mr-1"></i>Data sources</span>
                                </button>
                            </div>

                            <div class="collapse p-2" id="toggle-target-2" role="navigation">
                                <p class="fs-sm indicator-sources">Insert from `Sources.` Pellentesque blandit ante vel
                                    augue mattis, lacinia
                                    tincidunt velit feugiat. Class aptent taciti sociosqu ad litora torquent per conubia
                                    nostra, per inceptos
                                    himenaeos. Donec nulla nisl, sollicitudin et volutpat at, finibus ac quam.
                                    Pellentesque faucibus turpis
                                    egestas tellus luctus, nec porttitor diam bibendum. Sed mauris augue, tempus id urna
                                    sit amet, hendrerit
                                    blandit libero. Cras sit amet luctus nunc, nec mattis leo. </p>

                            </div>
                        </div>

                    </div>

                </div>
            </div>

        </div>
    </div>

    {{/*  </div>
    </div>

    </div>
    </div>  */}}

    <!-- Selection Modal -->
    <div class="modal fade" id="topicModal" tabindex="-1" role="dialog" aria-labelledby="topicModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topicModalLabel">Change topic</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body px-0">
                    {{ partial "de-chooser-accordion.html" . }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!--About Modal-->
    <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About {{ .Title }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {{ .Content }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Arquero -->
    <script src="https://cdn.jsdelivr.net/npm/apache-arrow@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/arquero@latest"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

    <!-- Vega-Lite -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.2"></script>

    <!--D3-->
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <!-- Data Explorer -->
    <script src="/js/data-explorer/summary.js"></script>
    <script src="/js/data-explorer/map.js"></script>
    <script src="/js/data-explorer/trend.js"></script>
    <script src="/js/data-explorer/links.js"></script>
    <script src="/js/data-explorer/disparities.js"></script>

    <script>

        {{/*  clicking on the indicator dropdown calls loadIndicator with that IndicatorID  */}}
        
        let data_branch = {{ site.Params.data_branch }};
        let data_repo = {{ site.Params.data_repo }};
        let indicators = []; // indicator data
        let defaultIndicatorId;
        let selectedSummaryYears = [];
        let selectedSummaryGeography = [];
        let aboutMeasures;
        let dataSources;
        
        let measureAbout = `N/A`;
        let measureSources = `N/A`;
        let geoTable;
        let aqData;
        let joinedAqData;
        
        let hasCIData = false;
        let hasNumberData = false;
        let hasPercentData = false;
        
        let fullDataMapObjects;
        let fullDataTrendObjects;
        let fullDataLinksObjects;
        let joinedDataLinksObjects;
        let joinedDataTrendDisparityObjects;
        var disparitiyData;
        
        let indicator;
        let indicatorName;
        let indicatorDesc;
        let indicatorShortName;
        let indicatorMeasures;
        let indicatorId;
        
        let defaultTrendMetadata = [];
        let defaultTrendAbout;
        let defaultTrendSources;
        let defaultMapMetadata = [];
        let defaultMapAbout;
        let defaultMapSources;
        let defaultLinksMetadata = [];
        let defaultLinkMeasureTimes = [];
        let defaultLinksAbout;
        let defaultLinksSources;
        
        let selectedMapMeasure = false
        let selectedTrendMeasure = false;
        let selectedLinksMeasure = false;
        let selectedMapAbout;
        let selectedMapSources;
        let selectedTrendAbout;
        let selectedTrendSources;
        let selectedLinksAbout;
        let selectedLinksSources;
        let selectedLinkMeasureData = [];
        let selectedlinksSecondaryIndicatorData = [];
        let selectedlinksSecondaryMeasureData = [];
        let selectedlinksSecondaryMeasureTime;
        
        let mapMeasures = [];
        let trendMeasures = [];
        let linksMeasures = [];
        
        let primaryMeasure;
        let secondaryMeasure;
        
        let tabTable;
        let tabMap;
        let tabTrend;
        let tabLinks;
        
        let currentHash;

        // modifying the measure dropdown innerHTML removes the event listeners from the dropdown list. So, i added it to the HTML, and we can remove it when we call renderTrendChart, if necessary

        // get trend dropdown element; disparities button will be removed or appended
        var tabTrendDropDown = document.querySelector('#tab-trend .dropdown');
        
        // get disparities button dom element, so it can be removed and appended as needed
        var btnShowDisparities = document.querySelector('.btn-show-disparities');

        console.log("btnShowDisparities", btnShowDisparities);
        
        const url = new URL(window.location);
        
        const updateChartPlotSize = () => {
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 200)
            
        }
        
        window.onpopstate = function (event) {
            if (event.state != null){
                // console.log('EVENT: ', event.state.id)
                document.url = event.state.url;
                // console.log("** loadIndicator [onpopstate]");
                loadIndicator(event.state.id, true)
            }
        };
        
        window.addEventListener("hashchange", function () {
        
            var hash = window.location.hash.replace('#', "");
            currentHash = hash;
            // console.log(">> currentHash", currentHash);
            
            switch (hash) {

                case 'display=summary':
                    // console.log(">>> summary");
                    $('#tab-btn-table').tab('show');
                    break;

                case 'display=map':
                    // console.log(">>> map");
                    $('#tab-btn-map').tab('show');
                    break;

                case 'display=trend':
                    // console.log(">>> trend");
                    $('#tab-btn-trend').tab('show');
                    break;

                case 'display=links':
                    // console.log(">>> links");
                    $('#tab-btn-links').tab('show');
                    break;

                default:
                    // console.log(">>> default");
                    window.location.hash = 'display=summary';
                    $('#tab-btn-table').tab('show');
                    break;
            }
        });

        
        document.addEventListener("DOMContentLoaded", () => {

            tabTable = document.querySelector('#tab-btn-table');
            tabMap = document.querySelector('#tab-btn-map');
            tabTrend = document.querySelector('#tab-btn-trend');
            tabLinks = document.querySelector('#tab-btn-links');

            aboutMeasures = document.querySelector('.indicator-measures');
            dataSources = document.querySelector('.indicator-sources');

        });
        
        function reveal() {
            document.getElementById('truncate').classList.toggle('hide');
            document.getElementById('full').classList.toggle('show');
            document.getElementById('contenttoggle').innerHTML = `Show less... <i class="fas fa-caret-square-up" aria-hidden="true"></i>`;
        }

        {{/* =================================================================== */}}
        {{/*  fetch and load indicators metadata into global object              */}}
        {{/* =================================================================== */}}

        fetch(data_repo + "/" + data_branch + '/indicators/indicators.json')
            .then(response => response.json())
            .then(async data => {

                // console.log("** fetch indicators.json");

                indicators = data;

                const paramId = url.searchParams.get('id') !== null ? parseInt(url.searchParams.get('id')) : false;
                
                const renderIndicatorDropdown = () => {
                    const indicatorDropdown = document.getElementById("indicator-dropdown");
                    let indicatorId;
                    let header;
                    
                    {{ range .Params.Indicators }}
                        header = `{{ .header }}`;
                        indicatorDropdown.innerHTML += header.length ? `<div class="dropdown-title"><strong>${header}</strong></div>`: '';
                        {{ range $index, $id := .IndicatorID }}
                            {{ if (eq $index 0) }}
                                defaultIndicatorId = {{ $id }}
                            {{ end }}
                            indicatorId = {{ $id }}
                            indicator = indicators.find(indicator => indicator.IndicatorID === indicatorId);
                            indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : 'N/A';
                            indicatorDropdown.innerHTML += `<button class="dropdown-item" onclick="loadIndicator(${indicatorId})" data-internal-id="${indicatorId}">${indicatorName}</button>`
                        {{ end }}
                    {{ end }}
                }
                
                renderIndicatorDropdown()

                // calling loadIndicator calls loadData, etc, and eventually renderMeasures. Because all 
                //  of this depends on the global "indicator" object, we call loadIndicator here
                
                if (paramId) {
                    await loadIndicator(paramId)
                } else {
                    await loadIndicator()
                }
                
            })
            .catch(error => console.log(error));
        
        
        // ======================================================================= //
        // data loading and manipulation functions
        // ======================================================================= //

        // I reversed the order of these function declarations to make the process
        //  of data creation easier to understand
        
        // ----------------------------------------------------------------------- //
        // function to load indicator metadata
        // ----------------------------------------------------------------------- //

        const loadIndicator = (indicatorId, bypassUrlChange) => {

            // console.log("** loadIndicator");

            // if indicatorId isn't given, use the first indicator from the dropdown list 
            //  (which is populated by Hugo reading the content frontmatter)

            const firstIndicatorId = document.querySelectorAll('#indicator-dropdown button')[0].getAttribute('data-internal-id');

            indicatorId = indicatorId ? indicatorId : firstIndicatorId;
            
            indicator = indicators.find(indicator => indicator.IndicatorID === indicatorId);
            indicatorName = indicator?.IndicatorName ? indicator.IndicatorName : 'N/A';
            indicatorDesc = indicator?.IndicatorDescription ? indicator.IndicatorDescription : `N/A`;
            indicatorShortName = indicator?.IndicatorShortname ? indicator.IndicatorShortname : indicatorName;
            indicatorMeasures = indicator?.Measures;
            
            //create Citation

            createCitation(); // re-runs on updating Indicator
            
            // send Indicator Title to vis headers

            document.getElementById('summaryTitle').innerHTML = indicatorName;
            document.getElementById('mapTitle').innerHTML     = indicatorName;
            document.getElementById('trendTitle').innerHTML   = indicatorName;
            document.getElementById('linksTitle').innerHTML   = indicatorName;
            
            
            if (!bypassUrlChange) {
                url.searchParams.set('id', indicatorId);
                window.history.pushState({ id: indicatorId }, '', url);
            }
            
            // cal data loading function

            loadData(indicatorId)

            const indicatorTitle = document.querySelector(".indicator-title")

            indicatorTitle.innerHTML = indicatorName
        }

        // ----------------------------------------------------------------------- //
        // function to Load indicator data and create Arquero data frame
        // ----------------------------------------------------------------------- //
        
        const loadData = (indicatorId) => {
            
            // console.log("** loadData");

            fetch(data_repo + "/" + data_branch + `/indicators/data/${indicatorId}.json`)
            .then(response => response.json())
            .then(async data => {

                // call the geo file loading function

                loadGeo();
                
                const assignGeoRank = (GeoType) => {
                    switch (GeoType) {
                        case 'Citywide':
                            return 0;
                        case 'Borough':
                            return 1;
                        case 'NYCKIDS':
                            return 2;
                        case 'UHF34':
                            return 3;
                        case 'UHF42':
                            return 4;
                        case 'Subboro':
                            return 5;
                        case 'CD':
                            return 6;
                        case 'NTA':
                            return 7;
                    }
                }
                
                ful = aq.from(data)
                    .derive({ "GeoRank": aq.escape( d => assignGeoRank(d.GeoType))})
                    .groupby("Time", "GeoType", "GeoID", "GeoRank")
                
                
                aqData = ful
                    .groupby("Time", "GeoType", "GeoID")
                    .orderby(aq.desc('Time'), 'GeoRank')
            })
        }

        // ----------------------------------------------------------------------- //
        // function to load geographic data
        // ----------------------------------------------------------------------- //

        const loadGeo = () => {

            const geoUrl = data_repo + "/" + data_branch + `/geography/GeoLookup_2.csv`; // col named "GeoType"

            
            aq.loadCSV(geoUrl)
                .then(data => {
                    
                    const standardizeGeoId = (id, type) => {
                        return parseInt(id)
                }
                geoTable = data
                    .derive({ GeoID: aq.escape(d => standardizeGeoId(d.GeoID, d.GeoType))}) // convert GeoIDs to numbers and strings
                    .select(aq.not('Lat', 'Long'))
                
                // console.log("---- geoTable ----")
                // geoTable.print({ limit: 20});
                // console.log("geoTable", geoTable)
                // console.log("** joinData [loadGeo]", );

                // call the data-to-geo joining function

                joinData();
                
            });
        }

        // ----------------------------------------------------------------------- //
        // function to join indicator data and geo data
        // ----------------------------------------------------------------------- //

        const joinData = () => {

            // flatten MeasureID + TimeDescription

            var measureIdTimes = {
                "MeasureID": [], 
                "TimeDescription": [], 
                "start_period": [], 
                "end_period": []
            };

            // this is a clumsy way of recycling a MeasureID to associate it with time

            indicatorMeasures.map(
                
                measure => measure.AvailableTimes.map(
                    
                    time => {
                        measureIdTimes.MeasureID.push(measure.MeasureID);
                        measureIdTimes.TimeDescription.push(time.TimeDescription);
                        measureIdTimes.start_period.push(time.start_period);
                        measureIdTimes.end_period.push(time.end_period);
                })
            )

            var aqMeasureIdTimes = aq.table(measureIdTimes);

            // foundational joined dataset

            joinedAqData = aqData
                .join_left(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                .rename({'Name': 'Geography'})
                .join(aqMeasureIdTimes, [["MeasureID", "Time"], ["MeasureID", "TimeDescription"]])
                .select(
                    "GeoID", 
                    "GeoType", 
                    "GeoRank", 
                    "Geography", 
                    "MeasureID",
                    "MeasurementType",
                    "Time", 
                    "Value", 
                    "DisplayValue", 
                    "start_period",
                    "end_period"
                )
                .orderby(aq.desc('end_period'), aq.desc('GeoRank'))
                .reify()

            // data for summary table

            fullDataTableObjects = joinedAqData
                .select(aq.not("start_period", "end_period"))
                .objects()

            // data for map
            
            fullDataMapObjects = joinedAqData
                .impute({ Value: () => NaN })
                .objects()

            // map for trend chart

            fullDataTrendObjects = joinedAqData
                .filter(d => op.match(d.GeoType, /Citywide|Borough/))
                .objects()

            // data for links & disparities chart

            fullDataLinksObjects = joinedAqData.objects()
            
            // call the measure rendering etc. function

            renderMeasures();
            
        }
        
        
        // ----------------------------------------------------------------------- //
        // function to create data and metadata for links chart
        // ----------------------------------------------------------------------- //
        
        const filterSecondaryIndicatorMeasure = async (primaryMeasureId, secondaryMeasureId) => {

            console.log("** filterSecondaryIndicatorMeasure");

            // filter trend data to keep primary measure
            
            const primaryMeasureTimesDataObjects = 
                fullDataLinksObjects.filter(d => d.MeasureID === primaryMeasureId);
            
            // get metadata for the selected primary measure, assign to global variable
            // indicatorMeasures created in loadIndicator
            
            primaryMeasureMetadata = linksMeasures.filter(
                measure => measure.MeasureID === primaryMeasureId
            )

            // if no secondary measure ID is given, set it to the first in the primary measure's links list

            if (typeof secondaryMeasureId == "undefined") {
                secondaryMeasureId = primaryMeasureMetadata[0].VisOptions[0].Links[0].MeasureID;
            }

            // get the indicator element for the selected secondary measure
            
            const secondaryIndicator = indicators.filter(
                indicator => indicator.Measures.some(
                    measure => measure.MeasureID === secondaryMeasureId
                )
            )
            
            // get secondary indicatorID, to get secondary data
            
            const secondaryIndicatorId = secondaryIndicator[0].IndicatorID
            
            // get metadata for the selected secondary measure, assign to global variable
            
            secondaryMeasureMetadata = secondaryIndicator[0].Measures.filter(
                measure => measure.MeasureID === secondaryMeasureId
            )
            
            // get most recent time period for primary measure
            
            const primaryMeasureTimes = primaryMeasureMetadata[0].AvailableTimes;
            const sortedPrimaryMeasureTimes = primaryMeasureTimes.sort((a, b) => b.end_period - a.end_period)
            const mostRecentPrimaryMeasureTime = sortedPrimaryMeasureTimes[0].TimeDescription;
            const mostRecentPrimaryMeasureStartTime = sortedPrimaryMeasureTimes[0].start_period;
            const mostRecentPrimaryMeasureEndTime = sortedPrimaryMeasureTimes[0].end_period;
            
            // convert to Arquero data frame

            const aqSortedPrimaryMeasureTimes = aq.from(sortedPrimaryMeasureTimes);
            
            // get most recent time period for secondary measure
            
            const secondaryMeasureTimes = secondaryMeasureMetadata[0].AvailableTimes;
            const sortedSecondaryMeasureTimes = secondaryMeasureTimes.sort((a, b) => b.end_period - a.end_period)
            const mostRecentSecondaryMeasureTime = sortedSecondaryMeasureTimes[0].TimeDescription;
            const mostRecentSecondaryMeasureStartTime = sortedSecondaryMeasureTimes[0].start_period;
            const mostRecentSecondaryMeasureEndTime = sortedSecondaryMeasureTimes[0].end_period;
            
            // convert to Arquero data frame

            const aqSortedSecondaryMeasureTimes = aq.from(sortedSecondaryMeasureTimes);
            
            // filter main trend data to be within most recent period
            
            const filteredPrimaryMeasureTimesDataObjects = 
                primaryMeasureTimesDataObjects
                    .filter(
                        d => d.start_period == mostRecentPrimaryMeasureStartTime && 
                            d.end_period == mostRecentPrimaryMeasureEndTime
                )
            
            
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // get secondary data
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            
            await fetch(data_repo + "/" + data_branch + `/indicators/data/${secondaryIndicatorId}.json`)
                .then(response => {
                    return response.json()
                })
                .then(data => {

                    // get secondary measure data
                    
                    const filteredSecondaryMeasureData = data.filter(d => d.MeasureID === secondaryMeasureId)
                    
                    // join with geotable and times
                    
                    const aqFilteredSecondaryMeasureTimesData = 
                        aq.from(filteredSecondaryMeasureData)
                        .join(geoTable, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                        .join(aqSortedSecondaryMeasureTimes, ["Time", "TimeDescription"])
                        .rename({'Name': 'Geography'})
                    
                    const aqFilteredSecondaryMeasureTimesDataObjects = 
                        aqFilteredSecondaryMeasureTimesData.objects();
                    
                    // get the closest secondary end time 
                    
                    const closestSecondaryTime = aqFilteredSecondaryMeasureTimesDataObjects.reduce((prev, curr) => {
                        return (Math.abs(curr.end_period - mostRecentPrimaryMeasureEndTime) < Math.abs(prev.end_period - mostRecentPrimaryMeasureEndTime) ? curr : prev);
                    });
                    
                    const closestSecondaryData = 
                        aqFilteredSecondaryMeasureTimesDataObjects.filter(
                            d => d.end_period === closestSecondaryTime.end_period
                    )
                    
                    const secondaryYears =  [...new Set(closestSecondaryData.map(item => item.Time))];
                    const highest = Math.max(...secondaryYears);
                    
                    // get lowest number

                    const lowest = Math.min(...secondaryYears);
                    
                    if (secondaryYears.length > 1) {
                        selectedlinksSecondaryMeasureTime = `${lowest}-${highest}`;
                    } else {
                        selectedlinksSecondaryMeasureTime = `${secondaryYears[0]}`
                    }
                    
                    const aqClosestSecondaryData = aq.from(closestSecondaryData)
                    
                    console.log("aqClosestSecondaryData:");
                    aqClosestSecondaryData.print()
                    console.log("filteredPrimaryMeasureTimesDataObjects", filteredPrimaryMeasureTimesDataObjects);
                    
                    const aqJoinedPrimarySecondaryData = aq.from(filteredPrimaryMeasureTimesDataObjects)
                        .join(aqClosestSecondaryData, [["GeoID", "GeoType"], ["GeoID", "GeoType"]])
                    
                    // set the value of joinedDataLinksObjects
                    
                    joinedDataLinksObjects = aqJoinedPrimarySecondaryData.objects();

                })
        }
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // handler functions for summary table
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        const handleYearFilter = (el, indicatorId) => {
            el.addEventListener('change', (e) => {
                if (e.target.checked) {
                    // console.log('checked')
                    selectedSummaryYears = [e.target.value]
                }
                renderTable()
            })
        }
        
        const handleGeoFilter = (el, indicatorId) => {
            el.addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectedSummaryGeography.push(e.target.value)
                } else {
                    selectedSummaryGeography = selectedSummaryGeography.filter(item => item !== e.target.value);
                }
                renderTable()
            })
        }
        
        const handleToggle = () => { 
            
            $('body').off('click', '#summary-table tr.group td');
            $('body').on('click', '#summary-table tr.group td', (e) => {
                const td = $(e.target);
                const tr = td.parent();
                const group = td.data('group');
                const groupLevel = td.data('group-level');
                
                const handleGroupToggle = () => {
                    
                    const subGroupToggle = $(`td[data-year="${group}"][data-group-level="1"]`);
                    const subGroupRow = $(`tr[data-year="${group}"]`);
                    
                    if (subGroupToggle.css('display') === 'none') {
                        subGroupToggle.removeClass('hidden');
                        subGroupRow.removeClass('hidden');
                        td.removeClass('hidden');
                        subGroupToggle.show();
                        subGroupRow.show();
                    } else {
                        subGroupToggle.addClass('hidden');
                        subGroupRow.addClass('hidden');
                        td.addClass('hidden');
                        subGroupToggle.hide();
                        subGroupRow.hide();
                    }
                }
                
                const handleSubGroupToggle = () => {
                    const subDataGroup = tr.next(`tr`).data(`group`);
                    const parentDataGroup = subDataGroup.split('-')[0];
                    const subGroupRow = $(`tr[data-group="${subDataGroup}"]`);
                    const parentGroupToggle = $(`td[data-group="${parentDataGroup}"]`);
                    
                    if (subGroupRow.css('display') == 'none')  {
                        subGroupRow.show();
                        td.removeClass('hidden');
                        subGroupRow.removeClass('hidden');
                        parentGroupToggle.removeClass('hidden');
                    } else {
                        subGroupRow.hide();
                        td.addClass('hidden');
                        subGroupRow.addClass('hidden');
                    }
                }
                
                if (groupLevel === 0) {
                    handleGroupToggle();
                } else {
                    handleSubGroupToggle();
                }
                
            });
        }
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // measure info functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // Renders the Indicator Title and Description

        const renderTitleDescription = (title, desc) => {

            // console.log("** renderTitleDescription");
            
            const indicatorTitle = document.querySelector('.indicator-title');
            const indicatorDescription = document.querySelector('.indicator-description');
            indicatorTitle.innerHTML = title;
            indicatorDescription.innerHTML = `${desc}`;
        }
        
        // Renders copy for the About the measures and the Data sources sections

        const renderAboutSources = (about, sources) => {

            aboutMeasures.innerHTML = about;
            dataSources.innerHTML = sources;
        }
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // tab update functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // ----- map ----- //
        
        const updateMapData = (e) => {

            // get meaasureId of selected dropdown element

            const measureId = parseInt(e.target.dataset.measureId);

            // get metatadata for selected measure

            const measureMetadata = mapMeasures.filter(m => m.MeasureID == measureId);
            const measurementType = measureMetadata[0].MeasurementType;
            const about           = measureMetadata[0].how_calculated;
            const sources         = measureMetadata[0].Sources;
            const display         = measureMetadata[0].DisplayType;

            // get selected time

            const time = e.target.dataset.time;
            
            // "indicatorName" is set in loadIndicator
            
            selectedMapAbout   = 
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${about}</p>`;

            selectedMapSources = 
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${sources}</p>`;
            
            // filter map data using selected measure and time

            let mapMeasureData = 
                fullDataMapObjects.filter(
                    obj => obj.MeasureID === measureId && 
                    obj.Time === time
                );
            
            // get the highest GeoRank, then keep just that geo
            
            let maxGeoRank = Math.max(mapMeasureData[0].GeoRank);
            let filteredMapData = mapMeasureData.filter(obj => obj.GeoRank === maxGeoRank)
            
            // render measure info boxes

            renderAboutSources(selectedMapAbout, selectedMapSources);

            // render the map

            renderMap(filteredMapData, measureMetadata, time);

            updateChartPlotSize();
            
            // allow map to persist when changing tabs

            selectedMapMeasure = true;

        }
        

        // ----- trend ----- //
        
        const updateTrendData = (e) => {
            
            // trendMeasures is created by renderMeasures, which evals before this would be called
            
            const measureId       = parseInt(e.target.dataset.measureId);
            const measureMetadata = trendMeasures.filter(m => m.MeasureID == measureId);
            const measurementType = measureMetadata[0].MeasurementType;
            
            const about   = measureMetadata[0].how_calculated;
            const sources = measureMetadata[0].Sources;
            const display = measureMetadata[0].DisplayType;

            // set measure info boxes

            selectedTrendSources = 
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${sources}</p>`;

            selectedTrendAbout = 
                `<h6>${indicatorName} - ${measurementType}</h6>
                <p>${about}</p>`;
            
            // render measure info boxes

            renderAboutSources(selectedTrendAbout, selectedTrendSources);

            // created filtered trend data, to be passed to render function

            const filteredTrendData = fullDataTrendObjects.filter(m => m.MeasureID === measureId);

            // check if disparities is enabled for this measure
            
            const disparities = 
                measureMetadata[0].VisOptions[0].Trend && 
                measureMetadata[0].VisOptions[0].Trend[0]?.Disparities;

            // hide or how disparities button

            if (disparities == 0) {
                
                // if disparities is disabled, hide the button

                btnShowDisparities.style.display = "none";

                // remove click listener to button that calls renderDisparities

                btnShowDisparities.removeEventListener("click", () => renderDisparities(measureMetadata, 221));
                
            } else if (disparities == 1) {
                
                // if disparities is enabled, show the button

                btnShowDisparities.style.display = "inline";

                // add click listener to button that calls renderDisparities

                btnShowDisparities.addEventListener("click", () => renderDisparities(measureMetadata, 221));
                
            }

            // now render the trend plot

            renderTrendChart(filteredTrendData, measureMetadata);

            updateChartPlotSize();                    

            // allow trend chart to persist when changing tabs

            selectedTrendMeasure = true;

        }
        

        // ----- links ----- //
        
        const updateLinksData = async (e) => {
            
            const primaryMeasureId = parseInt(e.target.dataset.primaryMeasureId);
            const secondaryMeasureId = parseInt(e.target.dataset.secondaryMeasureId);
            
            // filter links data using selected measure

            let linksMeasureData = 
                joinedDataLinksObjects.filter(
                    obj => obj.MeasureID_1 === primaryMeasureId
                );
            
            // get the highest GeoRank, then keep just that geo
            
            let maxGeoRank = Math.max(linksMeasureData[0].GeoRank);
            let filteredLinksData = linksMeasureData.filter(obj => obj.GeoRank === maxGeoRank)

            // for all indicators, get the ones that are linked to the current indicator
            
            const linksSecondaryIndicator = indicators.filter(
                indicator => indicator.Measures.some(
                    m => m.MeasureID === secondaryMeasureId
                )
            )

            // call filterSecondaryIndicatorMeasure, which creates joinedDataLinksObjects,
            //  primaryMeasureMetadata, secondaryMeasureMetadata
            
            await filterSecondaryIndicatorMeasure(primaryMeasureId, secondaryMeasureId)
            
            // get indicator names, for chart + about & sources

            const primaryIndicatorName   = indicatorName // created in loadIndicator
            const secondaryIndicatorName = linksSecondaryIndicator[0].IndicatorName

            // extract metadata for about & sources boxes

            const primaryMeasurementType = primaryMeasureMetadata[0].MeasurementType;
            const secondaryMeasurementType = secondaryMeasureMetadata[0].MeasurementType;
            
            const primaryAbout = primaryMeasureMetadata[0].how_calculated;
            const secondaryAbout = secondaryMeasureMetadata[0].how_calculated;

            const primarySources = primaryMeasureMetadata[0].Sources;
            const secondarySources = secondaryMeasureMetadata[0].Sources;

            // concat metadata into about & sources boxes

            const combinedAbout = 
                `<h6>${primaryIndicatorName} - ${primaryMeasurementType}</h6>
                <p>${primaryAbout}</p>
                <h6>${secondaryIndicatorName} - ${secondaryMeasurementType}</h6>
                <p>${secondaryAbout}</p>`;

            const combinedSources = 
                `<h6>${primaryIndicatorName} - ${primaryMeasurementType}</h6>
                <p>${primarySources}</p>
                <h6>${secondaryIndicatorName} - ${secondaryMeasurementType}</h6>
                <p>${secondarySources}</p>`;
            
            // set measure info as global objects

            selectedLinksAbout   = combinedAbout;
            selectedLinksSources = combinedSources;
            
            // render the chart

            renderLinksChart(
                filteredLinksData,
                primaryMeasureMetadata,
                secondaryMeasureMetadata,
                primaryIndicatorName,
                secondaryIndicatorName
            );

            updateChartPlotSize();                    
            
            // render the measure info boxes

            renderAboutSources(combinedAbout, combinedSources);

            // allow links chart to persist when changing tabs

            selectedLinksMeasure = true;

        }

        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // tab default measure functions
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        // ----- map ----- //
        
        const setDefaultMapMeasure = (visArray) => {

            // modified so that defaultMapMetadata is explicitly set, instead of by reference 
            //  through defaultArray

            let defaultArray = [];
            
            const hasAgeAdjustedRate = visArray.filter(measure =>
                measure.MeasurementType.includes('Age Adjusted Rate')
            )
            const hasRate = visArray.filter(measure =>
                measure.MeasurementType.includes('Rate')
            )
            const hasPercent = visArray.filter(measure =>
                measure.MeasurementType.includes('Percent')
            )

            // console.log("hasPercent [setDefaultMapMeasure]", hasPercent);
            
            if (hasAgeAdjustedRate.length) {

                const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure => 
                    measure.MeasurementType.includes('Total')
                )
                
                // Set total as default if available
                if (hasAgeAdjustedRateTotal.length) {
                    defaultArray.push(hasAgeAdjustedRateTotal[0]);

                } else {
                    defaultArray.push(hasAgeAdjustedRate[0]);

                }
                
            } else if (hasRate.length) {
                defaultArray.push(hasRate[0]);

            } else if (hasPercent.length) {
                defaultArray.push(hasPercent[0]);

            } else {
                defaultArray.push(visArray[0]);

            }
            
            // assigning to global object

            defaultMapMetadata = defaultArray;

        }
        

        // ----- trend ----- //
        
        const setDefaultTrendMeasure = (visArray) => {
            
            // modified so that defaultTrendMetadata is explicitly set, instead of by reference 
            //  through defaultArray
            
            let defaultArray = [];
            
            if (visArray.length > 0) {

                const hasAgeAdjustedRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Age Adjusted Rate')
                )
                const hasRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Rate')
                )
                const hasPercent = visArray.filter(measure =>
                    measure.MeasurementType.includes('Percent')
                )
                

                if (hasAgeAdjustedRate.length) {

                    const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure => 
                        measure.MeasurementType.includes('Total')
                    )
                    // Set total as default if available
                    if (hasAgeAdjustedRateTotal.length) {
                        defaultArray.push(hasAgeAdjustedRateTotal[0]);

                    } else {
                        defaultArray.push(hasAgeAdjustedRate[0]);

                    }
                    

                } else if (hasRate.length) {
                    defaultArray.push(hasRate[0]);

                } else if (hasPercent.length) {
                    defaultArray.push(hasPercent[0]);

                } else {
                    defaultArray.push(visArray[0]);

                }
            }
            
            // assigning to global object

            defaultTrendMetadata = defaultArray;
        }
        

        // ----- links ----- //
        
        const setDefaultLinksMeasure = async (visArray) => {

            // modified so that defaultLinksMetadata is explicitly set, instead of by reference 
            //  through defaultArray
            
            let defaultArray = [];
            
            if (visArray.length > 0) {

                const hasAgeAdjustedRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Age Adjusted Rate')
                )
                const hasRate = visArray.filter(measure =>
                    measure.MeasurementType.includes('Rate')
                )
                const hasPercent = visArray.filter(measure =>
                    measure.MeasurementType.includes('Percent')
                )


                if (hasAgeAdjustedRate.length) {

                    const hasAgeAdjustedRateTotal = hasAgeAdjustedRate.filter(measure =>
                        measure.MeasurementType.includes('Total')
                    )
                    // Set total as default if available
                    if (hasAgeAdjustedRateTotal.length) {
                        defaultArray.push(hasAgeAdjustedRateTotal[0]);

                    } else {
                        defaultArray.push(hasAgeAdjustedRate[0]);
                    }


                } else if (hasRate.length) {
                    defaultArray.push(hasRate[0]);

                } else if (hasPercent.length) {
                    defaultArray.push(hasPercent[0]);

                } else {
                    defaultArray.push(visArray[0]);

                }

                defaultLinkMeasureTimes = defaultArray[0].AvailableTime;
                
                const defaultPrimaryMeasureId = defaultArray[0].MeasureID;
                const defaultSecondaryMeasureId = defaultArray[0].VisOptions[0].Links[0].MeasureID;

                // console.log("defaultSecondaryMeasureId [setDefaultLinksMeasure]", defaultSecondaryMeasureId);
                
                // assigning to global object
                defaultLinksMetadata = defaultArray;

                // using await here because filterSecondaryIndicatorMeasure calls fetch, and we need that data
                
                await filterSecondaryIndicatorMeasure(defaultPrimaryMeasureId, defaultSecondaryMeasureId)
                
            }
        }
        
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
        // finally, render the measures
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

        const renderMeasures = async () => {

            console.log("** renderMeasures");
            
            linksMeasures.length = 0
            
            const contentSummary = document.querySelector('#tab-table');
            const contentMap = document.querySelector('#tab-map')
            const contentTrend = document.querySelector('#tab-trend');
            const contentLinks = document.querySelector('#tab-links');

            const dropdownTableYear = contentSummary.querySelector('div[aria-labelledby="dropdownTableYear"]');
            const dropdownMapMeasures = document.querySelector('div[aria-labelledby="dropdownMapMeasures"]');                        
            
            const dropdownMapYear = contentMap.querySelector('div[aria-labelledby="dropdownMapYear"]');
            const dropdownTableGeo = contentSummary.querySelector('div[aria-labelledby="dropdownTableGeo"]');
            const dropdownTrendMeasures = contentTrend.querySelector('div[aria-labelledby="dropdownTrendMeasures"]');
            const dropdownLinksMeasures = contentLinks.querySelector('div[aria-labelledby="dropdownLinksMeasures"]');

            const tableGeoTypes = [...new Set(joinedAqData.objects().map(item => item.GeoType))];
            const tableYears = [...new Set(joinedAqData.objects().map(item => item.Time))];
            const mapYears = [...new Set(fullDataMapObjects.map(item => item.Time))];
            
            // clear Measure Dropdowns
            dropdownTableYear.innerHTML = ``;
            dropdownTableGeo.innerHTML = ``;
            dropdownMapMeasures.innerHTML = ``;
            dropdownTrendMeasures.innerHTML = ``;
            dropdownLinksMeasures.innerHTML = ``;

            // add disparities button
            
            mapMeasures.length = 0;
            trendMeasures.length = 0;
            
            tableYears.forEach((year, index) => {
                
                if (index === 0) {
                    selectedSummaryYears.push(year);
                    dropdownTableYear.innerHTML += `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" checked /> ${year}</label>`;
                } else {
                    dropdownTableYear.innerHTML += `<label class="dropdown-item checkbox-year"><input type="radio" name="year" value="${year}" /> ${year}</label>`;
                }
                
            });
            
            tableGeoTypes.forEach((geoType, index) => {
                
                selectedSummaryGeography.push(geoType);
                dropdownTableGeo.innerHTML += `<label class="dropdown-item checkbox-geo"><input type="checkbox" value="${geoType}" checked /> ${geoType}</label>`;
                
            });
            
            // console.log('measures: ', indicator, indicatorMeasures)
            
            indicatorMeasures.map((measure, index) => {
                
                const type = measure?.MeasurementType;
                const displayType = measure?.DisplayType;
                const years = measure?.AvailableTimes.sort((a, b) => b.start_period - a.start_period);
                const geography = measure?.AvailableGeographyTypes;
                const links = measure?.VisOptions[0].Links && measure?.VisOptions[0]?.Links[0];
                const map = measure?.VisOptions[0].Map && measure?.VisOptions[0].Map[0]?.On;
                const trend = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.On;
                const trendDisparities = measure?.VisOptions[0].Trend && measure?.VisOptions[0].Trend[0]?.Disparities;
                const about = measure.how_calculated;
                const sources = measure.Sources;
                const measureId = measure.MeasureID;

                // console.log("map [renderMeasures]", map);
                
                if (map === 1) {
                    
                    mapMeasures.push(measure)

                    // console.log("mapMeasures [renderMeasures]", mapMeasures);
                    
                    dropdownMapMeasures.innerHTML += `<div class="dropdown-column-${index}"><div class="dropdown-title"><strong> ${type}</strong></div></div>`;
                    const dropdownMapMeasuresColumn = document.querySelector(`.dropdown-column-${index}`);
                    // console.log('dropdownMapMeasures: ', dropdownMapMeasures)
                    
                    mapYears.map((time, index) => {
                        dropdownMapMeasuresColumn.innerHTML += `<button class="dropdown-item link-measure mapbutton"
                        data-measure-id="${measureId}"
                        data-time="${time}">
                        ${time}
                        </button>`;
                    });
                }
            
                if (trend === 1) {

                    trendMeasures.push(measure)

                    if (fullDataTrendObjects) {
                        dropdownTrendMeasures.innerHTML += `<button class="dropdown-item link-measure trendbutton"
                        data-measure-id="${measureId}"> 
                        ${type}
                        </button>`;
                    }
                }
                
                
                // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
                // if links is enabled for this indicator, add linked measures to dropdown
                // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
                
                if (links) {
                    
                    linksMeasures.push(measure)
                    
                    const secondaryMeasureId = measure.VisOptions[0].Links[0].MeasureID;
                    
                    if (joinedAqData) {
                        
                        const linkYears = [...new Set(joinedAqData.objects().map(item => item.Time))];

                        dropdownLinksMeasures.innerHTML += `<div class="dropdown-title"><strong> ${type}</strong></div>`;
                        
                        measure.VisOptions[0].Links.map(link => {

                            const linksSecondaryIndicator = indicators.filter(indicator =>
                                indicator.Measures.some(m => 
                                    m.MeasureID === link.MeasureID)
                            );
                            
                            const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m => 
                                m.MeasureID === link.MeasureID
                            );
                            
                            dropdownLinksMeasures.innerHTML += `<button class="dropdown-item link-measure linksbutton" 
                                data-primary-measure-id="${measureId}"
                                data-measure-id="${measure.MeasureID}"
                                data-secondary-measure-id="${link.MeasureID}">
                                ${linksSecondaryIndicator[0].IndicatorLabel} - ${linksSecondaryMeasure[0].MeasurementType}
                            </button>`;
                            
                        });
                    }
                }
            });

            
            // console.log("** setDefaultMapMeasure [single.html]");
            setDefaultMapMeasure(mapMeasures);
            
            // console.log("** setDefaultMeasure [renderMeasures]");
            setDefaultTrendMeasure(trendMeasures);
            
            // set default measure for links; also calls filterSecondaryIndicatorMeasure, which creates the joined data
            
            await setDefaultLinksMeasure(linksMeasures);

            
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // add listeners to tabs
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // ---- table ---- //
            
            $('#tab-btn-table').on('shown.bs.tab', function(e) {

                console.log("#tab-btn-table");
                
                // set hash to summary

                window.location.hash = 'display=summary';

                // reset aria attributes

                tabTable.setAttribute('aria-selected', true);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', false);

                // render the table

                renderTable();

                $($.fn.dataTable.tables(true))
                    .DataTable()
                    .columns.adjust();

                renderTitleDescription(indicatorShortName, indicatorDesc);
                renderAboutSources(measureAbout, measureSources);

                updateChartPlotSize();

            });
            

            // ---- map ---- //
            
            $('#tab-btn-map').on('shown.bs.tab', function(e){

                console.log("#tab-btn-map");

                // set hash to map
                
                window.location.hash = 'display=map'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', true);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', false);

                $($.fn.dataTable.tables(true))
                    .DataTable()
                    .columns.adjust();
                
                // allow map to persist when changing tabs

                if (!selectedMapMeasure) {

                    // get default measure id
                
                    const defaultMeasureId = defaultMapMetadata[0].MeasureID;

                    // filter map data using default measure

                    let mapMeasureData = fullDataMapObjects.filter(
                            obj => obj.MeasureID === defaultMeasureId
                        );
                    
                    console.log("mapMeasureData", mapMeasureData);

                    // get the latest end_period

                    let latest_end_period = Math.max(mapMeasureData[0].end_period);
                    console.log("latest_end_period", latest_end_period);

                    let mapTimeData = fullDataMapObjects.filter(
                            obj => obj.end_period === latest_end_period
                        );

                    // get the highest GeoRank for this measure and end_period
                    
                    let maxGeoRank = Math.max(mapTimeData[0].GeoRank);

                    let filteredMapData = mapTimeData.filter(
                            obj => obj.GeoRank === maxGeoRank
                        );

                    // extract metadata for info boxes

                    const about = defaultMapMetadata[0]?.how_calculated;
                    const sources = defaultMapMetadata[0].Sources;
                    const measure = defaultMapMetadata[0].MeasurementType;

                    defaultMapAbout   = 
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${about}</p>`;

                    defaultMapSources = 
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${sources}</p>`;

                    // render measure info boxes

                    renderAboutSources(defaultMapAbout, defaultMapSources);
                    
                    // render the map
                    
                    renderMap(filteredMapData, defaultMapMetadata);

                    updateChartPlotSize();

                } else {

                    // if there was a map already, restore the map info box

                    renderAboutSources(selectedMapAbout, selectedMapSources);
                }

            });
            
            
            // ---- trend ---- //
            
            $('#tab-btn-trend').on('shown.bs.tab', function(e){

                console.log("#tab-btn-trend");

                // set hash to trend
                
                window.location.hash = 'display=trend'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', true);
                tabLinks.setAttribute('aria-selected', false);

                // what's this doing?

                $($.fn.dataTable.tables(true))
                    .DataTable()
                    .columns.adjust();
                
                renderAboutSources(measureAbout, measureSources);

                // allow trend chart to persist when changing tabs

                if (!selectedTrendMeasure) {

                    // set info box metadata

                    const about = defaultTrendMetadata[0]?.how_calculated;
                    const sources = defaultTrendMetadata[0].Sources;
                    const measure = defaultTrendMetadata[0].MeasurementType;

                    defaultTrendAbout = 
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${about}</p>`;

                    defaultTrendSources = 
                        `<h6>${indicatorName} - ${measure}</h6>
                        <p>${sources}</p>`;

                    renderAboutSources(defaultTrendAbout, defaultTrendSources);

                    // now render the trend chart
                    
                    const measureId = defaultTrendMetadata[0].MeasureID;
                    const filteredTrendData = fullDataTrendObjects.filter(m => m.MeasureID === measureId);
                
                    // render the chart

                    renderTrendChart(filteredTrendData, defaultTrendMetadata);

                    updateChartPlotSize();

                } else {

                    // if there was a trend chart already, restore the trend chart info box

                    renderAboutSources(selectedTrendAbout, selectedTrendSources);
                }
                
                const disparities = 
                    defaultTrendMetadata[0].VisOptions[0].Trend && 
                    defaultTrendMetadata[0].VisOptions[0].Trend[0]?.Disparities;


                // hide or show disparities button

                if (disparities == 0) {
                    
                    // if disparities is disabled, hide the button

                    btnShowDisparities.style.display = "none";

                    // remove click listener to button that calls renderDisparities

                    btnShowDisparities.removeEventListener("click", () => renderDisparities(defaultTrendMetadata, 221));
                    
                } else if (disparities == 1) {
                    
                    // if disparities is enabled, show the button

                    btnShowDisparities.style.display = "inline";

                    // add click listener to button that calls renderDisparities

                    btnShowDisparities.addEventListener("click", () => renderDisparities(defaultTrendMetadata, 221));
                    
                }

            });
            
            
            // ---- links ---- //
            
            $('#tab-btn-links').on('shown.bs.tab', function(e) {
                
                console.log("#tab-btn-links");
                
                // set hash to links
                
                window.location.hash = 'display=links'

                // reset aria attributes

                tabTable.setAttribute('aria-selected', false);
                tabMap.setAttribute('aria-selected', false);
                tabTrend.setAttribute('aria-selected', false);
                tabLinks.setAttribute('aria-selected', true);
                
                // what's this doing?

                $($.fn.dataTable.tables(true))
                    .DataTable()
                    .columns.adjust();

                // get default measure id
            
                const defaultMeasureId = defaultLinksMetadata[0].MeasureID;

                // filter links data using default measure

                let linksMeasureData = 
                    joinedDataLinksObjects.filter(
                        obj => obj.MeasureID_1 === defaultMeasureId
                    );
                
                // get the highest GeoRank, then keep just that geo
                
                let maxGeoRank = Math.max(linksMeasureData[0].GeoRank);
                let filteredLinksData = linksMeasureData.filter(obj => obj.GeoRank === maxGeoRank)

                // get first linked measure by default
                
                const secondaryMeasureId = defaultLinksMetadata[0]?.VisOptions[0].Links[0].MeasureID;
                
                // get linked indicator's metadata

                const linksSecondaryIndicator = indicators.filter(indicator =>
                    indicator.Measures.some(measure => 
                        measure.MeasureID === secondaryMeasureId
                    )
                )
                
                // use linked indicator's metadata to get linked measure's metadata

                const linksSecondaryMeasure = linksSecondaryIndicator[0].Measures.filter(m =>
                    m.MeasureID === secondaryMeasureId
                )

                // extracting metadata
                
                const primaryIndicatorName = indicatorName;
                const primaryMeasure = defaultLinksMetadata[0].MeasurementType;
                const primaryAbout = defaultLinksMetadata[0].how_calculated;
                const primarySources = defaultLinksMetadata[0].Sources;
                const secondaryIndicatorName = linksSecondaryIndicator[0].IndicatorName;
                const secondaryMeasure = linksSecondaryMeasure[0].MeasurementType;
                const secondaryAbout = linksSecondaryMeasure[0].how_calculated;
                const secondarySources = linksSecondaryMeasure[0].Sources;

                // creating indicator & measure info
                
                defaultLinksAbout = 
                    `<h6>${primaryIndicatorName} - ${primaryMeasure}</h6>
                    <p>${primaryAbout}</p>
                    <h6>${secondaryIndicatorName} - ${secondaryMeasure}</h6>
                    <p>${secondaryAbout}</p>`;

                defaultLinksSources = 
                    `<h6>${primaryIndicatorName} - ${primaryMeasure}</h6>
                    <p>${primarySources}</p>
                    <h6>${secondaryIndicatorName} - ${secondaryMeasure}</h6>
                    <p>${secondarySources}</p>`;
                

                // allow links chart to persist when changing tabs

                if (!selectedLinksMeasure) {

                    renderAboutSources(defaultLinksAbout, defaultLinksSources);

                    // joined data and metadata created in filterSecondaryIndicatorMeasure called fron setDefaultLinksMeasure

                    renderLinksChart(
                        filteredLinksData,
                        primaryMeasureMetadata,
                        secondaryMeasureMetadata,
                        primaryIndicatorName,
                        secondaryIndicatorName
                    );

                    updateChartPlotSize();

                } else {

                    // if there was a links chart already, restore the trend chart info box

                    renderAboutSources(selectedLinksAbout, selectedLinksSources);
                }
                
            });


            var hash = window.location.hash.replace('#', "")
            currentHash = hash;
            // console.log('hash:', hash)
            
            switch (hash) {
                case 'display=summary':
                    $('#tab-btn-table').tab('show');
                    console.log("switch summary");
                    // renderTable();
                    break;
                case 'display=map':
                    $('#tab-btn-map').tab('show');
                    console.log("switch map");
                    break;
                case 'display=trend':
                    $('#tab-btn-trend').tab('show');
                    console.log("switch trend");
                    break;
                case 'display=links':
                    $('#tab-btn-links').tab('show');
                    console.log("switch links");
                    break;
                default:
                    $('#tab-btn-table').tab('show');
                    window.location.hash = 'display=summary';
                    console.log("switch default summary");
                    // renderTable();
            }                    
            

            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // disable tabs and switch to summary if there are no measures
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // this is effectively the state of the tabs when the indicator is loaded or changed
            
            const tabTableSelected = tabTable.getAttribute('aria-selected');
            const tabMapSelected   = tabMap.getAttribute('aria-selected');
            const tabTrendSelected = tabTrend.getAttribute('aria-selected');
            const tabLinksSelected = tabLinks.getAttribute('aria-selected');

            console.log("tabTableSelected:", tabTableSelected, "| tabMapSelected:", tabMapSelected, "| tabTrendSelected:", tabTrendSelected, "| tabLinksSelected:", tabLinksSelected);
            
            const disableTab = (el) => {
                el.classList.add('disabled');
                el.setAttribute('aria-disabled', true);
            }
            
            const enableTab = (el) => {
                el.classList.remove('disabled');
                el.setAttribute('aria-disabled', false);
            }
            

            // if there's no data to display for a tab, disable it. If you're on that tab when you switch to 
            //  a new indicator (which calls renderMeasures), then switch to the summary table

            if (mapMeasures.length === 0) {
                
                console.log("disable map");
                console.log("map hash", window.location.hash);
                console.log("> map switch", tabMapSelected && window.location.hash === '#display=map');

                if (tabMapSelected && window.location.hash === '#display=map') {
                    
                    console.log("switch to table");
                    
                    $('#tab-btn-table').tab('show');
                    
                }

                disableTab(tabMap);
                
            } else {
                
                enableTab(tabMap);
            }

            if (trendMeasures.length === 0) {
                
                console.log("disable trend");
                console.log("trend hash", window.location.hash);
                console.log("> trend switch", tabTrendSelected && window.location.hash === '#display=trend');

                if (tabTrendSelected && window.location.hash === '#display=trend') {
                    
                    console.log("switch to table");
                    
                    $('#tab-btn-table').tab('show');
                    
                }
                
                disableTab(tabTrend);
                
            } else {
                
                enableTab(tabTrend);
                // renderTrendChart();
            }

            if (linksMeasures.length === 0) {
                
                console.log("disable links");
                console.log("links hash", window.location.hash);
                console.log("> links switch", tabLinksSelected && window.location.hash === '#display=links');

                if (tabLinksSelected && window.location.hash === '#display=links') {
                    
                    console.log("switch to table");

                    $('#tab-btn-table').tab('show');
                    
                }

                disableTab(tabLinks);

            } else {
                
                enableTab(tabLinks);
            }
            

            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // add event listeners to measure dropdown elements, will call the 
            //  respective update functions
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //

            // without custom class, selector would be '[aria-labelledby="dropdownMapMeasures"] button.link-measure'

            let mapMeasuresLinks = document.querySelectorAll('.mapbutton');
            let trendMeasuresLinks = document.querySelectorAll('.trendbutton');
            let linksMeasuresLinks = document.querySelectorAll('.linksbutton');

            // adding click listeners using update functions
            // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#memory_issues
            
            mapMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateMapData);
            })

            trendMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateTrendData);
            })

            linksMeasuresLinks.forEach(link => {
                link.addEventListener('click', updateLinksData);
            })
            
            
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // add event handler functions to summary tab checkboxes
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            
            const checkboxYear = document.querySelectorAll('.checkbox-year');
            const checkboxGeo = document.querySelectorAll('.checkbox-geo');
            
            checkboxYear.forEach(checkbox => {
                handleYearFilter(checkbox, indicatorId);
            })
            checkboxGeo.forEach(checkbox => {
                handleGeoFilter(checkbox, indicatorId);
            })
            
            
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            // Render default Measure About and Sources
            // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //
            
            measureAbout = '';
            measureSources = '';
            indicatorMeasures.map(measure => {

                measureAbout += 
                    `<h6>${measure.MeasurementType}</h6>
                    <p>${measure.how_calculated}</p>`;

                measureSources += 
                    `<h6>${measure.MeasurementType}</h6>
                    <p>${measure.Sources}</p>`;

            })
            
            renderAboutSources(measureAbout, measureSources);

        }


    </script>



</article>

{{ $js := resources.Get "js/accessible-autocomplete.min.js" }}
{{ $secureJS := $js }}
<script type="text/javascript" src="{{ $secureJS.Permalink }}" integrity="{{ $secureJS.Data.Integrity }}"></script>

<script type="text/javascript"> 
    
    function createCitation() {
        // Create date
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();
        today = mm + '/' + dd + '/' + yyyy;
        
        // Create citation
        var citation = "New York City Department of Health, Environment & Health Data Portal. "  + `{{ .Title }}` + " data. " + indicatorName + '. Accessed at ' + `{{ .Permalink}}` + ' on ' + today + "."
        
        // Add to form
        document.getElementById('citeText').setAttribute('value',citation);
        
        // console.log('CITATION CREATED')
        
        var btn = document.getElementById('citeButton')
        btn.innerHTML = `<i class="fas fa-copy mr-1"></i>Copy citation`
        
    }
    
    function copyCitation(){
        var citeText = document.getElementById('citeText')
        citeText.select()
        citeText.setSelectionRange(0,99999);
        navigator.clipboard.writeText(citeText.value)
        var btn = document.getElementById('citeButton')
        btn.innerHTML = `<i class="fas fa-copy mr-1"></i>Copied!`
        // console.log('citation copied!')
    }
    
    createCitation();
    
    var downloadTable;
    var dataURL; 
    var downloadTableCSV
    var csvData
    
    // download data function
    function runDataDownload() {
        // console.log('Downloading data for indicator ' + indicatorId)
        dataURL = data_branch + "/" + data_repo + '/indicators/data/' + indicatorId + '.json'
        // console.log('Data are at: ' + dataURL)
        aq.loadJSON(`${dataURL}`).then(function(data) {
            downloadTable = data;
            downloadTableCSV = downloadTable.toCSV()
            // Data URI
            csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(downloadTableCSV);
            var hiddenElement = document.createElement('a');  
            hiddenElement.href = csvData;
            hiddenElement.target = '_blank';  
            hiddenElement.download = 'NYC EH Data Portal: ' + indicatorName + '.csv'
            hiddenElement.click();
        })
    }
    
</script>

{{ end }}