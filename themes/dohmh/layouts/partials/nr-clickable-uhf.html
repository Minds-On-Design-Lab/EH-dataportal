<div id="vis1" class="chartdest" style="width: 100%; height: 100%;"></div>
<!-- vis1 container needs to be put in a sized container - will take on the size of its parent -->

<style>

      .marks:hover {
        cursor: pointer
      }
</style>

<!-- spec -->
<script type="text/javascript">
    var spec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container",
        "height": "container",
        "autosize": {"type": "fit", "contains": "padding"},
        "config": {
          "view": {"stroke": "transparent"}
        },
        "layer": [
          {
            "data": {
              "url": "https://raw.githubusercontent.com/nychealth/EHDP-data/production/geography/UHF42.topo.json",
              "format": {"type": "topojson", "feature": "collection"}
            },
            "mark": {"type": "geoshape", "stroke": "#ffffff", "fill": "lightgray"}
          },
          {
            "data": {
              "url": "https://raw.githubusercontent.com/nychealth/EHDP-data/production/geography/UHF42.topo.json",
              "format": {"type": "topojson", "feature": "collection"}
            },
            "transform": [
              {
                "lookup": "properties.GEOCODE",
                "from": {
                  "data": {
                    "url": `${baseURL}` + '/UHF42.csv'
                    },
                  "key": "GEOCODE",
                  "fields": ["GEOCODE", "Name", "GEONAME", "VALUE"]
                },
                "default": "no data"
              }
            ],
            "mark": {"type": "geoshape", "stroke": "#ffffff"},
            "params": [
              {
                "name": "highlight",
                "select": {
                  "type": "point",
                  "on": "mouseover",
                  "clear": "mouseout"
                }
              }
            ],
            "encoding": {
              "color": {
                "bin": false,
                "field": "VALUE",
                "type": "quantitative",
                "legend": null,
                "scale": {"scheme": {"name": "blues", "extent": [0.25, 0.75]}}
              },
              "stroke": {
                "condition": [
                  {"param": "highlight", "empty": false, "value": "cyan"},
                  {
                    "test": "datum['GEOCODE'] == ''",
                    "value": "cyan"
                    },
                ],
                "value": "#dadada"
              },
              "strokeWidth": {"condition": [
                {
                  "param": "highlight", "empty": false, "value": 2.5
                },
                {
                  "test": "datum['GEOCODE'] == ''",
                  "value": 3
                  }
                
              ], "value": 0.5},
              "tooltip": [
                {"field": "Name", "type": "nominal", "title": "Neighborhood"}        ]
            }
          }
        ]
      }

      /*
        RE-DO EMBED FUNCTIONS:
        - Add function that identifies whether this is on a NEIGHBORHOOD page; if it is, get the GEOCODE, pass it in to the initial draw function.
        - Pass in a 0/1 about whether or not we want this clickable when it's drawn. (call this after the partial?)

      */



      // draw map
      function drawMap() {
        console.log('map drawn.')
        vegaEmbed('#vis1', spec, {"actions": false}).then(result => {
          result.view.addEventListener('click', function(event, item) {
             console.log('CLICK', event, item);
            // console.log(item.datum)

             loadPage(item.datum.GEONAME) // clicks to new page.

          });
          }).catch(console.warn);
      }

      // runs the click -> new page
      function loadPage(x) {
        window.location = '{{ site.BaseURL }}neighborhood-reports/'+ DOMPurify.sanitize(x) + reportURL
      }

      // draw on page load
      drawMap()

      // are we on a NR output page? Runs from neighborhood report output pages, passing in Geocode
      function highlightNeighborhood(x) {
        console.log('highlight neighborhood running')
        console.log(x)

        // then run d3.csv to ingest UHF42, filter by neighborhood name path, and get GeoCode - then re-draw map, add event listener.
        d3.csv(baseURL + '/UHF42.csv').then(data => {
          neighborhoods = data;
          // console.table(neighborhoods)
      
          var thisNeighb = neighborhoods.filter(y => y.GEONAME == x) // get neighborhood data
          // console.table(thisNeighb)
          var geocode = thisNeighb[0].GEOCODE // get GEOCODE
      
          // change Spec prior to drawing chart - with highlights applied
          changeSpec(geocode)

        })
      }

      // changes Spec, re-draws map.
      function changeSpec(x) {
        spec.layer[1].encoding.stroke.condition.test = `datum['GEOCODE'] == '${x}'`
        spec.layer[1].encoding.strokeWidth.condition.test = `datum['GEOCODE'] == '${x}'`
        console.log('spec changed - neighborhood highlight, ' + x)
        // run drawMap
        drawMap()
      }


</script>