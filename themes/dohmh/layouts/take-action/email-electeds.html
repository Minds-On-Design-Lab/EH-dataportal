{{- define "main" -}}
<!--D3-->
<script src="https://d3js.org/d3.v5.min.js"></script>

<article class="container-fluid overflow-hidden" id="primary-content">

  <div class="row my-4">
    <div class="col-md-11 col-sm-12 mx-auto">
      <!--start main column-->

      <nav aria-label="breadcrumb" class="mb-2">
        <ul class="breadcrumb mr-auto">
            <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}">Home</a></li>
            <li class="breadcrumb-item"><a href="..">
              {{- with .Parent -}} {{ .Title }} </a></li>{{- end -}}
            <li class="breadcrumb-item active">{{ .Title }}</li>
        </ul>                
    </nav>
    
      <div class="row border-bottom py-2">
        <div class="col-12">
          <h1>{{- .Title -}}</h1>
          {{- .Content -}}
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-md-6 col-sm-12 mx-auto">
          <p>First, enter your address to get your elected officials and their contact information. <em>We won't store your address information.</em></p>

          <!-- Search/input -->
          <div class="srch input-group" role="search" autocomplete="off">
            <input class="rad-all form-control form-control-lg" placeholder="Search Address" id="map-search">
          </div>

          <!-- Map gets drawn here -->
          <div id='mapLocator' style="height:350px;"></div>
        </div>
      </div>

      <div class="row my-2">
        <div class="col-md-10 col-sm-12 mx-auto">
          <div id="outputOne"></div>

          <table id="tableTwo" class="table table-striped hide">
            <thead class="thead-light">
              <tr>
                <th>Office</th>
                <th>Name</th>
                <th>Website</th>
                <th>Office phone number</th>
                <th>Email address</th>
              </tr>
            </thead>
            <tbody id="tableTwoBody">

            </tbody>
          </table>


        </div>
      </div>






      <div id="contactContainer" class="hide">
        <div class="row my-4">
          <div class="col-md-6 mx-auto">
            <p>Go ahead and write your elected officials an email!</p>
          </div>
        </div>

        <div class="row my-4">
          <div class="col-md-6">
            <h3>Email tips</h3>
            <p>In the box to the right, you can write an email to your elected officials. Here are some tips for writing a good email:</p>
            <p><strong>Identify yourself as a constituent:</strong> tell them where you live and that they are your elected representative. For example: <em>I live on Flatbush Avenue in Brooklyn, in your district."</em></p>
            <p><strong>State your concerns.</strong></p>
            
            <p><strong>Cite data.</strong> For example: <em>"According to data on housing conditions, over 50% of households in our neighborhood are rent burdened. (NYC Environment and Health Data Portal: https://a816-dohbesp.nyc.gov/IndicatorPublic/beta/data-explorer/housing-stability/?id=2336#display=summary)" </em></p>

            <p><strong>Make a request.</strong> You can ask them where they stand on the issue, what they're doing to improve it, or what services are available to help their constituents.</p>

          </div>
          <div class="col-md-6">
            <h3>Your email:</h3>
            <form>
              <textarea id="textEntry" name="textEntry" style="width:100%;height:300px">I am one of your constituents, a resident of [MY NEIGHBORHOOD]. I was reading about neighborhood issues on one of the Health Department's websites, the Environment and Health Data Portal (on.nyc.gov/dataportal). I am concerned about [ISSUES YOU ARE CONCERNED ABOUT]. These concern me because [WHY YOU ARE CONCERNED].I'm writing to know [WHAT YOU WANT YOUR COUNCIL MEMBER TO DO].Thank you for your attention, and I look forward to your reply.
  
                Sincerely,
                [YOUR NAME]
              </textarea>
              <br>
              <a href="" id="sendButton" target="_blank" class="btn btn-primary btn-block">
                Send email!
              </a>
              <em class="fs-sm">This will open the email in your email client for you to send from your address.</em>
            </form>   
          </div>
        </div>
      </div>








    </div>
    <!--end main column-->
  </div>

</article>

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.4.0/papaparse.min.js"></script>
<script src="https://maps.nyc.gov/nyc-lib/v1.2.79/js/babel-polyfill.js"></script>
<script src="https://maps.nyc.gov/nyc-lib/v1.2.79/js/nyc-ol-lib.js"></script>

<script>
// This initializes and draws the locator map
  var map = new nyc.ol.FrameworkMap({
  mapTarget: '#mapLocator',
  searchTarget: '#map-search',
  // startAt: '125 Worth Street',
  geoclientUrl: 'https://maps.nyc.gov/geoclient/v1/search.json?app_key=74DF5DB1D7320A9A2&app_id=nyc-lib-example'
  // Developer portal app_key and id don't work, though the nycLib example works
  //geoclientUrl: 'https://maps.nyc.gov/geoclient/v1/search.json?app_key=cfed478bf47829a2951bc5a3bbc26422&app_id=2d2a1b38'
  });

// Loads our City Council list
var councilTable = [];
var district;
d3.csv(sitepath+'/take-action/council.csv').then(function(data) {
  councilTable = data;
  // console.log('All City Council members:')
  // console.table(councilTable)

})


// gets your initial info:
var yourDistrict; 
var districtInfo;
var lastname;
var setLoc;
var emails = [];
var rowCM;

// Add event listener on entry form
document.getElementById('map-search').addEventListener("change", getData)

function getData() {
  document.getElementById('tableTwo').classList.remove('hide')

  console.log('The map has changed')
  document.getElementById('outputOne').innerHTML = "Getting info..."


  setTimeout(() => {
    document.getElementById('outputOne').innerHTML = ""
    // document.getElementById('contactContainer').classList.remove('hide')

    setLoc = map.location.name
    // console.log(map.location.data);
    yourDistrict = map.location.data.cityCouncilDistrict
    // get info from councilTable
    for (let i = 0; i < councilTable.length; i ++) {
      if (Number(councilTable[i].District) === Number(yourDistrict)) {
        districtInfo = councilTable[i]
        console.log('Your City Council district:')
        console.table(districtInfo)
        emails.push(districtInfo.Email)
      } else {}
    }
  
    // send Council Member info to page
    rowCM = document.createElement('tr'); // create row
    let cell_1 = document.createElement('td') 
        cell_1.innerHTML = 'Council Member: District ' + districtInfo.District
        rowCM.appendChild(cell_1)
    let cell_2 = document.createElement('td')
        cell_2.innerHTML = districtInfo.CouncilMember
        rowCM.appendChild(cell_2)
    let cell_3 = document.createElement('td')
        cell_3.innerHTML = 'n/a'
        rowCM.appendChild(cell_3)
    let cell_4 = document.createElement('td')
        cell_4.innerHTML = 'n/a'
        rowCM.appendChild(cell_4)
    let cell_5 = document.createElement('td')
        cell_5.innerHTML = districtInfo.Email
        rowCM.appendChild(cell_5)
    document.getElementById('tableTwoBody').appendChild(rowCM)
    



    // next, send map.location.name to Google Api
    getFromAPI(setLoc)

  }, 1500);
}

var apiData = {};
var rootRequest = 'https://content-civicinfo.googleapis.com/civicinfo/v2/representatives?key=AIzaSyBEi5U-9-QQevrhUxhmGDEg4CvvbtpLehU&address='
var boroPres = {};
var publicAdvocate = {};
var stateReps = {}
var congressReps = {}



function getFromAPI(address) {
  // console.log(address)

  // get all data
  fetch(rootRequest+address)
    .then(res => res.json())
    .then(data => {
      apiData = data
    })

  // get BP
  fetch(rootRequest+address+'&levels=administrativeArea2&roles=headofGovernment')
    .then (res => res.json())
    .then(data => {
      boroPres = data
      // console.log('boroPres: ')
      // console.log(boroPres)
      emails.push(boroPres.officials[0].emails[0])
      printInfoFromApi(boroPres.offices[0], boroPres.officials[0])
    })

  // get PA
  fetch(rootRequest+address+'&levels=locality&roles=governmentOfficer')
  .then (res => res.json())
  .then(data => {
    publicAdvocate = data
    emails.push(publicAdvocate.officials[1].emails[0])
    printInfoFromApi(publicAdvocate.offices[1], publicAdvocate.officials[1])

  })

  // get state assemblymember and state senator.
  fetch(rootRequest+address+'&levels=administrativeArea1&roles=legislatorUpperBody&roles=legislatorLowerBody')
  .then (res => res.json())
  .then(data => {
    stateReps = data;
    emails.push(stateReps.officials[0].emails[0])
    emails.push(stateReps.officials[1].emails[0])
    printInfoFromApi(stateReps.offices[0], stateReps.officials[0])
    printInfoFromApi(stateReps.offices[1], stateReps.officials[1])


  })


  // get congresspeople
  fetch(rootRequest+address+'&levels=country&roles=legislatorUpperBody&roles=legislatorLowerBody')
  .then (res => res.json())
  .then(data => {
    congressReps = data;
    console.log(congressReps)
    printInfoFromApi(congressReps.offices[0], congressReps.officials[0])
    printInfoFromApi(congressReps.offices[1], congressReps.officials[1])
    printInfoFromApi(congressReps.offices[1], congressReps.officials[2])
  })

  // Available emails:
  console.log('Available emails:')
  console.log(emails)

  // reveal Email Content
  document.getElementById('contactContainer').classList.remove('hide')

}

function storeData(x){
  apiData = x;
  console.log('apiData: ')
  console.log(apiData)
}

// prints info from API calls to the table
function printInfoFromApi(office, info) {
  let newRow = document.createElement('tr')
  let cell_office = document.createElement('td')
    cell_office.innerHTML = office.name // we'll pass in dataArray.offices[x]
    newRow.appendChild(cell_office)
  let cell_name = document.createElement('td')
    cell_name.innerHTML = info.name // we'll pass in dataArray.officials[x]
    newRow.appendChild(cell_name)
  let cell_website = document.createElement('td')
    cell_website.innerHTML = info.urls[0]
    newRow.appendChild(cell_website)
  let cell_phone = document.createElement('td')
    cell_phone.innerHTML = info.phones[0]
    newRow.appendChild(cell_phone)
  let cell_email = document.createElement('td')
    if (info.emails) {
      cell_email.innerHTML = info.emails[0]
    } else {
      cell_email.innerHTML = 'No email address found'
    }
    newRow.appendChild(cell_email)
    document.getElementById('tableTwoBody').appendChild(newRow)
}




</script>


{{- end -}}
