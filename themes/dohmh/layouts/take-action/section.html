{{- define "main" -}}


<article class="container-fluid overflow-hidden" id="primary-content">

  <div class="row my-4">
    <div class="col-md-11 col-sm-12 mx-auto">
      <!--start main column-->

      <nav aria-label="breadcrumb" class="mb-2">
        <ul class="breadcrumb mr-auto">
            <li class="breadcrumb-item"><a href="{{ .Site.BaseURL }}">Home</a></li>
            <li class="breadcrumb-item active"><a href="{{ .Page.RelPermalink }}">{{ .Title }}</a></li>
        </ul>                
    </nav>

      <h1>{{- .Title -}}</h1>
        {{- .Content -}}

        <div class="row">
          <div class="col-12">
            <h4>1. Enter your address</h4>   
          </div>

          <div class="col-lg-6 col-sm-12">

              <!-- Search/input -->
              <div class="srch input-group" role="search">
                  <input class="rad-all form-control form-control-lg" placeholder="Search Address" id="map-search" onclick="getData()">
              </div>

              <!-- Map gets drawn here -->
              <div id='mapLocator'></div>
              
          </div>

          <div class="col-lg-5 col-sm-12">
              <button class="btn btn-outline-primary btn-lg" id="outputButton" onclick="dataChange()">2. Get info:</button>  
              <p>
                <ul style="list-style-type:none; padding-left: 0;">
                  <li><span class="home-label">Your City Council District:</span> <span id="CCD" class="font-weight-bold ml-3"></span></li>
                  <li><span class="home-label">Your City Council Member:</span> <span id="CCM" class="font-weight-bold ml-3"></span></li>
                </ul>
              </p>
              <button type="button" id="sendEmailBtn" class="btn btn-sm btn-block btn-outline-primary" onclick="email1()">3.Send my Council Member an email</button>

          </div>
      </div>

      <script>
        function email1() {
          document.getElementById('email').style.display = "block"
        }
      </script>

      <div class="row mt-4" id="email" style="display:none">
        <div class="col">
          <h4>OK, let's send your Council Member an email.</h4>
          <p>This page will help you write an email to your council member. </p>
          <p class="home-label">First, what issues are you concerned about?</p>
          <div id="concernContainer">
            <button type="button" class="btn btn-outline-secondary mb-1">Air quality</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Climate</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Housing</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Environmental justice</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Asthma</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Active design</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Children's health</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Pests and pesticides</button>
            <button type="button" class="btn btn-outline-secondary mb-1">Food and drink issues</button>
          </div>





          <p class="mt-3 home-label">Secondly, why are you concerned?</p>
          <div id="reasonsContainer">
            <button type="button" class="btn btn-outline-secondary mb-1">It's worse in my neighborhood</button>
            <button type="button" class="btn btn-outline-secondary mb-1">It affects my life</button>
            <button type="button" class="btn btn-outline-secondary mb-1">The whole City should improve</button>
          </div>


          <p class="mt-3 home-label">Last, what do you want?</p>
          <div id="needsContainer">
            <button type="button" class="btn btn-outline-secondary mb-1">Services or resources available to me</button>
            <button type="button" class="btn btn-outline-secondary mb-1">To know what they're doing to fix it</button>
          </div>

          <hr class="my-2">
          <button type="button" class="btn btn-outline-primary mb-1 float-right" onclick="illWrite()">It's OK, I'll write it myself.</button>
          <button type="button" class="btn btn-primary mb-1 mr-1 float-right" onclick="writeEmail()">Write my email!</button>

        </div>
      </div>





      <div class="row mt-6" id="emailText" style="display:none">

        <div class="col-12" style="display:none;">
          <div id="textDestination">
            <p>Dear <span id="councilMemberLastName">Lastname</span>,</p>
            <p>I am one of your constituents, a resident of district <span id="districtNum">XX</span>. I was reading about neighborhood issues on one of the Health Department's websites, the Environment and Health Data Portal (on.nyc.gov/dataportal). I am concerned about:
            <div id="concerns"></div>

            <p>According to the data:
              <div id="reasons"></div>
              
            <p>I'm writing to know:
            <div id="needs"></div>

            <p>I look forward to your reply. Thank you.</p>

          </div>
        </div>


        <div class="col-12">

          <span class="home-label" id="emailLabel">Your email is below. You can edit the text in the box before you send it.</span>
          <form>
            <textarea id="textEntry" name="textEntry" style="width:100%;height:300px">
              Dear [Council Member],
              I am one of your constituents, a resident of [MY NEIGHBORHOOD]. I was reading about neighborhood issues on one of the Health Department's websites, the Environment and Health Data Portal (on.nyc.gov/dataportal). I am concerned about [ISSUES YOU ARE CONCERNED ABOUT].

              These concern me because [WHY YOU ARE CONCERNED].

              I'm writing to know [WHAT YOU WANT YOUR COUNCIL MEMBER TO DO].

              Thank you for your attention, and I look forward to your reply.

              Sincerely,
              [YOUR NAME]
            </textarea>
            <br>
            <a href="" id="sendButton" target="_blank" class="btn btn-primary float-right">
              Send email!
            </a>
          </form>
        </div>
      </div>






    </div>
    <!--end main column-->
  </div>

</article>

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.4.0/papaparse.min.js"></script>
<script src="https://maps.nyc.gov/nyc-lib/v1.2.79/js/babel-polyfill.js"></script>
<script src="https://maps.nyc.gov/nyc-lib/v1.2.79/js/nyc-ol-lib.js"></script>

<script>
  // This initializes and draws the locator map
  var map = new nyc.ol.FrameworkMap({
  mapTarget: '#mapLocator',
  searchTarget: '#map-search',
  startAt: '125 Worth Street',
  geoclientUrl: 'https://maps.nyc.gov/geoclient/v1/search.json?app_key=74DF5DB1D7320A9A2&app_id=nyc-lib-example'
  // Developer portal app_key and id don't work, though the nycLib example works
  //geoclientUrl: 'https://maps.nyc.gov/geoclient/v1/search.json?app_key=cfed478bf47829a2951bc5a3bbc26422&app_id=2d2a1b38'
  });

  function getData() {
    console.log('getting data...')
    setTimeout(500,dataChange)
  }


// runs on button click 
function dataChange() {
  document.getElementById('CCD').innerHTML = map.location.data.cityCouncilDistrict;
  console.log('Map geolocator produces the following data from map.location.data')
  // console.table(map.location.data)
  document.getElementById('sendEmailBtn').style.display = "block"
}

// Create CONCERNS
var concerns = [];
var concernsText = [];

// get concern buttons
var concernContainer = document.getElementById('concernContainer') 
var concernBtns = concernContainer.getElementsByClassName("btn");

// toggle active state on click
for (var i = 0; i < concernBtns.length; i++) {
  concernBtns[i].addEventListener("click", function() {
    this.classList.toggle('active');
    concernsText = []; // empty concerns array

    concerns = document.querySelectorAll("#concernContainer .active") // get active buttons

    for (var x = 0; x < concerns.length; x ++) {
      concernsText.push(concerns[x].innerHTML) // for active buttons, send their innerHTML to concernsText array
    }

  });
}


// Next, create REASONS.
var reasons = [];
var reasonsText = [];

var reasonsContainer = document.getElementById('reasonsContainer')
var reasonBtns = reasonsContainer.getElementsByClassName("btn");
for (var i = 0 ; i < reasonBtns.length; i++) {
  reasonBtns[i].addEventListener("click", function() {
    this.classList.toggle('active');
    reasonsText = [];
    reasons = document.querySelectorAll("#reasonsContainer .active")
    for (var x = 0; x < reasons.length; x++) {
      reasonsText.push(reasons[x].innerHTML)
    }
  });
}

// Lastly, create NEEDS. 
var needs;
var needsText;

var needsContainer = document.getElementById('needsContainer')
var needsBtns = needsContainer.getElementsByClassName('btn');
for (var i = 0 ; i < needsBtns.length; i++) {
  needsBtns[i].addEventListener("click", function() {
    this.classList.toggle('active');
    needsText = [];
    needs = document.querySelectorAll("#needsContainer .active")
    for (var x = 0 ; x < needs.length; x++) {
      needsText.push(needs[x].innerHTML)
    }
  })
}

// and create other info
var councilMemberLastName;
var neighborhoodName;


// now, create EMAIL
function writeEmail() {
   document.getElementById('emailText').style.display = "block" // reveal text
   document.getElementById('districtNum').innerHTML = map.location.data.cityCouncilDistrict 

   // send Concerns to text
    var str = '<ul>'
    concernsText.forEach(function(concern) {
      str += '<li>'+ concern + '</li>';
    }); 

    str += '</ul></p>';
    document.getElementById("concerns").innerHTML = str;

    // send Reasons to text
    var str2 = '<ul>'
      reasonsText.forEach(function(reason) {
        str2 += '<li>'+ reason + '</li>';
      }); 
  
      str2 += '</ul></p>';
      document.getElementById("reasons").innerHTML = str2;

    // send Needs to text
    var str3 = '<ul>'
      needsText.forEach(function(need) {
        str3 += '<li>'+ need + '</li>';
      }); 
  
      str3 += '</ul></p>';
      document.getElementById("needs").innerHTML = str3;

    // send text to form
    document.getElementById('textEntry').textContent = document.getElementById('textDestination').textContent

      sendButton()

}

function illWrite() {
  document.getElementById('emailText').style.display = "block" // reveal text
  document.getElementById('emailLabel').innerHTML = `Write your email below. We've written up a template - delete the parts in [BRACKETS] and add whatever you'd like.`

  sendButton()
}

function sendButton() {
  var address = 'District' + map.location.data.cityCouncilDistrict + "@council.nyc.gov"
  var subject = 'Health concerns in district ' + map.location.data.cityCouncilDistrict
  var body = document.getElementById('textEntry').textContent

  document.getElementById('sendButton').href = `mailto:`+ address + `?subject=` + `${subject}` + `&body=` + `${body}`
}

function sendEmail() {


}


</script>


{{- end -}}
